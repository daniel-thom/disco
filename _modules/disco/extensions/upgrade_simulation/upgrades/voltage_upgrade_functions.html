<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions &mdash; DISCO 0.1 documentation</title>
      <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../../" id="documentation_options" src="../../../../../_static/documentation_options.js"></script>
        <script src="../../../../../_static/jquery.js"></script>
        <script src="../../../../../_static/underscore.js"></script>
        <script src="../../../../../_static/doctools.js"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
    <link href="../../../../../_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../../../index.html" class="icon icon-home"> DISCO
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../../installation.html#use-conda">Use Conda</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../installation.html#use-docker">Use Docker</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../overview.html">Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../../overview.html#data-sources">Data Sources</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../overview.html#transform-model">Transform Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../overview.html#config-jobs">Config Jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../overview.html#submit-jobs">Submit Jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../overview.html#result-analysis">Result Analysis</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../quick-start.html">Quick Start</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../../quick-start.html#source-data">Source Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../quick-start.html#transform-model">Transform Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../quick-start.html#config-jobs">Config Jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../quick-start.html#submit-jobs">Submit Jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../quick-start.html#result-analysis">Result Analysis</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../data-sources.html">Data Sources</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../../data-sources/smart-ds-model-preparation.html">SMART-DS OpenDSS Model Preparation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../data-sources.html#gem-model">GEM Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../data-sources.html#epri-model">EPRI Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../data-sources.html#sourcetree1-model">SourceTree1 Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../data-sources.html#sourcetree2-model">SourceTree2 Model</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pv-deployments.html">PV Deployments</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../../pv-deployments.html#sourcetree1-pv-deployments">SourceTree1 PV Deployments</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../transform-models.html">Transform Models</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../../transform-models.html#transform-model-help">Transform Model Help</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../transform-models.html#disco-model-in-depth">DISCO Model in Depth</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../analysis-workflows.html">Analysis Workflows</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../../analysis-workflows/hosting-capacity-analysis.html">Hosting Capacity Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../analysis-workflows/upgrade-cost-analysis.html">Upgrade Cost Analysis</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pipelines.html">Pipelines</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../../pipelines.html#sourcetree1model">SourceTree1Model</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../debugging-issues.html">Debugging Issues</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../../debugging-issues.html#using-jade">Using JADE</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../debugging-issues.html#using-pydss">Using PyDSS</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../data-ingestion.html">Data Ingestion</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../../data-ingestion.html#ingest-to-new-database">Ingest to New Database</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../data-ingestion.html#ingest-to-existing-database">Ingest to Existing Database</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../data-ingestion.html#run-database-queries">Run Database Queries</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../advanced-guide.html">Advanced Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../../advanced-guide/analysis-deployment.html">Analysis Deployment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../advanced-guide/upgrade-cost-analysis-generic-models.html">Upgrade Cost Analysis JSON Schemas</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contribution</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../build-docs.html">Build docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../license.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">DISCO</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../../../index.html">Module code</a> &raquo;</li>
      <li>disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">AgglomerativeClustering</span>

<span class="kn">from</span> <span class="nn">.common_functions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.thermal_upgrade_functions</span> <span class="kn">import</span> <span class="n">define_xfmr_object</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="edit_capacitor_settings_for_convergence"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.edit_capacitor_settings_for_convergence">[docs]</a><span class="k">def</span> <span class="nf">edit_capacitor_settings_for_convergence</span><span class="p">(</span><span class="n">voltage_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">control_command</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function edits the dss command string with new capacitor settings, in case of convergence issues</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    voltage_config</span>
<span class="sd">    control_command</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">capacitor_settings</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">capacitor_settings</span><span class="p">[</span><span class="s2">&quot;new_capON&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span>
        <span class="p">(</span><span class="n">voltage_config</span><span class="p">[</span><span class="s2">&quot;nominal_voltage&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">voltage_config</span><span class="p">[</span><span class="s2">&quot;cap_sweep_voltage_gap&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">capacitor_settings</span><span class="p">[</span><span class="s2">&quot;new_capOFF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span>
        <span class="p">(</span><span class="n">voltage_config</span><span class="p">[</span><span class="s2">&quot;nominal_voltage&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">voltage_config</span><span class="p">[</span><span class="s2">&quot;cap_sweep_voltage_gap&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">capacitor_settings</span><span class="p">[</span><span class="s2">&quot;new_deadtime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">capacitor_settings</span><span class="p">[</span><span class="s2">&quot;new_delay&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Changed Initial On and Off Cap settings to avoid convergence issues &quot;</span><span class="p">)</span>

    <span class="n">new_control_command</span> <span class="o">=</span> <span class="n">control_command</span>
    <span class="n">control_command</span> <span class="o">=</span> <span class="n">control_command</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;New&#39;</span><span class="p">,</span> <span class="s1">&#39;Edit&#39;</span><span class="p">)</span>
    <span class="n">control_command</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;enabled=True&quot;</span><span class="p">,</span> <span class="s2">&quot;enabled=False&quot;</span><span class="p">,</span> <span class="n">control_command</span><span class="p">)</span>
    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">control_command</span><span class="p">)</span>  <span class="c1"># disable and run previous control command</span>

    <span class="n">new_control_command</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;DeadTime=\d+&quot;</span><span class="p">,</span> <span class="s1">&#39;DeadTime=&#39;</span> <span class="o">+</span>
                                 <span class="nb">str</span><span class="p">(</span><span class="n">capacitor_settings</span><span class="p">[</span><span class="s2">&quot;new_deadtime&quot;</span><span class="p">]),</span> <span class="n">new_control_command</span><span class="p">)</span>
    <span class="n">new_control_command</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;Delay=\d+&quot;</span><span class="p">,</span> <span class="s1">&#39;Delay=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">capacitor_settings</span><span class="p">[</span><span class="s2">&quot;new_delay&quot;</span><span class="p">]),</span> <span class="n">new_control_command</span><span class="p">)</span>
    <span class="n">new_control_command</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;ONsetting=\d+\.\d+&quot;</span><span class="p">,</span> <span class="s1">&#39;ONsetting=&#39;</span> <span class="o">+</span>
                                 <span class="nb">str</span><span class="p">(</span><span class="n">capacitor_settings</span><span class="p">[</span><span class="s2">&quot;new_capON&quot;</span><span class="p">]),</span> <span class="n">new_control_command</span><span class="p">)</span>
    <span class="n">new_control_command</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;OFFsetting=\d+\.\d+&quot;</span><span class="p">,</span> <span class="s1">&#39;OFFsetting=&#39;</span> <span class="o">+</span>
                                 <span class="nb">str</span><span class="p">(</span><span class="n">capacitor_settings</span><span class="p">[</span><span class="s2">&quot;new_capOFF&quot;</span><span class="p">]),</span> <span class="n">new_control_command</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_control_command</span></div>


<div class="viewcode-block" id="correct_capacitor_parameters"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.correct_capacitor_parameters">[docs]</a><span class="k">def</span> <span class="nf">correct_capacitor_parameters</span><span class="p">(</span><span class="n">default_capacitor_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">orig_capacitors_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nominal_voltage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Corrects cap control parameters: change to voltage controlled, correct PT ratio. Add cap control if not present</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    default_capacitor_settings</span>
<span class="sd">    orig_capacitors_df</span>
<span class="sd">    nominal_voltage</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># correct capacitor settings</span>
    <span class="n">default_capcontrol_command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Type=</span><span class="si">{</span><span class="n">default_capacitor_settings</span><span class="p">[</span><span class="s1">&#39;cap_control&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span> \
                                 <span class="sa">f</span><span class="s2">&quot;ONsetting=</span><span class="si">{</span><span class="n">default_capacitor_settings</span><span class="p">[</span><span class="s1">&#39;capON&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span> \
                                 <span class="sa">f</span><span class="s2">&quot;OFFsetting=</span><span class="si">{</span><span class="n">default_capacitor_settings</span><span class="p">[</span><span class="s1">&#39;capOFF&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span> \
                                 <span class="sa">f</span><span class="s2">&quot;PTphase=</span><span class="si">{</span><span class="n">default_capacitor_settings</span><span class="p">[</span><span class="s1">&#39;PTphase&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span> \
                                 <span class="sa">f</span><span class="s2">&quot;Delay=</span><span class="si">{</span><span class="n">default_capacitor_settings</span><span class="p">[</span><span class="s1">&#39;capONdelay&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span> \
                                 <span class="sa">f</span><span class="s2">&quot;DelayOFF=</span><span class="si">{</span><span class="n">default_capacitor_settings</span><span class="p">[</span><span class="s1">&#39;capOFFdelay&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span> \
                                 <span class="sa">f</span><span class="s2">&quot;DeadTime=</span><span class="si">{</span><span class="n">default_capacitor_settings</span><span class="p">[</span><span class="s1">&#39;capdeadtime&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> enabled=True&quot;</span>
    <span class="c1"># Correct settings of those cap banks for which cap control object is available</span>
    <span class="n">capacitors_commands_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">capcontrol_present_df</span> <span class="o">=</span> <span class="n">orig_capacitors_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">orig_capacitors_df</span><span class="p">[</span><span class="s1">&#39;capcontrol_present&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;capcontrol&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">capcontrol_present_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="c1"># if it is already voltage controlled, modify PT ratio if new is different after re-computation</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;capcontrol_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;voltage&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;ptratio&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">round</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;old_ptratio&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)):</span>
            <span class="n">orig_string</span> <span class="o">=</span> <span class="s1">&#39; !original, corrected PTratio only&#39;</span>
            <span class="n">command_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Edit CapControl.</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;capcontrol_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> PTRatio=</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;PTratio&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">orig_string</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
            <span class="c1"># this does not change original settings, so should not cause convergence</span>
            <span class="n">circuit_solve_and_check</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># if capcontrol is present, change to voltage controlled and apply default settings.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">command_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Edit CapControl.</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;capcontrol_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> PTRatio=</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;PTratio&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span> \
                             <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">default_capcontrol_command</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
            <span class="n">pass_flag</span> <span class="o">=</span> <span class="n">circuit_solve_and_check</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pass_flag</span><span class="p">:</span>
                <span class="n">command_string</span> <span class="o">=</span> <span class="n">edit_capacitor_settings_for_convergence</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                <span class="c1"># raise exception if no convergence even after change</span>
                <span class="n">circuit_solve_and_check</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">capacitors_commands_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>

    <span class="c1"># if there are capacitors without cap control, add a voltage-controlled cap control</span>
    <span class="n">lines_df</span> <span class="o">=</span> <span class="n">get_all_line_info</span><span class="p">(</span><span class="n">compute_loading</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">lines_df</span><span class="p">[</span><span class="s1">&#39;bus1_extract&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lines_df</span><span class="p">[</span><span class="s1">&#39;bus1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">no_capcontrol_present_df</span> <span class="o">=</span> <span class="n">orig_capacitors_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">orig_capacitors_df</span><span class="p">[</span><span class="s1">&#39;capcontrol_present&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;capcontrol&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">no_capcontrol_present_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">capcontrol_name</span> <span class="o">=</span> <span class="s2">&quot;capcontrol&quot;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;capacitor_name&#39;</span><span class="p">]</span>
        <span class="c1"># extract line name that has the same bus as capacitor</span>
        <span class="n">line_name</span> <span class="o">=</span> <span class="n">lines_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lines_df</span><span class="p">[</span><span class="s1">&#39;bus1_extract&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;bus1&#39;</span><span class="p">]][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">default_pt_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;kv&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">nominal_voltage</span>
        <span class="n">command_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;New CapControl.</span><span class="si">{</span><span class="n">capcontrol_name</span><span class="si">}</span><span class="s2"> element=Line.</span><span class="si">{</span><span class="n">line_name</span><span class="si">}</span><span class="s2"> &quot;</span> \
                         <span class="sa">f</span><span class="s2">&quot;terminal=</span><span class="si">{</span><span class="n">default_capacitor_settings</span><span class="p">[</span><span class="s1">&#39;terminal&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> capacitor=</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;capacitor_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span> \
                         <span class="sa">f</span><span class="s2">&quot;PTRatio=</span><span class="si">{</span><span class="n">default_pt_ratio</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">default_capcontrol_command</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
        <span class="n">pass_flag</span> <span class="o">=</span> <span class="n">circuit_solve_and_check</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pass_flag</span><span class="p">:</span>
            <span class="n">command_string</span> <span class="o">=</span> <span class="n">edit_capacitor_settings_for_convergence</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
            <span class="c1"># raise exception if no convergence even after change</span>
            <span class="n">circuit_solve_and_check</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">capacitors_commands_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">capacitors_commands_list</span></div>


<span class="c1"># This function increases differences between cap ON and OFF voltages in user defined increments,</span>
<span class="c1">#  default 1 volt, until upper and lower bounds are reached.</span>
<div class="viewcode-block" id="sweep_capacitor_settings"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.sweep_capacitor_settings">[docs]</a><span class="k">def</span> <span class="nf">sweep_capacitor_settings</span><span class="p">(</span><span class="n">voltage_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initial_capacitors_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_capacitor_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">voltage_upper_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">voltage_lower_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function sweeps through capacitor settings and returns dataframe of severity metrics for all the sweeps of capacitor controls with best settings</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    voltage_config</span>
<span class="sd">    initial_capacitors_df</span>
<span class="sd">    default_capacitor_settings</span>
<span class="sd">    upper_limit</span>
<span class="sd">    lower_limit</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># This function increases differences between cap ON and OFF voltages in user defined increments,</span>
    <span class="c1">#  default 1 volt, until upper and lower bounds are reached.</span>
    <span class="n">capacitor_sweep_list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># this list will contain severity of each capacitor setting sweep</span>
    <span class="c1"># get severity index for original/initial capacitor settings (ie before the settings sweep)</span>
    <span class="n">temp_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cap_on_setting&#39;</span><span class="p">:</span> <span class="s1">&#39;original setting&#39;</span><span class="p">,</span> <span class="s1">&#39;cap_off_setting&#39;</span><span class="p">:</span> <span class="s1">&#39;original setting&#39;</span><span class="p">}</span>
    <span class="n">pass_flag</span> <span class="o">=</span> <span class="n">circuit_solve_and_check</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pass_flag</span><span class="p">:</span>  <span class="c1"># if there is convergence issue at this setting, go onto next setting and dont save</span>
        <span class="n">temp_dict</span><span class="p">[</span><span class="s1">&#39;converged&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">temp_dict</span><span class="p">[</span><span class="s1">&#39;converged&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">severity_dict</span> <span class="o">=</span> <span class="n">compute_voltage_violation_severity</span><span class="p">(</span>
        <span class="n">voltage_upper_limit</span><span class="o">=</span><span class="n">voltage_upper_limit</span><span class="p">,</span> <span class="n">voltage_lower_limit</span><span class="o">=</span><span class="n">voltage_lower_limit</span><span class="p">)</span>
    <span class="n">temp_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">severity_dict</span><span class="p">)</span>
    <span class="n">capacitor_sweep_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_dict</span><span class="p">)</span>
    <span class="c1"># start settings sweep</span>
    <span class="n">cap_on_setting</span> <span class="o">=</span> <span class="n">default_capacitor_settings</span><span class="p">[</span><span class="s2">&quot;capON&quot;</span><span class="p">]</span>
    <span class="n">cap_off_setting</span> <span class="o">=</span> <span class="n">default_capacitor_settings</span><span class="p">[</span><span class="s2">&quot;capOFF&quot;</span><span class="p">]</span>
    <span class="n">cap_control_gap</span> <span class="o">=</span> <span class="n">voltage_config</span><span class="p">[</span><span class="s2">&quot;capacitor_sweep_voltage_gap&quot;</span><span class="p">]</span>
    <span class="c1"># Apply same capacitor ON and OFF settings to all capacitor controls and determine their impact</span>
    <span class="c1"># iterate over capacitor on and off settings while they are within voltage violation limits</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">cap_on_setting</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">voltage_lower_limit</span> <span class="o">*</span> <span class="n">voltage_config</span><span class="p">[</span><span class="s2">&quot;nominal_voltage&quot;</span><span class="p">]))</span> <span class="ow">or</span> \
            <span class="p">(</span><span class="n">cap_off_setting</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">voltage_upper_limit</span> <span class="o">*</span> <span class="n">voltage_config</span><span class="p">[</span><span class="s2">&quot;nominal_voltage&quot;</span><span class="p">])):</span>
        <span class="n">temp_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cap_on_setting&#39;</span><span class="p">:</span> <span class="n">cap_on_setting</span><span class="p">,</span> <span class="s1">&#39;cap_off_setting&#39;</span><span class="p">:</span> <span class="n">cap_off_setting</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">initial_capacitors_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>  <span class="c1"># apply settings to all capacitors</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Edit CapControl.</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;capcontrol_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> ONsetting=</span><span class="si">{</span><span class="n">cap_on_setting</span><span class="si">}</span><span class="s2"> &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;OFFsetting=</span><span class="si">{</span><span class="n">cap_off_setting</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">pass_flag</span> <span class="o">=</span> <span class="n">circuit_solve_and_check</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pass_flag</span><span class="p">:</span>  <span class="c1"># if there is convergence issue at this setting, go onto next setting and dont save</span>
                <span class="n">temp_dict</span><span class="p">[</span><span class="s1">&#39;converged&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">temp_dict</span><span class="p">[</span><span class="s1">&#39;converged&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">bus_voltages_df</span><span class="p">,</span> <span class="n">undervoltage_bus_list</span><span class="p">,</span> <span class="n">overvoltage_bus_list</span><span class="p">,</span> <span class="n">buses_with_violations</span> <span class="o">=</span> <span class="n">get_bus_voltages</span><span class="p">(</span>
            <span class="n">voltage_upper_limit</span><span class="o">=</span><span class="n">voltage_upper_limit</span><span class="p">,</span> <span class="n">voltage_lower_limit</span><span class="o">=</span><span class="n">voltage_lower_limit</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">severity_dict</span> <span class="o">=</span> <span class="n">compute_voltage_violation_severity</span><span class="p">(</span>
            <span class="n">voltage_upper_limit</span><span class="o">=</span><span class="n">voltage_upper_limit</span><span class="p">,</span> <span class="n">voltage_lower_limit</span><span class="o">=</span><span class="n">voltage_lower_limit</span><span class="p">)</span>
        <span class="n">temp_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">severity_dict</span><span class="p">)</span>
        <span class="n">capacitor_sweep_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cap_on_setting</span> <span class="o">-</span> <span class="n">cap_control_gap</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">voltage_lower_limit</span> <span class="o">*</span> <span class="n">voltage_config</span><span class="p">[</span><span class="s2">&quot;nominal_voltage&quot;</span><span class="p">]):</span>
            <span class="n">cap_on_setting</span> <span class="o">=</span> <span class="n">voltage_lower_limit</span> <span class="o">*</span> <span class="n">voltage_config</span><span class="p">[</span><span class="s2">&quot;nominal_voltage&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cap_on_setting</span> <span class="o">=</span> <span class="n">cap_on_setting</span> <span class="o">-</span> <span class="n">cap_control_gap</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cap_off_setting</span> <span class="o">+</span> <span class="n">cap_control_gap</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">voltage_upper_limit</span> <span class="o">*</span> <span class="n">voltage_config</span><span class="p">[</span><span class="s2">&quot;nominal_voltage&quot;</span><span class="p">]):</span>
            <span class="n">cap_off_setting</span> <span class="o">=</span> <span class="n">voltage_upper_limit</span> <span class="o">*</span> <span class="n">voltage_config</span><span class="p">[</span><span class="s2">&quot;nominal_voltage&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cap_off_setting</span> <span class="o">=</span> <span class="n">cap_off_setting</span> <span class="o">+</span> <span class="n">cap_control_gap</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">capacitor_sweep_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">capacitor_sweep_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">capacitor_sweep_df</span></div>


<div class="viewcode-block" id="choose_best_capacitor_sweep_setting"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.choose_best_capacitor_sweep_setting">[docs]</a><span class="k">def</span> <span class="nf">choose_best_capacitor_sweep_setting</span><span class="p">(</span><span class="n">capacitor_sweep_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initial_capacitors_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function takes the dataframe containing severity metrics, identifies the best cap control setting out</span>
<span class="sd">    of all the sweeps and returns dataframe of capacitor controls with best settings</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    capacitor_sweep_df</span>
<span class="sd">    initial_capacitors_df</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># start with assumption that original setting is best setting</span>
    <span class="n">original_setting</span> <span class="o">=</span> <span class="n">capacitor_sweep_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">capacitor_sweep_df</span><span class="p">[</span><span class="s1">&#39;cap_on_setting&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;original setting&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">deciding_field</span> <span class="o">=</span> <span class="s1">&#39;deviation_severity&#39;</span>
    <span class="n">min_severity_setting</span> <span class="o">=</span> <span class="n">capacitor_sweep_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">capacitor_sweep_df</span><span class="p">[</span><span class="n">deciding_field</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()]</span>
    <span class="n">setting_type</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="c1"># if min severity is greater than or same as that of original setting,</span>
    <span class="c1"># then just assign original setting as min_severity_setting</span>
    <span class="k">if</span> <span class="n">min_severity_setting</span><span class="p">[</span><span class="n">deciding_field</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">original_setting</span><span class="p">[</span><span class="n">deciding_field</span><span class="p">]:</span>
        <span class="n">capacitors_df</span> <span class="o">=</span> <span class="n">initial_capacitors_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># here best_setting is initial settings</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Original capacitor settings are best. No need to change capacitor settings.&quot;</span><span class="p">)</span>
        <span class="n">setting_type</span> <span class="o">=</span> <span class="s1">&#39;initial_setting&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># apply same best setting to all capacitors</span>
        <span class="n">capacitors_df</span> <span class="o">=</span> <span class="n">initial_capacitors_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">capacitors_df</span><span class="p">[</span><span class="s1">&#39;ONsetting&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_severity_setting</span><span class="p">[</span><span class="s1">&#39;ONsetting&#39;</span><span class="p">]</span>
        <span class="n">capacitors_df</span><span class="p">[</span><span class="s1">&#39;OFFsetting&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_severity_setting</span><span class="p">[</span><span class="s1">&#39;OFFsetting&#39;</span><span class="p">]</span>
    <span class="n">properties_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ONsetting&quot;</span><span class="p">,</span> <span class="s2">&quot;OFFsetting&quot;</span><span class="p">]</span>  <span class="c1"># list of properties to be edited in commands</span>
    <span class="n">capacitor_settings_commands_list</span> <span class="o">=</span> <span class="n">create_capcontrol_settings_commands</span><span class="p">(</span><span class="n">properties_list</span><span class="o">=</span><span class="n">properties_list</span><span class="p">,</span>
                                                                           <span class="n">capacitors_df</span><span class="o">=</span><span class="n">capacitors_df</span><span class="p">,</span>
                                                                           <span class="n">creation_action</span><span class="o">=</span><span class="s1">&#39;Edit&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">command_string</span> <span class="ow">in</span> <span class="n">capacitor_settings_commands_list</span><span class="p">:</span>
        <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
    <span class="n">circuit_solve_and_check</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">setting_type</span> <span class="o">==</span> <span class="s1">&#39;initial_setting&#39;</span><span class="p">:</span>  <span class="c1"># if initial settings are best, no need to return command with settings</span>
        <span class="n">capacitor_settings_commands_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="n">capacitors_df</span><span class="p">,</span> <span class="n">capacitor_settings_commands_list</span></div>


<div class="viewcode-block" id="create_capcontrol_settings_commands"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.create_capcontrol_settings_commands">[docs]</a><span class="k">def</span> <span class="nf">create_capcontrol_settings_commands</span><span class="p">(</span><span class="n">properties_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">capacitors_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">creation_action</span><span class="o">=</span><span class="s1">&#39;New&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function creates a list of capacitor control commands, based on the properties list and cap dataframe passed</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    properties_list</span>
<span class="sd">    capacitors_df</span>
<span class="sd">    creation_action</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">capacitor_commands_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">properties_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">properties_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ONsetting&quot;</span><span class="p">,</span> <span class="s2">&quot;OFFsetting&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">capacitors_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">command_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">creation_action</span><span class="si">}</span><span class="s2"> CapControl.</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;capcontrol_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">property_name</span> <span class="ow">in</span> <span class="n">properties_list</span><span class="p">:</span>
            <span class="n">command_string</span> <span class="o">=</span> <span class="n">command_string</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">property_name</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="n">property_name</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">capacitor_commands_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">capacitor_commands_list</span></div>


<div class="viewcode-block" id="compute_voltage_violation_severity"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.compute_voltage_violation_severity">[docs]</a><span class="k">def</span> <span class="nf">compute_voltage_violation_severity</span><span class="p">(</span><span class="n">voltage_upper_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">voltage_lower_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function computes voltage violation severity metrics, based on bus voltages</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    bus_voltages_df</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bus_voltages_df</span><span class="p">,</span> <span class="n">undervoltage_bus_list</span><span class="p">,</span> <span class="n">overvoltage_bus_list</span><span class="p">,</span> <span class="n">buses_with_violations</span> <span class="o">=</span> <span class="n">get_bus_voltages</span><span class="p">(</span>
        <span class="n">voltage_upper_limit</span><span class="o">=</span><span class="n">voltage_upper_limit</span><span class="p">,</span> <span class="n">voltage_lower_limit</span><span class="o">=</span><span class="n">voltage_lower_limit</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">deviation_severity</span> <span class="o">=</span> <span class="n">bus_voltages_df</span><span class="p">[</span><span class="s1">&#39;Min voltage_deviation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">bus_voltages_df</span><span class="p">[</span><span class="s1">&#39;Max voltage_deviation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">undervoltage_bus_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <span class="n">bus_voltages_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bus_voltages_df</span><span class="p">[</span><span class="s1">&#39;Undervoltage violation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
    <span class="n">overvoltage_bus_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bus_voltages_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bus_voltages_df</span><span class="p">[</span><span class="s1">&#39;Overvoltage violation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
    <span class="n">buses_with_violations</span> <span class="o">=</span> <span class="n">undervoltage_bus_list</span> <span class="o">+</span> <span class="n">overvoltage_bus_list</span>
    <span class="n">objective_function</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buses_with_violations</span><span class="p">)</span> <span class="o">*</span> <span class="n">deviation_severity</span>
    <span class="n">severity_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;deviation_severity&#39;</span><span class="p">:</span> <span class="n">deviation_severity</span><span class="p">,</span>
                     <span class="s1">&#39;number_buses_with_violations&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">buses_with_violations</span><span class="p">),</span>
                     <span class="s1">&#39;objective_function&#39;</span><span class="p">:</span> <span class="n">objective_function</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">severity_dict</span></div>


<div class="viewcode-block" id="correct_regcontrol_parameters"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.correct_regcontrol_parameters">[docs]</a><span class="k">def</span> <span class="nf">correct_regcontrol_parameters</span><span class="p">(</span><span class="n">orig_regcontrols_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function corrects regcontrol ptratio is different from original. And generates commands list</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    orig_regcontrols_df</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># correct regcontrol parameters settings</span>
    <span class="n">default_regcontrol_command</span> <span class="o">=</span> <span class="s2">&quot; enabled=True&quot;</span>
    <span class="n">orig_string</span> <span class="o">=</span> <span class="s1">&#39; !original, corrected PTratio only&#39;</span>
    <span class="n">regcontrols_commands_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">orig_regcontrols_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">round</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;ptratio&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">round</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;old_ptratio&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">command_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Edit RegControl.</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> ptratio=</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;ptratio&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">default_regcontrol_command</span>\
                             <span class="o">+</span> <span class="n">orig_string</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
            <span class="n">circuit_solve_and_check</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="c1"># this does not change original settings, so should not cause convergence issues</span>
            <span class="n">regcontrols_commands_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">regcontrols_commands_list</span></div>


<div class="viewcode-block" id="sweep_regcontrol_settings"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.sweep_regcontrol_settings">[docs]</a><span class="k">def</span> <span class="nf">sweep_regcontrol_settings</span><span class="p">(</span><span class="n">voltage_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initial_regcontrols_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">voltage_upper_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">voltage_lower_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">exclude_sub_ltc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">only_sub_ltc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function increases differences vreg in user defined increments, until upper and lower bounds are reached.</span>
<span class="sd">    At a time, same settings are applied to all regulator controls</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    voltage_config</span>
<span class="sd">    initial_regcontrols_df</span>
<span class="sd">    upper_limit</span>
<span class="sd">    lower_limit</span>
<span class="sd">    exclude_sub_ltc</span>
<span class="sd">    only_sub_ltc</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">exclude_sub_ltc</span><span class="p">:</span>
        <span class="n">initial_df</span> <span class="o">=</span> <span class="n">initial_regcontrols_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">initial_regcontrols_df</span><span class="p">[</span><span class="s1">&#39;at_substation_xfmr_flag&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">only_sub_ltc</span><span class="p">:</span>
        <span class="n">initial_df</span> <span class="o">=</span> <span class="n">initial_regcontrols_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">initial_regcontrols_df</span><span class="p">[</span><span class="s1">&#39;at_substation_xfmr_flag&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span>
    <span class="n">regcontrol_sweep_list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># this list will contain severity of each setting sweep</span>
    <span class="c1"># get severity index for original/initial settings (ie before the settings sweep)</span>
    <span class="n">temp_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;setting&#39;</span><span class="p">:</span> <span class="s1">&#39;original&#39;</span><span class="p">}</span>
    <span class="n">bus_voltages_df</span><span class="p">,</span> <span class="n">undervoltage_bus_list</span><span class="p">,</span> <span class="n">overvoltage_bus_list</span><span class="p">,</span> <span class="n">buses_with_violations</span> <span class="o">=</span> <span class="n">get_bus_voltages</span><span class="p">(</span>
        <span class="n">voltage_upper_limit</span><span class="o">=</span><span class="n">voltage_upper_limit</span><span class="p">,</span> <span class="n">voltage_lower_limit</span><span class="o">=</span><span class="n">voltage_lower_limit</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">pass_flag</span> <span class="o">=</span> <span class="n">circuit_solve_and_check</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pass_flag</span><span class="p">:</span>  <span class="c1"># if there is convergence issue at this setting, go onto next setting and dont save</span>
        <span class="n">temp_dict</span><span class="p">[</span><span class="s1">&#39;converged&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">temp_dict</span><span class="p">[</span><span class="s1">&#39;converged&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">severity_dict</span> <span class="o">=</span> <span class="n">compute_voltage_violation_severity</span><span class="p">(</span>
        <span class="n">voltage_upper_limit</span><span class="o">=</span><span class="n">voltage_upper_limit</span><span class="p">,</span> <span class="n">voltage_lower_limit</span><span class="o">=</span><span class="n">voltage_lower_limit</span><span class="p">)</span>
    <span class="n">temp_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">severity_dict</span><span class="p">)</span>
    <span class="n">regcontrol_sweep_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_dict</span><span class="p">)</span>
    <span class="c1"># generate list of voltage setpoints</span>
    <span class="n">vregs_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">vreg</span> <span class="o">=</span> <span class="n">voltage_lower_limit</span> <span class="o">*</span> <span class="n">voltage_config</span><span class="p">[</span><span class="s2">&quot;nominal_voltage&quot;</span><span class="p">]</span>
    <span class="k">while</span> <span class="n">vreg</span> <span class="o">&lt;</span> <span class="n">voltage_upper_limit</span> <span class="o">*</span> <span class="n">voltage_config</span><span class="p">[</span><span class="s2">&quot;nominal_voltage&quot;</span><span class="p">]:</span>
        <span class="n">vregs_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vreg</span><span class="p">)</span>
        <span class="n">vreg</span> <span class="o">+=</span> <span class="n">voltage_config</span><span class="p">[</span><span class="s2">&quot;reg_v_delta&quot;</span><span class="p">]</span>
    <span class="c1"># start settings sweep</span>
    <span class="k">for</span> <span class="n">vreg</span> <span class="ow">in</span> <span class="n">vregs_list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">voltage_config</span><span class="p">[</span><span class="s2">&quot;reg_control_bands&quot;</span><span class="p">]:</span>
            <span class="n">temp_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;setting&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">vreg</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">band</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s1">&#39;vreg&#39;</span><span class="p">:</span> <span class="n">vreg</span><span class="p">,</span> <span class="s1">&#39;band&#39;</span><span class="p">:</span> <span class="n">band</span><span class="p">}</span>
            <span class="c1"># Apply same settings to all controls and determine their impact</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">initial_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">vreg</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">band</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Edit RegControl.</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> vreg=</span><span class="si">{</span><span class="n">vreg</span><span class="si">}</span><span class="s2"> band=</span><span class="si">{</span><span class="n">band</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">pass_flag</span> <span class="o">=</span> <span class="n">circuit_solve_and_check</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pass_flag</span><span class="p">:</span>  <span class="c1"># if there is convergence issue at this setting, go onto next setting and dont save</span>
                    <span class="n">temp_dict</span><span class="p">[</span><span class="s1">&#39;converged&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">temp_dict</span><span class="p">[</span><span class="s1">&#39;converged&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">bus_voltages_df</span><span class="p">,</span> <span class="n">undervoltage_bus_list</span><span class="p">,</span> <span class="n">overvoltage_bus_list</span><span class="p">,</span> <span class="n">buses_with_violations</span> <span class="o">=</span> <span class="n">get_bus_voltages</span><span class="p">(</span>
                            <span class="n">voltage_upper_limit</span><span class="o">=</span><span class="n">voltage_config</span><span class="p">[</span><span class="s1">&#39;initial_upper_limit&#39;</span><span class="p">],</span>
                            <span class="n">voltage_lower_limit</span><span class="o">=</span><span class="n">voltage_config</span><span class="p">[</span><span class="s1">&#39;initial_lower_limit&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>  <span class="c1"># catch convergence error</span>
                        <span class="n">temp_dict</span><span class="p">[</span><span class="s1">&#39;converged&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="n">severity_dict</span> <span class="o">=</span> <span class="n">compute_voltage_violation_severity</span><span class="p">(</span>
                        <span class="n">voltage_upper_limit</span><span class="o">=</span><span class="n">voltage_upper_limit</span><span class="p">,</span> <span class="n">voltage_lower_limit</span><span class="o">=</span><span class="n">voltage_lower_limit</span><span class="p">)</span>
                    <span class="n">temp_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">severity_dict</span><span class="p">)</span>
                <span class="n">regcontrol_sweep_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_dict</span><span class="p">)</span>
    <span class="n">regcontrol_sweep_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">regcontrol_sweep_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">regcontrol_sweep_df</span></div>


<div class="viewcode-block" id="choose_best_regcontrol_sweep_setting"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.choose_best_regcontrol_sweep_setting">[docs]</a><span class="k">def</span> <span class="nf">choose_best_regcontrol_sweep_setting</span><span class="p">(</span><span class="n">regcontrol_sweep_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initial_regcontrols_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude_sub_ltc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                         <span class="n">only_sub_ltc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function takes the dataframe containing severity metrics, identifies the best regcontrol setting out</span>
<span class="sd">    of all the sweeps and returns dataframe of regcontrols with best settings</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    regcontrol_sweep_df</span>
<span class="sd">    initial_regcontrols_df</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">exclude_sub_ltc</span><span class="p">:</span>
        <span class="n">initial_df</span> <span class="o">=</span> <span class="n">initial_regcontrols_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">initial_regcontrols_df</span><span class="p">[</span><span class="s1">&#39;at_substation_xfmr_flag&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">only_sub_ltc</span><span class="p">:</span>
        <span class="n">initial_df</span> <span class="o">=</span> <span class="n">initial_regcontrols_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">initial_regcontrols_df</span><span class="p">[</span><span class="s1">&#39;at_substation_xfmr_flag&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span>
    <span class="c1"># start with assumption that original setting is best setting</span>
    <span class="n">original_setting</span> <span class="o">=</span> <span class="n">regcontrol_sweep_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">regcontrol_sweep_df</span><span class="p">[</span><span class="s1">&#39;setting&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;original&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">deciding_field</span> <span class="o">=</span> <span class="s1">&#39;deviation_severity&#39;</span>
    <span class="n">regcontrol_sweep_df</span> <span class="o">=</span> <span class="n">regcontrol_sweep_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">regcontrol_sweep_df</span><span class="p">[</span><span class="s1">&#39;converged&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span>
    <span class="n">min_severity_setting</span> <span class="o">=</span> <span class="n">regcontrol_sweep_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">regcontrol_sweep_df</span><span class="p">[</span><span class="n">deciding_field</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()]</span>
    <span class="c1"># if min severity is greater than or same as that of original setting,</span>
    <span class="c1"># then just assign original setting as min_severity_setting</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">min_severity_setting</span><span class="p">[</span><span class="n">deciding_field</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">original_setting</span><span class="p">[</span><span class="n">deciding_field</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">original_setting</span><span class="p">[</span><span class="s1">&#39;converged&#39;</span><span class="p">]):</span>
        <span class="n">setting_type</span> <span class="o">=</span> <span class="s1">&#39;original&#39;</span>
        <span class="n">regcontrols_df</span> <span class="o">=</span> <span class="n">initial_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># here best_setting is initial settings</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">setting_type</span> <span class="o">=</span> <span class="s1">&#39;changed&#39;</span>
        <span class="n">regcontrols_df</span> <span class="o">=</span> <span class="n">initial_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">regcontrols_df</span><span class="p">[</span><span class="s1">&#39;vreg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_severity_setting</span><span class="p">[</span><span class="s1">&#39;vreg&#39;</span><span class="p">]</span>
        <span class="n">regcontrols_df</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_severity_setting</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">]</span>
    <span class="n">properties_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;vreg&quot;</span><span class="p">,</span> <span class="s2">&quot;band&quot;</span><span class="p">]</span>  <span class="c1"># list of properties to be edited in commands</span>
    <span class="n">regcontrol_settings_commands_list</span> <span class="o">=</span> <span class="n">create_regcontrol_settings_commands</span><span class="p">(</span><span class="n">properties_list</span><span class="o">=</span><span class="n">properties_list</span><span class="p">,</span>
                                                                            <span class="n">regcontrols_df</span><span class="o">=</span><span class="n">regcontrols_df</span><span class="p">,</span>
                                                                            <span class="n">creation_action</span><span class="o">=</span><span class="s1">&#39;Edit&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">command_string</span> <span class="ow">in</span> <span class="n">regcontrol_settings_commands_list</span><span class="p">:</span>
        <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
    <span class="n">circuit_solve_and_check</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">setting_type</span> <span class="o">==</span> <span class="s1">&#39;original&#39;</span><span class="p">:</span>  <span class="c1"># if original settings, no need to add to upgrades commands list</span>
        <span class="n">regcontrol_settings_commands_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Original Regulator control settings are the best.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">regcontrols_df</span><span class="p">,</span> <span class="n">regcontrol_settings_commands_list</span></div>


<div class="viewcode-block" id="create_regcontrol_settings_commands"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.create_regcontrol_settings_commands">[docs]</a><span class="k">def</span> <span class="nf">create_regcontrol_settings_commands</span><span class="p">(</span><span class="n">properties_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">regcontrols_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">creation_action</span><span class="o">=</span><span class="s1">&#39;New&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function creates a list of regcontrol commands, based on the properties list and regcontrol dataframe passed</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    properties_list</span>
<span class="sd">    regcontrols_df</span>
<span class="sd">    creation_action</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">regcontrol_commands_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">properties_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">properties_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;vreg&quot;</span><span class="p">,</span> <span class="s2">&quot;band&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">regcontrols_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">command_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">creation_action</span><span class="si">}</span><span class="s2"> RegControl.</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">property_name</span> <span class="ow">in</span> <span class="n">properties_list</span><span class="p">:</span>
            <span class="n">command_string</span> <span class="o">=</span> <span class="n">command_string</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">property_name</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="n">property_name</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">regcontrol_commands_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">regcontrol_commands_list</span></div>


<div class="viewcode-block" id="add_new_regcontrol_command"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.add_new_regcontrol_command">[docs]</a><span class="k">def</span> <span class="nf">add_new_regcontrol_command</span><span class="p">(</span><span class="n">xfmr_info_series</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_regcontrol_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nominal_voltage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">action_type</span><span class="o">=</span><span class="s1">&#39;New&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function runs and returns the dss command to add regulator control at a transformer.</span>
<span class="sd">    It also solves the circuit and calculates voltage bases after the regulator has been added to the circuit.</span>
<span class="sd">    It calls another function to create the dss command.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    xfmr_info_series</span>
<span class="sd">    default_regcontrol_settings</span>
<span class="sd">    nominal_voltage</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">command_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">regcontrol_info_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">default_regcontrol_settings</span><span class="p">)</span>
    <span class="n">regcontrol_info_series</span><span class="p">[</span><span class="s1">&#39;transformer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xfmr_info_series</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
    <span class="n">regcontrol_info_series</span><span class="p">[</span><span class="s1">&#39;winding&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xfmr_info_series</span><span class="p">[</span><span class="s1">&#39;windings&#39;</span><span class="p">]</span>

    <span class="c1"># use secondary voltage to define ptratio</span>
    <span class="c1"># If the winding is Wye, the line-to-neutral voltage is used to compute PTratio.</span>
    <span class="c1"># Else, the line-to-line voltage is used.</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">xfmr_info_series</span><span class="p">[</span><span class="s1">&#39;kVs&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">xfmr_info_series</span><span class="p">[</span><span class="s1">&#39;kVs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">convert_list_string_to_list</span><span class="p">(</span><span class="n">xfmr_info_series</span><span class="p">[</span><span class="s1">&#39;kVs&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">xfmr_info_series</span><span class="p">[</span><span class="s1">&#39;conns&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">xfmr_info_series</span><span class="p">[</span><span class="s1">&#39;conns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">convert_list_string_to_list</span><span class="p">(</span><span class="n">xfmr_info_series</span><span class="p">[</span><span class="s1">&#39;conns&#39;</span><span class="p">])</span>
    <span class="n">sec_conn</span> <span class="o">=</span> <span class="n">xfmr_info_series</span><span class="p">[</span><span class="s1">&#39;conns&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">sec_conn</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;wye&#39;</span><span class="p">:</span>
        <span class="n">sec_voltage</span> <span class="o">=</span> <span class="n">xfmr_info_series</span><span class="p">[</span><span class="s1">&#39;kVs&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sec_voltage</span> <span class="o">=</span> <span class="n">xfmr_info_series</span><span class="p">[</span><span class="s1">&#39;kVs&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">regcontrol_info_series</span><span class="p">[</span><span class="s2">&quot;ptratio&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sec_voltage</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">nominal_voltage</span>
    <span class="c1"># use the primary bus to define name</span>
    <span class="n">regcontrol_info_series</span><span class="p">[</span><span class="s1">&#39;regcontrol_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;new_regcontrol_&#39;</span> <span class="o">+</span> <span class="n">xfmr_info_series</span><span class="p">[</span><span class="s1">&#39;bus_names_only&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">temp_df</span> <span class="o">=</span> <span class="n">get_regcontrol_info</span><span class="p">()</span>
    <span class="n">enabled_regcontrol_exists</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
        <span class="n">temp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">temp_df</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">regcontrol_info_series</span><span class="p">[</span><span class="s1">&#39;regcontrol_name&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">temp_df</span><span class="p">[</span><span class="s1">&#39;enabled&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)])</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">enabled_regcontrol_exists</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Enabled regcontrol already exists: </span><span class="si">{</span><span class="n">regcontrol_info_series</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># return {&#39;command_list&#39;: [], &#39;new_regcontrol_name&#39;: None}</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">disabled_regcontrol_exists</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
        <span class="n">temp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">temp_df</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">regcontrol_info_series</span><span class="p">[</span><span class="s1">&#39;regcontrol_name&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">temp_df</span><span class="p">[</span><span class="s1">&#39;enabled&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)])</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">disabled_regcontrol_exists</span><span class="p">:</span>
        <span class="n">action_type</span> <span class="o">=</span> <span class="s1">&#39;Edit&#39;</span>
    <span class="n">new_regcontrol_command</span> <span class="o">=</span> <span class="n">define_regcontrol_object</span><span class="p">(</span><span class="n">regcontrol_name</span><span class="o">=</span><span class="n">regcontrol_info_series</span><span class="p">[</span><span class="s1">&#39;regcontrol_name&#39;</span><span class="p">],</span>
                                                      <span class="n">action_type</span><span class="o">=</span><span class="n">action_type</span><span class="p">,</span> <span class="n">regcontrol_info_series</span><span class="o">=</span><span class="n">regcontrol_info_series</span><span class="p">,</span>
                                                      <span class="n">general_property_list</span><span class="o">=</span><span class="n">regcontrol_info_series</span><span class="p">[</span><span class="s2">&quot;properties_to_be_defined&quot;</span><span class="p">])</span>
    <span class="n">check_dss_run_command</span><span class="p">(</span><span class="n">new_regcontrol_command</span><span class="p">)</span>  <span class="c1"># run command</span>
    <span class="n">check_dss_run_command</span><span class="p">(</span><span class="s1">&#39;CalcVoltageBases&#39;</span><span class="p">)</span>
    <span class="n">pass_flag</span> <span class="o">=</span> <span class="n">circuit_solve_and_check</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># solve circuit</span>
    <span class="n">command_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_regcontrol_command</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;command_list&#39;</span><span class="p">:</span> <span class="n">command_list</span><span class="p">,</span> <span class="s1">&#39;new_regcontrol_name&#39;</span><span class="p">:</span> <span class="n">regcontrol_info_series</span><span class="p">[</span><span class="s1">&#39;regcontrol_name&#39;</span><span class="p">]}</span></div>


<div class="viewcode-block" id="define_regcontrol_object"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.define_regcontrol_object">[docs]</a><span class="k">def</span> <span class="nf">define_regcontrol_object</span><span class="p">(</span><span class="n">regcontrol_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">action_type</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">regcontrol_info_series</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">general_property_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function is used to create a command string to define an opendss regcontrol object at a given bus.</span>
<span class="sd">    A transformer should already exist at this bus. Regulator control will be placed on this transformer.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    regcontrol_name</span>
<span class="sd">    action_type</span>
<span class="sd">    regcontrol_info_series</span>
<span class="sd">    general_property_list</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># transformer should exist at this bus. Reg control should not exist on the transformer</span>
    <span class="n">command_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">action_type</span><span class="si">}</span><span class="s2"> RegControl.</span><span class="si">{</span><span class="n">regcontrol_name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">action_type</span> <span class="o">==</span> <span class="s2">&quot;New&quot;</span><span class="p">:</span>
        <span class="n">command_string</span> <span class="o">=</span> <span class="n">command_string</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; transformer=</span><span class="si">{</span><span class="n">regcontrol_info_series</span><span class="p">[</span><span class="s1">&#39;transformer&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="c1"># these properties contain regcontrol data (refer OpenDSS manual for more information on these parameters)</span>
    <span class="k">if</span> <span class="n">general_property_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">general_property_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;winding&#39;</span><span class="p">,</span> <span class="s1">&#39;ptratio&#39;</span><span class="p">,</span> <span class="s1">&#39;band&#39;</span><span class="p">,</span> <span class="s1">&#39;vreg&#39;</span><span class="p">,</span> <span class="s1">&#39;delay&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">property_name</span> <span class="ow">in</span> <span class="n">general_property_list</span><span class="p">:</span>
        <span class="n">temp_s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">property_name</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">regcontrol_info_series</span><span class="p">[</span><span class="n">property_name</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">command_string</span> <span class="o">=</span> <span class="n">command_string</span> <span class="o">+</span> <span class="n">temp_s</span>
    <span class="n">command_string</span> <span class="o">=</span> <span class="n">command_string</span> <span class="o">+</span> <span class="s2">&quot; enabled=True&quot;</span>
    <span class="k">return</span> <span class="n">command_string</span></div>


<div class="viewcode-block" id="sweep_and_choose_regcontrol_setting"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.sweep_and_choose_regcontrol_setting">[docs]</a><span class="k">def</span> <span class="nf">sweep_and_choose_regcontrol_setting</span><span class="p">(</span><span class="n">voltage_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initial_regcontrols_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">upper_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                        <span class="n">lower_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude_sub_ltc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">only_sub_ltc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dss_file_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                        <span class="n">dss_commands_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function combines the regcontrol settings sweep and choosing of best setting.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    voltage_config</span>
<span class="sd">    initial_regcontrols_df</span>
<span class="sd">    upper_limit</span>
<span class="sd">    lower_limit</span>
<span class="sd">    exclude_sub_ltc</span>
<span class="sd">    only_sub_ltc</span>
<span class="sd">    dss_file_list</span>
<span class="sd">    dss_commands_list</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># sweep through settings and identify best setting</span>
    <span class="n">regcontrol_sweep_df</span> <span class="o">=</span> <span class="n">sweep_regcontrol_settings</span><span class="p">(</span><span class="n">voltage_config</span><span class="o">=</span><span class="n">voltage_config</span><span class="p">,</span>
                                                    <span class="n">initial_regcontrols_df</span><span class="o">=</span><span class="n">initial_regcontrols_df</span><span class="p">,</span>
                                                    <span class="n">voltage_upper_limit</span><span class="o">=</span><span class="n">upper_limit</span><span class="p">,</span> <span class="n">voltage_lower_limit</span><span class="o">=</span><span class="n">lower_limit</span><span class="p">,</span>
                                                    <span class="n">exclude_sub_ltc</span><span class="o">=</span><span class="n">exclude_sub_ltc</span><span class="p">,</span> <span class="n">only_sub_ltc</span><span class="o">=</span><span class="n">only_sub_ltc</span><span class="p">,</span>
                                                    <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="c1"># reload circuit after settings sweep</span>
    <span class="n">reload_dss_circuit</span><span class="p">(</span><span class="n">dss_file_list</span><span class="o">=</span><span class="n">dss_file_list</span><span class="p">,</span> <span class="n">commands_list</span><span class="o">=</span><span class="n">dss_commands_list</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="c1"># choose best setting</span>
    <span class="n">regcontrols_df</span><span class="p">,</span> <span class="n">regcontrol_settings_commands_list</span> <span class="o">=</span> <span class="n">choose_best_regcontrol_sweep_setting</span><span class="p">(</span>
        <span class="n">regcontrol_sweep_df</span><span class="o">=</span><span class="n">regcontrol_sweep_df</span><span class="p">,</span> <span class="n">initial_regcontrols_df</span><span class="o">=</span><span class="n">initial_regcontrols_df</span><span class="p">,</span>
        <span class="n">exclude_sub_ltc</span><span class="o">=</span><span class="n">exclude_sub_ltc</span><span class="p">,</span> <span class="n">only_sub_ltc</span><span class="o">=</span><span class="n">only_sub_ltc</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">regcontrols_df</span><span class="p">,</span> <span class="n">regcontrol_settings_commands_list</span></div>


<div class="viewcode-block" id="add_substation_xfmr"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.add_substation_xfmr">[docs]</a><span class="k">def</span> <span class="nf">add_substation_xfmr</span><span class="p">(</span><span class="n">chosen_option_row</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_row</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

    <span class="n">command_string</span> <span class="o">=</span> <span class="n">define_xfmr_object</span><span class="p">(</span><span class="n">xfmr_name</span><span class="o">=</span><span class="n">data_row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">xfmr_info_series</span><span class="o">=</span><span class="n">chosen_option_row</span><span class="p">,</span>
                                        <span class="n">action_type</span><span class="o">=</span><span class="s1">&#39;New&#39;</span><span class="p">,</span> <span class="n">buses_list</span><span class="o">=</span><span class="n">data_row</span><span class="p">[</span><span class="s1">&#39;buses&#39;</span><span class="p">])</span>
    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
    <span class="n">circuit_solve_and_check</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># solve circuit and CalcVoltageBases</span>

    <span class="k">return</span> <span class="n">command_string</span></div>


<div class="viewcode-block" id="compare_objective_function"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.compare_objective_function">[docs]</a><span class="k">def</span> <span class="nf">compare_objective_function</span><span class="p">():</span>
    <span class="n">final_settings_commands</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="n">final_settings_commands</span></div>


<div class="viewcode-block" id="add_new_node_and_xfmr"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.add_new_node_and_xfmr">[docs]</a><span class="k">def</span> <span class="nf">add_new_node_and_xfmr</span><span class="p">(</span><span class="n">node</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">circuit_source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sub_xfmr_conn_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">action_type</span><span class="o">=</span><span class="s1">&#39;New&#39;</span><span class="p">,</span>
                          <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function adds a new transformer by creating a new node</span>
<span class="sd">    (before or after a line, depending on whether it is a substation xfmr)</span>
<span class="sd">    action_type parameter is &#39;New&#39; by default, unless we&#39;re redefining, and the &#39;Edit&#39; has to be passed.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    node</span>
<span class="sd">    circuit_source</span>
<span class="sd">    sub_xfmr_conn_type</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">substation_node_flag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">commands_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">node</span> <span class="o">==</span> <span class="n">circuit_source</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="n">substation_node_flag</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># Find line to which this node is connected to</span>
    <span class="n">all_lines_df</span> <span class="o">=</span> <span class="n">get_all_line_info</span><span class="p">()</span>
    <span class="n">all_lines_df</span><span class="p">[</span><span class="s2">&quot;bus1_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_lines_df</span><span class="p">[</span><span class="s2">&quot;bus1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">all_lines_df</span><span class="p">[</span><span class="s2">&quot;bus2_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_lines_df</span><span class="p">[</span><span class="s2">&quot;bus2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c1"># For substation LTC, substation transformer will be placed at first bus of line (i.e. before the line)</span>
    <span class="c1"># make bus1 of line as regcontrol node</span>
    <span class="k">if</span> <span class="n">substation_node_flag</span><span class="p">:</span>
        <span class="n">chosen_line_info</span> <span class="o">=</span> <span class="n">all_lines_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">all_lines_df</span><span class="p">[</span><span class="s2">&quot;bus1_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">new_node</span> <span class="o">=</span> <span class="s2">&quot;newnode_&quot;</span> <span class="o">+</span> <span class="n">chosen_line_info</span><span class="p">[</span><span class="s2">&quot;bus2&quot;</span><span class="p">]</span>  <span class="c1"># contains terminal information too</span>
        <span class="n">new_node_name</span> <span class="o">=</span> <span class="s2">&quot;newnode_&quot;</span> <span class="o">+</span> <span class="n">chosen_line_info</span><span class="p">[</span><span class="s2">&quot;bus2_name&quot;</span><span class="p">]</span>
        <span class="n">curr_time</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="c1"># this is added to name to ensure it is unique</span>
        <span class="n">time_stamp</span> <span class="o">=</span> <span class="n">curr_time</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">curr_time</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">xfmr_name</span> <span class="o">=</span> <span class="s2">&quot;New_xfmr_&quot;</span> <span class="o">+</span> <span class="n">node</span> <span class="o">+</span> <span class="n">time_stamp</span>
        <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">chosen_line_info</span><span class="p">[</span><span class="s2">&quot;bus1_name&quot;</span><span class="p">])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">X</span><span class="p">()</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">Y</span><span class="p">()</span>
        <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">chosen_line_info</span><span class="p">[</span><span class="s2">&quot;bus2_name&quot;</span><span class="p">])</span>
        <span class="n">kV_node</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">kVBase</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">chosen_line_info</span><span class="p">[</span><span class="s2">&quot;phases&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">kV_DT</span> <span class="o">=</span> <span class="n">kV_node</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># L-L voltage</span>
        <span class="c1"># if single phase node</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kV_DT</span> <span class="o">=</span> <span class="n">kV_node</span>  <span class="c1"># L-N voltage</span>
        <span class="c1"># ideally we would use an auto transformer which would need a much smaller kVA rating</span>
        <span class="n">kVA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kV_DT</span> <span class="o">*</span> <span class="n">chosen_line_info</span><span class="p">[</span><span class="s2">&quot;normamps&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>   <span class="c1"># 10% over sized transformer</span>
        <span class="n">new_xfmr_command_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">action_type</span><span class="si">}</span><span class="s2"> Transformer.</span><span class="si">{</span><span class="n">xfmr_name</span><span class="si">}</span><span class="s2"> phases=</span><span class="si">{</span><span class="n">chosen_line_info</span><span class="p">[</span><span class="s1">&#39;phases&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span> \
                                  <span class="sa">f</span><span class="s2">&quot;windings=2 buses=(</span><span class="si">{</span><span class="n">chosen_line_info</span><span class="p">[</span><span class="s1">&#39;bus1&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">new_node</span><span class="si">}</span><span class="s2">) &quot;</span> \
                                  <span class="sa">f</span><span class="s2">&quot;conns=(</span><span class="si">{</span><span class="n">sub_xfmr_conn_type</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">sub_xfmr_conn_type</span><span class="si">}</span><span class="s2">) kvs=(</span><span class="si">{</span><span class="n">kV_DT</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">kV_DT</span><span class="si">}</span><span class="s2">) &quot;</span> \
                                  <span class="sa">f</span><span class="s2">&quot;kvas=(</span><span class="si">{</span><span class="n">kVA</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">kVA</span><span class="si">}</span><span class="s2">) xhl=0.001 wdg=1 %r=0.001 wdg=2 %r=0.001 Maxtap=1.1 Mintap=0.9 &quot;</span> \
                                  <span class="sa">f</span><span class="s2">&quot;enabled=True&quot;</span>
        <span class="n">property_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;phases&quot;</span><span class="p">,</span> <span class="s2">&quot;windings&quot;</span><span class="p">,</span> <span class="s2">&quot;buses&quot;</span><span class="p">,</span> <span class="s2">&quot;conns&quot;</span><span class="p">,</span> <span class="s2">&quot;kvs&quot;</span><span class="p">,</span> <span class="s2">&quot;kvas&quot;</span><span class="p">,</span> <span class="s2">&quot;xhl&quot;</span><span class="p">,</span> <span class="s2">&quot;%Rs&quot;</span><span class="p">,</span> <span class="s2">&quot;Maxtap&quot;</span><span class="p">,</span> <span class="s2">&quot;Mintap&quot;</span><span class="p">]</span>
        <span class="n">edit_line_command_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Edit Line.</span><span class="si">{</span><span class="n">chosen_line_info</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> bus1=</span><span class="si">{</span><span class="n">new_node</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># If not subltc: For regulator, transformer will be placed after line. (i.e. new node will be created after bus2)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># if there are more than one lines at a node, then iterate over them?</span>
        <span class="n">chosen_line_info</span> <span class="o">=</span> <span class="n">all_lines_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">all_lines_df</span><span class="p">[</span><span class="s2">&quot;bus2_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">node</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chosen_line_info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># if no line is connected to the node</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No line is connected to that node </span><span class="si">{</span><span class="n">node</span><span class="si">}</span><span class="s2">. So not placing transformer here.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">chosen_line_info</span> <span class="o">=</span> <span class="n">chosen_line_info</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">new_node</span> <span class="o">=</span> <span class="s2">&quot;newnode_&quot;</span> <span class="o">+</span> <span class="n">chosen_line_info</span><span class="p">[</span><span class="s2">&quot;bus2&quot;</span><span class="p">]</span>  <span class="c1"># contains terminal information too</span>
        <span class="n">new_node_name</span> <span class="o">=</span> <span class="s2">&quot;newnode_&quot;</span> <span class="o">+</span> <span class="n">chosen_line_info</span><span class="p">[</span><span class="s2">&quot;bus2_name&quot;</span><span class="p">]</span>
        <span class="n">curr_time</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="c1"># this is added to name to ensure it is unique</span>
        <span class="n">time_stamp</span> <span class="o">=</span> <span class="n">curr_time</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">curr_time</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">xfmr_name</span> <span class="o">=</span> <span class="s2">&quot;New_xfmr_&quot;</span> <span class="o">+</span> <span class="n">node</span> <span class="o">+</span> <span class="n">time_stamp</span>
        <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">chosen_line_info</span><span class="p">[</span><span class="s2">&quot;bus2_name&quot;</span><span class="p">])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">X</span><span class="p">()</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">Y</span><span class="p">()</span>
        <span class="n">kV_node</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">kVBase</span><span class="p">()</span>
        <span class="c1"># is number of phases &gt; 1</span>
        <span class="k">if</span> <span class="n">chosen_line_info</span><span class="p">[</span><span class="s2">&quot;phases&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">kV_DT</span> <span class="o">=</span> <span class="n">kV_node</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># L-L voltage</span>
        <span class="c1"># for single phase</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kV_DT</span> <span class="o">=</span> <span class="n">kV_node</span>  <span class="c1"># L-N voltage</span>
        <span class="c1"># ideally we would use an auto transformer which would need a much smaller kVA rating</span>
        <span class="n">kVA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kV_DT</span> <span class="o">*</span> <span class="n">chosen_line_info</span><span class="p">[</span><span class="s2">&quot;normamps&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>  <span class="c1"># 10% over sized transformer</span>
        <span class="n">property_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;phases&quot;</span><span class="p">,</span> <span class="s2">&quot;windings&quot;</span><span class="p">,</span> <span class="s2">&quot;buses&quot;</span><span class="p">,</span> <span class="s2">&quot;conns&quot;</span><span class="p">,</span> <span class="s2">&quot;kvs&quot;</span><span class="p">,</span> <span class="s2">&quot;kvas&quot;</span><span class="p">,</span> <span class="s2">&quot;xhl&quot;</span><span class="p">,</span> <span class="s2">&quot;%Rs&quot;</span><span class="p">,</span> <span class="s2">&quot;Maxtap&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;Mintap&quot;</span><span class="p">]</span>
        <span class="n">new_xfmr_command_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">action_type</span><span class="si">}</span><span class="s2"> Transformer.</span><span class="si">{</span><span class="n">xfmr_name</span><span class="si">}</span><span class="s2"> phases=</span><span class="si">{</span><span class="n">chosen_line_info</span><span class="p">[</span><span class="s1">&#39;phases&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span> \
                                  <span class="sa">f</span><span class="s2">&quot;windings=2 buses=(</span><span class="si">{</span><span class="n">new_node</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">chosen_line_info</span><span class="p">[</span><span class="s1">&#39;bus2&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) &quot;</span> \
                                  <span class="sa">f</span><span class="s2">&quot;conns=(wye,wye) kvs=(</span><span class="si">{</span><span class="n">kV_DT</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">kV_DT</span><span class="si">}</span><span class="s2">) kvas=(</span><span class="si">{</span><span class="n">kVA</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">kVA</span><span class="si">}</span><span class="s2">) xhl=0.001 &quot;</span> \
                                  <span class="sa">f</span><span class="s2">&quot;wdg=1 %r=0.001 wdg=2 %r=0.001 Maxtap=1.1 Mintap=0.9 enabled=True&quot;</span>
        <span class="n">edit_line_command_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Edit Line.</span><span class="si">{</span><span class="n">chosen_line_info</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> bus2=</span><span class="si">{</span><span class="n">new_node</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">check_dss_run_command</span><span class="p">(</span><span class="n">edit_line_command_string</span><span class="p">)</span>
    <span class="n">check_dss_run_command</span><span class="p">(</span><span class="n">new_xfmr_command_string</span><span class="p">)</span>
    <span class="c1"># Update system admittance matrix</span>
    <span class="n">check_dss_run_command</span><span class="p">(</span><span class="s2">&quot;CalcVoltageBases&quot;</span><span class="p">)</span>
    <span class="c1"># update coordinates of new node</span>
    <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">new_node_name</span><span class="p">)</span>
    <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="n">commands_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edit_line_command_string</span><span class="p">)</span>
    <span class="n">commands_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_xfmr_command_string</span><span class="p">)</span>
    <span class="n">commands_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;// new node added </span><span class="si">{</span><span class="n">new_node</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">circuit_solve_and_check</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">info_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;commands_list&#39;</span><span class="p">:</span> <span class="n">commands_list</span><span class="p">,</span> <span class="s1">&#39;new_xfmr_name&#39;</span><span class="p">:</span> <span class="n">xfmr_name</span><span class="p">,</span>
                 <span class="s1">&#39;modified_line_name&#39;</span><span class="p">:</span> <span class="n">chosen_line_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]}</span>
    <span class="k">return</span> <span class="n">info_dict</span></div>


<div class="viewcode-block" id="disable_new_xfmr_and_edit_line"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.disable_new_xfmr_and_edit_line">[docs]</a><span class="k">def</span> <span class="nf">disable_new_xfmr_and_edit_line</span><span class="p">(</span><span class="n">transformer_name_to_disable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">line_name_to_modify</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function disables an added transformer in the feeder.</span>
<span class="sd">    since OpenDSS disables by transformer by opening the circuit instead of creating a short circuit,</span>
<span class="sd">    this function will remove the transformer by first disabling it, then it will connect the line properly to</span>
<span class="sd">    remove the islands. (note: we cant remove the element definition completely)</span>
<span class="sd">    Substation will always have a xfmr by this point so only regulator transformers have to be removed</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    transformer_name</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">commands_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># for regulators, added transformer is always placed after the line (i.e. after &#39;to&#39; node of line)</span>
    <span class="c1"># i.e. for this transformer: primary bus: newly created node, secondary bus: existing node</span>
    <span class="n">all_xfmr_df</span> <span class="o">=</span> <span class="n">get_all_transformer_info</span><span class="p">()</span>
    <span class="n">all_xfmr_df</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_xfmr_df</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">chosen_xfmr</span> <span class="o">=</span> <span class="n">all_xfmr_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">all_xfmr_df</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">transformer_name_to_disable</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chosen_xfmr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Transformer to be removed does not exist&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">chosen_xfmr</span> <span class="o">=</span> <span class="n">chosen_xfmr</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">xfmr_prim_bus</span> <span class="o">=</span> <span class="n">chosen_xfmr</span><span class="p">[</span><span class="s1">&#39;buses&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">xfmr_sec_bus</span> <span class="o">=</span> <span class="n">chosen_xfmr</span><span class="p">[</span><span class="s1">&#39;buses&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># contains terminal information as well</span>

    <span class="c1"># disable xfmr and edit xfmr buses to be the same (primary bus). (This is because primary bus was the new node)</span>
    <span class="n">command_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Edit Transformer.</span><span class="si">{</span><span class="n">transformer_name_to_disable</span><span class="si">}</span><span class="s2"> enabled=False&quot;</span>
    <span class="n">check_dss_run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
    <span class="n">commands_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
    <span class="n">command_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Edit Transformer.</span><span class="si">{</span><span class="n">transformer_name_to_disable</span><span class="si">}</span><span class="s2"> buses=(</span><span class="si">{</span><span class="n">xfmr_prim_bus</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">xfmr_prim_bus</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="n">check_dss_run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
    <span class="n">commands_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>

    <span class="c1"># edit line, so its &#39;to&#39; node (i.e. bus2) is set back to the previous existing node</span>
    <span class="c1"># this node used to be the xfmr sec node, so in this way, the xfmr is removed, and line is directly connected to circuit</span>
    <span class="n">command_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Edit Line.</span><span class="si">{</span><span class="n">line_name_to_modify</span><span class="si">}</span><span class="s2"> bus2=</span><span class="si">{</span><span class="n">xfmr_sec_bus</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">commands_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
    <span class="n">check_dss_run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
    <span class="c1"># Update system admittance matrix</span>
    <span class="n">check_dss_run_command</span><span class="p">(</span><span class="s2">&quot;CalcVoltageBases&quot;</span><span class="p">)</span>
    <span class="n">circuit_solve_and_check</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">commands_list</span></div>


<div class="viewcode-block" id="add_new_regcontrol_at_node"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.add_new_regcontrol_at_node">[docs]</a><span class="k">def</span> <span class="nf">add_new_regcontrol_at_node</span><span class="p">(</span><span class="n">node</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_regcontrol_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nominal_voltage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function adds a new regcontrol at a node. It identifies the correct transformer and places regcontrol there.</span>
<span class="sd">    Identify whether or not a reg contrl exists at the transformer connected to this bus - if not, place new regcontrol</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    node</span>
<span class="sd">    default_regcontrol_settings</span>
<span class="sd">    nominal_voltage</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">all_xfmr_df</span> <span class="o">=</span> <span class="n">get_all_transformer_info</span><span class="p">()</span>
    <span class="n">temp_df</span> <span class="o">=</span> <span class="n">all_xfmr_df</span><span class="p">[</span><span class="s1">&#39;bus_names_only&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span>
    <span class="n">all_xfmr_df</span><span class="p">[</span><span class="s2">&quot;primary_bus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">all_xfmr_df</span><span class="p">[</span><span class="s2">&quot;secondary_bus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">chosen_xfmr</span> <span class="o">=</span> <span class="n">all_xfmr_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">all_xfmr_df</span><span class="p">[</span><span class="s1">&#39;primary_bus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">node</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">all_xfmr_df</span><span class="p">[</span><span class="s1">&#39;secondary_bus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">node</span><span class="p">)]</span>
    <span class="c1"># if transformer does not exist on node</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chosen_xfmr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Transformer needs to exist at node </span><span class="si">{</span><span class="n">node</span><span class="si">}</span><span class="s2"> in order to place regulator control.&quot;</span><span class="p">)</span>
    <span class="n">chosen_xfmr</span> <span class="o">=</span> <span class="n">chosen_xfmr</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">regcontrols_df</span> <span class="o">=</span> <span class="n">get_regcontrol_info</span><span class="p">()</span>
    <span class="n">enabled_regcontrols_df</span> <span class="o">=</span> <span class="n">regcontrols_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">regcontrols_df</span><span class="p">[</span><span class="s1">&#39;enabled&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span>
    <span class="n">enabled_regcontrol_exists</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">enabled_regcontrols_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">enabled_regcontrols_df</span><span class="p">[</span><span class="s1">&#39;transformer_bus1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">node</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span>
        <span class="n">enabled_regcontrols_df</span><span class="p">[</span><span class="s1">&#39;transformer_bus2&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">node</span><span class="p">)])</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">enabled_regcontrol_exists</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># if enabled regcontrol does not exist on transformer</span>
        <span class="c1"># this runs the command and returns the command list</span>
        <span class="n">new_regcontrol_dict</span> <span class="o">=</span> <span class="n">add_new_regcontrol_command</span><span class="p">(</span><span class="n">xfmr_info_series</span><span class="o">=</span><span class="n">chosen_xfmr</span><span class="p">,</span> <span class="n">default_regcontrol_settings</span><span class="o">=</span><span class="n">default_regcontrol_settings</span><span class="p">,</span>
                                                         <span class="n">nominal_voltage</span><span class="o">=</span><span class="n">nominal_voltage</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_regcontrol_dict</span></div>


<div class="viewcode-block" id="add_bus_nodes"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.add_bus_nodes">[docs]</a><span class="k">def</span> <span class="nf">add_bus_nodes</span><span class="p">(</span><span class="n">G</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bus_coordinates_df</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">buses_list</span> <span class="o">=</span> <span class="n">bus_coordinates_df</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">buses_list</span><span class="p">:</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;bus_name&#39;</span><span class="p">],</span> <span class="n">pos</span><span class="o">=</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;x_coordinate&#39;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;y_coordinate&#39;</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">G</span></div>


<div class="viewcode-block" id="extract_common_element_from_lists"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.extract_common_element_from_lists">[docs]</a><span class="k">def</span> <span class="nf">extract_common_element_from_lists</span><span class="p">(</span><span class="n">list_of_lists</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># common element extraction from multiple lists</span>
    <span class="n">common_element_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="n">list_of_lists</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">common_element_list</span></div>


<div class="viewcode-block" id="identify_common_upstream_nodes"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.identify_common_upstream_nodes">[docs]</a><span class="k">def</span> <span class="nf">identify_common_upstream_nodes</span><span class="p">(</span><span class="n">G</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buses_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; In this function the very first common upstream node and all upstream nodes for the members of the</span>
<span class="sd">    cluster are identified</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    G</span>
<span class="sd">    buses_list</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># notes: can include some type of optimization - such as look at multiple upstream nodes and place where sum of</span>
    <span class="c1"># downstream node voltage deviations is minimum as long as it doesn&#39;t overlap with other clusters</span>
    <span class="c1"># Currently it only identifies the common upstream nodes for all buses in the list</span>
    <span class="c1"># for one cluster:</span>
    <span class="n">bus_ancestors</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># iterating over each bus in the cluster to get ancestors (upstream nodes) of each bus</span>
    <span class="k">for</span> <span class="n">bus</span> <span class="ow">in</span> <span class="n">buses_list</span><span class="p">:</span>
        <span class="n">bus_ancestors</span><span class="p">[</span><span class="n">bus</span><span class="p">]</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">ancestors</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">bus</span><span class="p">)</span>
    <span class="c1"># extract common upstream nodes for all buses in this cluster</span>
    <span class="n">common_nodes_list</span> <span class="o">=</span> <span class="n">extract_common_element_from_lists</span><span class="p">(</span><span class="n">list_of_lists</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">bus_ancestors</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="k">return</span> <span class="n">common_nodes_list</span></div>


<div class="viewcode-block" id="test_new_regulator_placement_on_common_nodes"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.test_new_regulator_placement_on_common_nodes">[docs]</a><span class="k">def</span> <span class="nf">test_new_regulator_placement_on_common_nodes</span><span class="p">(</span><span class="n">voltage_upper_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">voltage_lower_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nominal_voltage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                 <span class="n">common_upstream_nodes_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">circuit_source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                 <span class="n">default_regcontrol_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; In each cluster group, place a new regulator control at each common upstream node, unless it is the source bus</span>
<span class="sd">    (since that already contains the LTC) or if it has a distribution transformer.</span>

<span class="sd">    If a transformer exists, simply add a new reg control -</span>
<span class="sd">    in fact calling the add_new_regctrl function will automatically check whether a reg control exists or not</span>
<span class="sd">    -  so only thing to be ensured is that a transformer should exist.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    voltage_upper_limit</span>
<span class="sd">    common_upstream_nodes_dict</span>
<span class="sd">    circuit_source</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">deciding_field</span> <span class="o">=</span> <span class="s1">&#39;deviation_severity&#39;</span>
    <span class="n">intra_cluster_group_severity_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">common_upstream_nodes_list</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="c1"># do not add a new reg control to source bus as it already has a LTC</span>
        <span class="k">if</span> <span class="n">node</span> <span class="o">==</span> <span class="n">circuit_source</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="n">all_xfmr_df</span> <span class="o">=</span> <span class="n">get_all_transformer_info</span><span class="p">()</span>
        <span class="n">temp_df</span> <span class="o">=</span> <span class="n">all_xfmr_df</span><span class="p">[</span><span class="s1">&#39;bus_names_only&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span>
        <span class="n">all_xfmr_df</span><span class="p">[</span><span class="s2">&quot;primary_bus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">all_xfmr_df</span><span class="p">[</span><span class="s2">&quot;secondary_bus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="c1"># if transformer is already present at this node, skip. This is because:</span>
        <span class="c1"># These pre-existing xfmrs will be &quot;primary to secondary DTs&quot; which we do not want to control.</span>
        <span class="c1"># Regulators are primarily in line and not on individual distribution transformers</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_xfmr_df</span><span class="p">[</span><span class="n">all_xfmr_df</span><span class="p">[</span><span class="s2">&quot;primary_bus&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">node</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_xfmr_df</span><span class="p">[</span><span class="n">all_xfmr_df</span><span class="p">[</span><span class="s2">&quot;secondary_bus&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">node</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="c1"># add new transformer at this node</span>
        <span class="n">new_xfmr_added_dict</span> <span class="o">=</span> <span class="n">add_new_node_and_xfmr</span><span class="p">(</span>
            <span class="n">action_type</span><span class="o">=</span><span class="s1">&#39;New&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="n">node</span><span class="p">,</span> <span class="n">circuit_source</span><span class="o">=</span><span class="n">circuit_source</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_xfmr_added_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># if new elements were not added, continue</span>
            <span class="k">continue</span>
        <span class="c1"># add new regulator control at this node</span>
        <span class="c1"># These are just default settings and do not have to be written in the output file</span>
        <span class="n">new_regcontrol_dict</span> <span class="o">=</span> <span class="n">add_new_regcontrol_at_node</span><span class="p">(</span><span class="n">node</span><span class="o">=</span><span class="n">node</span><span class="p">,</span> <span class="n">default_regcontrol_settings</span><span class="o">=</span><span class="n">default_regcontrol_settings</span><span class="p">,</span>
                                                         <span class="n">nominal_voltage</span><span class="o">=</span><span class="n">nominal_voltage</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_regcontrol_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">new_xfmr_added_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">disable_new_xfmr_and_edit_line</span><span class="p">(</span><span class="n">transformer_name_to_disable</span><span class="o">=</span><span class="n">new_xfmr_added_dict</span><span class="p">[</span><span class="s1">&#39;new_xfmr_name&#39;</span><span class="p">],</span>
                                               <span class="n">line_name_to_modify</span><span class="o">=</span><span class="n">new_xfmr_added_dict</span><span class="p">[</span><span class="s1">&#39;modified_line_name&#39;</span><span class="p">])</span>
            <span class="k">continue</span>
        <span class="n">intra_cluster_group_severity_dict</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">intra_cluster_group_severity_dict</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;add_new_devices_command_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_xfmr_added_dict</span><span class="p">[</span><span class="s1">&#39;commands_list&#39;</span><span class="p">]</span> <span class="o">+</span> \
            <span class="n">new_regcontrol_dict</span><span class="p">[</span><span class="s1">&#39;command_list&#39;</span><span class="p">]</span>
        <span class="n">pass_flag</span> <span class="o">=</span> <span class="n">circuit_solve_and_check</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">intra_cluster_group_severity_dict</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;converged&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pass_flag</span>
        <span class="n">severity_dict</span> <span class="o">=</span> <span class="n">compute_voltage_violation_severity</span><span class="p">(</span>
            <span class="n">voltage_upper_limit</span><span class="o">=</span><span class="n">voltage_upper_limit</span><span class="p">,</span> <span class="n">voltage_lower_limit</span><span class="o">=</span><span class="n">voltage_lower_limit</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">intra_cluster_group_severity_dict</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">severity_dict</span><span class="p">)</span>
        <span class="n">intra_cluster_group_severity_dict</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;new_xfmr_name&#39;</span><span class="p">:</span> <span class="n">new_xfmr_added_dict</span><span class="p">[</span><span class="s1">&#39;new_xfmr_name&#39;</span><span class="p">],</span> <span class="s1">&#39;modified_line_name&#39;</span><span class="p">:</span> <span class="n">new_xfmr_added_dict</span><span class="p">[</span><span class="s1">&#39;modified_line_name&#39;</span><span class="p">],</span>
                                                        <span class="s1">&#39;new_regcontrol_name&#39;</span><span class="p">:</span> <span class="n">new_regcontrol_dict</span><span class="p">[</span><span class="s1">&#39;new_regcontrol_name&#39;</span><span class="p">]})</span>
        <span class="c1"># Now disable the added regulator control and remove the added transformer</span>
        <span class="n">command_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Edit RegControl.</span><span class="si">{</span><span class="n">new_regcontrol_dict</span><span class="p">[</span><span class="s1">&#39;new_regcontrol_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> enabled=No&quot;</span>
        <span class="n">check_dss_run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
        <span class="n">intra_cluster_group_severity_dict</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;disable_new_devices_command_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">disable_new_xfmr_and_edit_line</span><span class="p">(</span><span class="n">transformer_name_to_disable</span><span class="o">=</span><span class="n">new_xfmr_added_dict</span><span class="p">[</span><span class="s1">&#39;new_xfmr_name&#39;</span><span class="p">],</span>
                                                                                                                     <span class="n">line_name_to_modify</span><span class="o">=</span><span class="n">new_xfmr_added_dict</span><span class="p">[</span>
                                                                                                                         <span class="s1">&#39;modified_line_name&#39;</span><span class="p">],</span>
                                                                                                                     <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># For a given list of common nodes in a cluster, identify the node which leads to minimum number of violations</span>
    <span class="n">deciding_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">intra_cluster_group_severity_dict</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">deciding_df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># If no nodes is found break the loop and go to next number of clusters</span>
        <span class="n">chosen_node</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">deciding_df</span> <span class="o">=</span> <span class="n">deciding_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">deciding_df</span><span class="p">[</span><span class="s1">&#39;converged&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span>
    <span class="n">chosen_node</span> <span class="o">=</span> <span class="n">deciding_df</span><span class="p">[</span><span class="n">deciding_field</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>  <span class="c1"># node with minimum violations severity</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Node with minimum violation </span><span class="si">{</span><span class="n">deciding_field</span><span class="si">}</span><span class="s2"> is: </span><span class="si">{</span><span class="n">chosen_node</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Since this is an optimal location add the transformer here - this transformer will stay as long as</span>
    <span class="c1"># clustering_option_number (num_clusters) does not increment. If this parameter changes then all devices at nodes mentioned</span>
    <span class="c1"># should be disabled</span>
    <span class="n">add_new_node_and_xfmr</span><span class="p">(</span><span class="n">node</span><span class="o">=</span><span class="n">chosen_node</span><span class="p">,</span> <span class="n">circuit_source</span><span class="o">=</span><span class="n">circuit_source</span><span class="p">,</span> <span class="n">action_type</span><span class="o">=</span><span class="s1">&#39;New&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">chosen_node_dict</span> <span class="o">=</span> <span class="n">intra_cluster_group_severity_dict</span><span class="p">[</span><span class="n">chosen_node</span><span class="p">]</span>
    <span class="n">chosen_node_dict</span><span class="p">[</span><span class="s1">&#39;node&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chosen_node</span>
    <span class="n">command_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Edit RegControl.</span><span class="si">{</span><span class="n">chosen_node_dict</span><span class="p">[</span><span class="s1">&#39;new_regcontrol_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> enabled=True&quot;</span>
    <span class="n">check_dss_run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
    <span class="n">circuit_solve_and_check</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chosen_node_dict</span></div>


<div class="viewcode-block" id="correct_node_coords"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.correct_node_coords">[docs]</a><span class="k">def</span> <span class="nf">correct_node_coords</span><span class="p">(</span><span class="n">G</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">position_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">circuit_source</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;If node doesn&#39;t have node attributes, attach parent or child node&#39;s attributes</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    G</span>
<span class="sd">    position_dict</span>
<span class="sd">    circuit_source</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">new_temp_graph</span> <span class="o">=</span> <span class="n">G</span>
    <span class="n">temp_graph</span> <span class="o">=</span> <span class="n">new_temp_graph</span><span class="o">.</span><span class="n">to_undirected</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">position_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">new_x</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">new_y</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">pred_buses</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">shortest_path</span><span class="p">(</span><span class="n">temp_graph</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">circuit_source</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_buses</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pred_bus</span> <span class="ow">in</span> <span class="n">pred_buses</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pred_bus</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">position_dict</span><span class="p">[</span><span class="n">pred_bus</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">position_dict</span><span class="p">[</span><span class="n">pred_bus</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="n">new_x</span> <span class="o">=</span> <span class="n">position_dict</span><span class="p">[</span><span class="n">pred_bus</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">new_y</span> <span class="o">=</span> <span class="n">position_dict</span><span class="p">[</span><span class="n">pred_bus</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">G</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_x</span><span class="p">,</span> <span class="n">new_y</span><span class="p">]</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="n">new_x</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">new_y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Since either predecessor nodes were not available or they did not have</span>
                <span class="c1"># non-zero coordinates, try successor nodes</span>
                <span class="c1"># Get a leaf node</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">G</span><span class="o">.</span><span class="n">out_degree</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">G</span><span class="o">.</span><span class="n">in_degree</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">leaf_node</span> <span class="o">=</span> <span class="n">x</span>
                        <span class="k">break</span>
                <span class="n">succ_buses</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">shortest_path</span><span class="p">(</span><span class="n">temp_graph</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">leaf_node</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">succ_buses</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">pred_bus</span> <span class="ow">in</span> <span class="n">succ_buses</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">pred_bus</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">position_dict</span><span class="p">[</span><span class="n">pred_bus</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">position_dict</span><span class="p">[</span><span class="n">pred_bus</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                            <span class="n">new_x</span> <span class="o">=</span> <span class="n">position_dict</span><span class="p">[</span><span class="n">pred_bus</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">new_y</span> <span class="o">=</span> <span class="n">position_dict</span><span class="p">[</span><span class="n">pred_bus</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">G</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_x</span><span class="p">,</span> <span class="n">new_y</span><span class="p">]</span>
                            <span class="k">break</span>
    <span class="c1"># Update position dict with new coordinates</span>
    <span class="n">position_dict</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">get_node_attributes</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s1">&#39;pos&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">G</span><span class="p">,</span> <span class="n">position_dict</span></div>


<div class="viewcode-block" id="get_full_distance_df"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.get_full_distance_df">[docs]</a><span class="k">def</span> <span class="nf">get_full_distance_df</span><span class="p">(</span><span class="n">upper_triang_paths_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function creates full distance dictionary as a square array from the upper triangular dictionary.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    upper_triang_paths_dict</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">square_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">temp_nodes_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># find max length in upper trianguler dict. This defines size of array</span>
    <span class="n">max_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">upper_triang_paths_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())])</span>
    <span class="c1"># Create a square dict with zeros for lower triangle values</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">upper_triang_paths_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">temp_nodes_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">temp_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_length</span><span class="p">:</span>
            <span class="n">new_items_req</span> <span class="o">=</span> <span class="n">max_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">items_cnt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">new_items_req</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">temp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="n">temp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
        <span class="n">square_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_list</span>
    <span class="c1"># # from dict create a list of lists</span>
    <span class="n">list_of_lists</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">square_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">list_of_lists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="c1"># Create numpy array from list of lists</span>
    <span class="n">square_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">list_of_lists</span><span class="p">)</span>
    <span class="c1"># Replace lower triangle zeros with upper triangle values</span>
    <span class="n">square_array</span> <span class="o">=</span> <span class="n">square_array</span> <span class="o">+</span> <span class="n">square_array</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">square_array</span><span class="p">))</span>

    <span class="n">square_dist_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">square_array</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">upper_triang_paths_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                                  <span class="n">columns</span><span class="o">=</span><span class="n">upper_triang_paths_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">square_dist_df</span></div>


<div class="viewcode-block" id="generate_edges"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.generate_edges">[docs]</a><span class="k">def</span> <span class="nf">generate_edges</span><span class="p">(</span><span class="n">G</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;All lines, switches, reclosers etc are modeled as lines, so calling lines takes care of all of them.</span>
<span class="sd">    However we also need to loop over transformers as they form the edge between primary and secondary nodes</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    G</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">length_conversion_to_metre</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;mi&quot;</span><span class="p">:</span> <span class="mf">1609.34</span><span class="p">,</span>
        <span class="s2">&quot;kft&quot;</span><span class="p">:</span> <span class="mf">304.8</span><span class="p">,</span>
        <span class="s2">&quot;km&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="s2">&quot;ft&quot;</span><span class="p">:</span> <span class="mf">0.3048</span><span class="p">,</span>
        <span class="s2">&quot;in&quot;</span><span class="p">:</span> <span class="mf">0.0254</span><span class="p">,</span>
        <span class="s2">&quot;cm&quot;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
        <span class="s2">&quot;m&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># prepare lines dataframe</span>
    <span class="n">all_lines_df</span> <span class="o">=</span> <span class="n">get_all_line_info</span><span class="p">()</span>
    <span class="n">all_lines_df</span><span class="p">[</span><span class="s1">&#39;bus1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_lines_df</span><span class="p">[</span><span class="s1">&#39;bus1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">all_lines_df</span><span class="p">[</span><span class="s1">&#39;bus2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_lines_df</span><span class="p">[</span><span class="s1">&#39;bus2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">all_lines_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">length</span> <span class="o">*</span> <span class="n">length_conversion_to_metre</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">units</span><span class="p">])</span>
    <span class="n">all_lines_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">length_conversion_to_metre</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]])</span>
    <span class="n">all_lines_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="c1"># convert length to metres</span>

    <span class="n">all_lines_df</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
    <span class="n">all_xfmrs_df</span> <span class="o">=</span> <span class="n">get_all_transformer_info</span><span class="p">()</span>

    <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">from_bus</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Bus1</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">to_bus</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Bus2</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">phases</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Phases</span><span class="p">()</span>
        <span class="n">length</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Length</span><span class="p">()</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">from_bus</span><span class="p">,</span> <span class="n">to_bus</span><span class="p">,</span> <span class="n">phases</span><span class="o">=</span><span class="n">phases</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">bus_names</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()</span>
        <span class="n">from_bus</span> <span class="o">=</span> <span class="n">bus_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">to_bus</span> <span class="o">=</span> <span class="n">bus_names</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">phases</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">NumPhases</span><span class="p">()</span>
        <span class="n">length</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">from_bus</span><span class="p">,</span> <span class="n">to_bus</span><span class="p">,</span> <span class="n">phases</span><span class="o">=</span><span class="n">phases</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">G</span></div>


<div class="viewcode-block" id="get_upper_triangular_dist"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.get_upper_triangular_dist">[docs]</a><span class="k">def</span> <span class="nf">get_upper_triangular_dist</span><span class="p">(</span><span class="n">G</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buses_with_violations</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Identify shortest dijkstra paths between all buses with violations.</span>
<span class="sd">    Returns a dictionary of nodes with distances to other nodes (only upper triangular)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    G</span>
<span class="sd">    buses_with_violations</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_graph</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">to_undirected</span><span class="p">()</span>
    <span class="n">calculated_buses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">upper_triang_paths_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Get upper triangular distance matrix - reduces computational time by half</span>
    <span class="k">for</span> <span class="n">bus1</span> <span class="ow">in</span> <span class="n">buses_with_violations</span><span class="p">:</span>
        <span class="n">upper_triang_paths_dict</span><span class="p">[</span><span class="n">bus1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">bus_n</span> <span class="ow">in</span> <span class="n">buses_with_violations</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bus_n</span> <span class="o">==</span> <span class="n">bus1</span><span class="p">:</span>
                <span class="n">path_length</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">elif</span> <span class="n">bus_n</span> <span class="ow">in</span> <span class="n">calculated_buses</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># path = nx.dijkstra_path(new_graph, source=bus1, target=bus_n, weight=&#39;length&#39;)</span>
                <span class="n">path_length</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">dijkstra_path_length</span><span class="p">(</span><span class="n">new_graph</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">bus1</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">bus_n</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;length&#39;</span><span class="p">)</span>
            <span class="n">upper_triang_paths_dict</span><span class="p">[</span><span class="n">bus1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">path_length</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">calculated_buses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bus1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">upper_triang_paths_dict</span></div>


<div class="viewcode-block" id="perform_clustering"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.perform_clustering">[docs]</a><span class="k">def</span> <span class="nf">perform_clustering</span><span class="p">(</span><span class="n">num_clusters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">square_distance_array</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buses_with_violations</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function performs clustering and returns a dictionary with cluster_number as key and</span>
<span class="sd">    list of buses in each cluster as values.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    num_clusters</span>
<span class="sd">    square_array</span>
<span class="sd">    buses_with_violations</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">clusters_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">AgglomerativeClustering</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">num_clusters</span><span class="p">,</span> <span class="n">affinity</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">,</span> <span class="n">linkage</span><span class="o">=</span><span class="s1">&#39;ward&#39;</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">square_distance_array</span><span class="p">)</span>
    <span class="n">labels_list</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">labels_</span>
    <span class="c1"># create a dictionary containing cluster_number as keys, and list of buses in that cluster as values</span>
    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels_list</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">labels_list</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clusters_dict</span><span class="p">:</span>
            <span class="n">clusters_dict</span><span class="p">[</span><span class="n">labels_list</span><span class="p">[</span><span class="n">label</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">buses_with_violations</span><span class="p">[</span><span class="n">label</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clusters_dict</span><span class="p">[</span><span class="n">labels_list</span><span class="p">[</span><span class="n">label</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">buses_with_violations</span><span class="p">[</span><span class="n">label</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">clusters_dict</span></div>


<div class="viewcode-block" id="per_cluster_group_regulator_analysis"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.per_cluster_group_regulator_analysis">[docs]</a><span class="k">def</span> <span class="nf">per_cluster_group_regulator_analysis</span><span class="p">(</span><span class="n">G</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buses_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">voltage_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                         <span class="n">voltage_upper_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">voltage_lower_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_regcontrol_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                         <span class="n">circuit_source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function performs analysis on one cluster group of buses with violations. </span>
<span class="sd">    It determines the common upstream buses for all the buses with violations in that cluster group. </span>
<span class="sd">    It places regulators on each of these common noeds, and determines the best node to place the regulator for that group.</span>
<span class="sd">    Also determines the best reg control settings with this newly added regulator.</span>

<span class="sd">    Args:</span>
<span class="sd">        G (_type_, optional): _description_. Defaults to None.</span>
<span class="sd">        cluster_id (_type_, optional): _description_. Defaults to None.</span>
<span class="sd">        buses_list (_type_, optional): _description_. Defaults to None.</span>
<span class="sd">        voltage_config (_type_, optional): _description_. Defaults to None.</span>
<span class="sd">        voltage_upper_limit (_type_, optional): _description_. Defaults to None.</span>
<span class="sd">        voltage_lower_limit (_type_, optional): _description_. Defaults to None.</span>
<span class="sd">        default_regcontrol_settings (_type_, optional): _description_. Defaults to None.</span>
<span class="sd">        circuit_source (_type_, optional): _description_. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        _type_: _description_</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cluster_group_info_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">nominal_voltage</span> <span class="o">=</span> <span class="n">voltage_config</span><span class="p">[</span><span class="s1">&#39;nominal_voltage&#39;</span><span class="p">]</span>
    <span class="c1"># this identifies common upstream nodes for all buses with violations in a given cluster</span>
    <span class="c1"># these common upstream nodes are where regulator control can be placed</span>
    <span class="n">common_upstream_nodes_list</span> <span class="o">=</span> <span class="n">identify_common_upstream_nodes</span><span class="p">(</span><span class="n">G</span><span class="o">=</span><span class="n">G</span><span class="p">,</span> <span class="n">buses_list</span><span class="o">=</span><span class="n">buses_list</span><span class="p">)</span>
    <span class="n">cluster_group_info_dict</span><span class="p">[</span><span class="s1">&#39;common_upstream_nodes_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">common_upstream_nodes_list</span>
    <span class="c1"># this adds new regulator on each common node (one at a time)</span>
    <span class="n">chosen_node_dict</span> <span class="o">=</span> <span class="n">test_new_regulator_placement_on_common_nodes</span><span class="p">(</span><span class="n">voltage_upper_limit</span><span class="o">=</span><span class="n">voltage_upper_limit</span><span class="p">,</span> <span class="n">voltage_lower_limit</span><span class="o">=</span><span class="n">voltage_lower_limit</span><span class="p">,</span>
                                                                    <span class="n">nominal_voltage</span><span class="o">=</span><span class="n">nominal_voltage</span><span class="p">,</span>
                                                                    <span class="n">common_upstream_nodes_list</span><span class="o">=</span><span class="n">common_upstream_nodes_list</span><span class="p">,</span> <span class="n">circuit_source</span><span class="o">=</span><span class="n">circuit_source</span><span class="p">,</span>
                                                                    <span class="n">default_regcontrol_settings</span><span class="o">=</span><span class="n">default_regcontrol_settings</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">chosen_node_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># if there is no common node on which regulator can be placed (for this cluster group)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">cluster_group_info_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">chosen_node_dict</span><span class="p">)</span>
    <span class="n">write_flag</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># choose best settings for all regulators (with new regulator added)</span>
    <span class="n">init_regcontrols_df</span> <span class="o">=</span> <span class="n">get_regcontrol_info</span><span class="p">(</span><span class="n">correct_PT_ratio</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nominal_voltage</span><span class="o">=</span><span class="n">nominal_voltage</span><span class="p">)</span>
    <span class="n">regcontrol_sweep_df</span> <span class="o">=</span> <span class="n">sweep_regcontrol_settings</span><span class="p">(</span><span class="n">voltage_config</span><span class="o">=</span><span class="n">voltage_config</span><span class="p">,</span> <span class="n">initial_regcontrols_df</span><span class="o">=</span><span class="n">init_regcontrols_df</span><span class="p">,</span>
                                                    <span class="n">voltage_upper_limit</span><span class="o">=</span><span class="n">voltage_upper_limit</span><span class="p">,</span> <span class="n">voltage_lower_limit</span><span class="o">=</span><span class="n">voltage_lower_limit</span><span class="p">,</span>
                                                    <span class="n">exclude_sub_ltc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">only_sub_ltc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">regcontrols_df</span><span class="p">,</span> <span class="n">regcontrol_settings_commands_list</span> <span class="o">=</span> <span class="n">choose_best_regcontrol_sweep_setting</span><span class="p">(</span>
        <span class="n">regcontrol_sweep_df</span><span class="o">=</span><span class="n">regcontrol_sweep_df</span><span class="p">,</span> <span class="n">initial_regcontrols_df</span><span class="o">=</span><span class="n">init_regcontrols_df</span><span class="p">,</span> <span class="n">exclude_sub_ltc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">only_sub_ltc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="c1"># determine violation severity after changes</span>
    <span class="n">severity_dict</span> <span class="o">=</span> <span class="n">compute_voltage_violation_severity</span><span class="p">(</span>
        <span class="n">voltage_upper_limit</span><span class="o">=</span><span class="n">voltage_upper_limit</span><span class="p">,</span> <span class="n">voltage_lower_limit</span><span class="o">=</span><span class="n">voltage_lower_limit</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">cluster_group_info_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">severity_dict</span><span class="p">)</span>
    <span class="n">cluster_group_info_dict</span><span class="p">[</span><span class="s1">&#39;settings_commands_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">regcontrol_settings_commands_list</span>

    <span class="k">return</span> <span class="n">cluster_group_info_dict</span></div>


<div class="viewcode-block" id="cluster_and_place_regulator"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.cluster_and_place_regulator">[docs]</a><span class="k">def</span> <span class="nf">cluster_and_place_regulator</span><span class="p">(</span><span class="n">G</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">square_distance_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buses_with_violations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_clusters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">voltage_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">voltage_upper_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">voltage_lower_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">default_regcontrol_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">circuit_source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># this function performs clustering on buses with violations, then iterates through each cluster group, performs regulator placement analysis</span>
    <span class="c1"># Returns the best regulator placement for each cluster group, in the form of a dict</span>

    <span class="c1"># this creates clusters of buses based on distance matrix. So nearby buses are clustered together</span>
    <span class="n">clusters_dict</span> <span class="o">=</span> <span class="n">perform_clustering</span><span class="p">(</span><span class="n">square_distance_array</span><span class="o">=</span><span class="n">square_distance_df</span><span class="p">,</span> <span class="n">num_clusters</span><span class="o">=</span><span class="n">num_clusters</span><span class="p">,</span>
                                       <span class="n">buses_with_violations</span><span class="o">=</span><span class="n">buses_with_violations</span><span class="p">)</span>
    <span class="n">cluster_group_info_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># iterate through each cluster group</span>
    <span class="k">for</span> <span class="n">cluster_id</span><span class="p">,</span> <span class="n">buses_list</span> <span class="ow">in</span> <span class="n">clusters_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cluster group: </span><span class="si">{</span><span class="n">cluster_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">cluster_group_info_dict</span><span class="p">[</span><span class="n">cluster_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">per_cluster_group_regulator_analysis</span><span class="p">(</span><span class="n">G</span><span class="o">=</span><span class="n">G</span><span class="p">,</span> <span class="n">buses_list</span><span class="o">=</span><span class="n">buses_list</span><span class="p">,</span> <span class="n">voltage_config</span><span class="o">=</span><span class="n">voltage_config</span><span class="p">,</span>
                                                                                   <span class="n">voltage_upper_limit</span><span class="o">=</span><span class="n">voltage_upper_limit</span><span class="p">,</span> <span class="n">voltage_lower_limit</span><span class="o">=</span><span class="n">voltage_lower_limit</span><span class="p">,</span> <span class="n">default_regcontrol_settings</span><span class="o">=</span><span class="n">default_regcontrol_settings</span><span class="p">,</span>
                                                                                   <span class="n">circuit_source</span><span class="o">=</span><span class="n">circuit_source</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># determine voltage violations after capacitor changes</span>
        <span class="n">bus_voltages_df</span><span class="p">,</span> <span class="n">undervoltage_bus_list</span><span class="p">,</span> <span class="n">overvoltage_bus_list</span><span class="p">,</span> <span class="n">buses_with_violations</span> <span class="o">=</span> <span class="n">get_bus_voltages</span><span class="p">(</span>
            <span class="n">voltage_upper_limit</span><span class="o">=</span><span class="n">voltage_upper_limit</span><span class="p">,</span> <span class="n">voltage_lower_limit</span><span class="o">=</span><span class="n">voltage_lower_limit</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">buses_with_violations</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All nodal violations have been removed successfully.....quitting&quot;</span><span class="p">)</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="n">cluster_group_info_dict</span></div>


<div class="viewcode-block" id="determine_new_regulator_location"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.determine_new_regulator_location">[docs]</a><span class="k">def</span> <span class="nf">determine_new_regulator_location</span><span class="p">(</span><span class="n">max_regs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">circuit_source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buses_with_violations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                     <span class="n">voltage_upper_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">voltage_lower_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">create_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">voltage_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                     <span class="n">default_regcontrol_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">deciding_field</span> <span class="o">=</span> <span class="s1">&#39;deviation_severity&#39;</span>
    <span class="c1"># prepare for clustering</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">generate_networkx_representation</span><span class="p">(</span><span class="n">create_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">upper_triang_paths_dict</span> <span class="o">=</span> <span class="n">get_upper_triangular_dist</span><span class="p">(</span><span class="n">G</span><span class="o">=</span><span class="n">G</span><span class="p">,</span> <span class="n">buses_with_violations</span><span class="o">=</span><span class="n">buses_with_violations</span><span class="p">)</span>
    <span class="n">square_distance_df</span> <span class="o">=</span> <span class="n">get_full_distance_df</span><span class="p">(</span><span class="n">upper_triang_paths_dict</span><span class="o">=</span><span class="n">upper_triang_paths_dict</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">create_plot</span><span class="p">:</span>
        <span class="n">fig_folder</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fig_folder&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">plot_heatmap_distmatrix</span><span class="p">(</span><span class="n">square_array</span><span class="o">=</span><span class="n">square_distance_df</span><span class="p">,</span> <span class="n">fig_folder</span><span class="o">=</span><span class="n">fig_folder</span><span class="p">)</span>
    <span class="n">cluster_options_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Clustering the distance matrix into clusters equal to optimal clusters</span>
    <span class="c1"># change number of clusters to be considered in the network, and perform analysis.</span>
    <span class="k">for</span> <span class="n">num_clusters</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_regs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">cluster_option_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;cluster_option_</span><span class="si">{</span><span class="n">num_clusters</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Clustering: </span><span class="si">{</span><span class="n">num_clusters</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Clustering option: </span><span class="si">{</span><span class="n">num_clusters</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">temp_dict</span> <span class="o">=</span> <span class="n">cluster_and_place_regulator</span><span class="p">(</span><span class="n">G</span><span class="o">=</span><span class="n">G</span><span class="p">,</span> <span class="n">square_distance_df</span><span class="o">=</span><span class="n">square_distance_df</span><span class="p">,</span>
                                                <span class="n">buses_with_violations</span><span class="o">=</span><span class="n">buses_with_violations</span><span class="p">,</span> <span class="n">num_clusters</span><span class="o">=</span><span class="n">num_clusters</span><span class="p">,</span>
                                                <span class="n">voltage_config</span><span class="o">=</span><span class="n">voltage_config</span><span class="p">,</span> <span class="n">voltage_upper_limit</span><span class="o">=</span><span class="n">voltage_upper_limit</span><span class="p">,</span> <span class="n">voltage_lower_limit</span><span class="o">=</span><span class="n">voltage_lower_limit</span><span class="p">,</span>
                                                <span class="n">default_regcontrol_settings</span><span class="o">=</span><span class="n">default_regcontrol_settings</span><span class="p">,</span> <span class="n">circuit_source</span><span class="o">=</span><span class="n">circuit_source</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">cluster_options_dict</span><span class="p">[</span><span class="n">cluster_option_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cluster_options_dict</span><span class="p">[</span><span class="n">cluster_option_name</span><span class="p">][</span><span class="s2">&quot;details&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_dict</span>
        <span class="n">severity_dict</span> <span class="o">=</span> <span class="n">compute_voltage_violation_severity</span><span class="p">(</span>
            <span class="n">voltage_upper_limit</span><span class="o">=</span><span class="n">voltage_upper_limit</span><span class="p">,</span> <span class="n">voltage_lower_limit</span><span class="o">=</span><span class="n">voltage_lower_limit</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># disable previous clustering option before moving onto next cluster option</span>
        <span class="n">disable_previous_clustering_option</span><span class="p">(</span><span class="n">cluster_group_info_dict</span><span class="o">=</span><span class="n">cluster_options_dict</span><span class="p">[</span><span class="n">cluster_option_name</span><span class="p">][</span><span class="s2">&quot;details&quot;</span><span class="p">])</span>
        <span class="n">cluster_options_dict</span><span class="p">[</span><span class="n">cluster_option_name</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">severity_dict</span><span class="p">)</span>
        <span class="c1"># determine voltage violations after changes</span>
        <span class="n">bus_voltages_df</span><span class="p">,</span> <span class="n">undervoltage_bus_list</span><span class="p">,</span> <span class="n">overvoltage_bus_list</span><span class="p">,</span> <span class="n">buses_with_violations</span> <span class="o">=</span> <span class="n">get_bus_voltages</span><span class="p">(</span>
            <span class="n">voltage_upper_limit</span><span class="o">=</span><span class="n">voltage_upper_limit</span><span class="p">,</span> <span class="n">voltage_lower_limit</span><span class="o">=</span><span class="n">voltage_lower_limit</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">buses_with_violations</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All nodal violations have been removed successfully.....quitting&quot;</span><span class="p">)</span>
            <span class="k">break</span>
    <span class="c1"># choose best clustering option based on severity dict</span>
    <span class="n">deciding_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">cluster_options_dict</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
    <span class="c1"># deciding_df = deciding_df.loc[deciding_df[&#39;converged&#39;] == True]</span>
    <span class="n">chosen_cluster_option</span> <span class="o">=</span> <span class="n">deciding_df</span><span class="p">[</span><span class="n">deciding_field</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
    <span class="n">chosen_cluster_details</span> <span class="o">=</span> <span class="n">cluster_options_dict</span><span class="p">[</span><span class="n">chosen_cluster_option</span><span class="p">][</span><span class="s2">&quot;details&quot;</span><span class="p">]</span>
    <span class="n">new_commands</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">group_num</span> <span class="ow">in</span> <span class="n">chosen_cluster_details</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">chosen_cluster_details</span><span class="p">[</span><span class="n">group_num</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_commands</span> <span class="o">=</span> <span class="n">chosen_cluster_details</span><span class="p">[</span><span class="n">group_num</span><span class="p">][</span><span class="s2">&quot;add_new_devices_command_list&quot;</span><span class="p">]</span> <span class="o">+</span> \
                <span class="n">chosen_cluster_details</span><span class="p">[</span><span class="n">group_num</span><span class="p">][</span><span class="s2">&quot;settings_commands_list&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">new_commands</span></div>


<div class="viewcode-block" id="disable_previous_clustering_option"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.disable_previous_clustering_option">[docs]</a><span class="k">def</span> <span class="nf">disable_previous_clustering_option</span><span class="p">(</span><span class="n">cluster_group_info_dict</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">cluster_id</span> <span class="ow">in</span> <span class="n">cluster_group_info_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">cluster_group_info_dict</span><span class="p">[</span><span class="n">cluster_id</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">command_list</span> <span class="o">=</span> <span class="n">cluster_group_info_dict</span><span class="p">[</span><span class="n">cluster_id</span><span class="p">][</span><span class="s1">&#39;disable_new_devices_command_list&#39;</span><span class="p">]</span>
        <span class="n">dss_run_command_list</span><span class="p">(</span><span class="n">command_list</span><span class="p">)</span>  <span class="c1"># runs each command in this list, in opendss</span>
        <span class="n">dss_solve_and_check</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="plot_heatmap_distmatrix"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.plot_heatmap_distmatrix">[docs]</a><span class="k">def</span> <span class="nf">plot_heatmap_distmatrix</span><span class="p">(</span><span class="n">square_array</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fig_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">square_array</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Distance matrix of nodes with violations&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fig_folder</span><span class="p">,</span> <span class="s2">&quot;Nodal_violations_heatmap.pdf&quot;</span><span class="p">))</span></div>


<div class="viewcode-block" id="plot_feeder"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.plot_feeder">[docs]</a><span class="k">def</span> <span class="nf">plot_feeder</span><span class="p">(</span><span class="n">G</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show_fig</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fig_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">position_dict</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">get_node_attributes</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s1">&#39;pos&#39;</span><span class="p">)</span>
    <span class="n">nodes_list</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">ec</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">position_dict</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">ldn</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">position_dict</span><span class="p">,</span> <span class="n">nodelist</span><span class="o">=</span><span class="n">nodes_list</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                 <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>

    <span class="c1"># ld = nx.draw_networkx_nodes(G, pos=position_dict, nodelist=nodes_list, node_size=6,</span>
    <span class="c1">#                             node_color=&#39;yellow&#39;, alpha=0.7)</span>

    <span class="c1"># nx.draw_networkx_labels(G, pos=position_dict, node_size=1, font_size=15)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Feeder with all customers having DPV systems&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fig_folder</span><span class="p">,</span> <span class="s2">&quot;Feeder.pdf&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">show_fig</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="plot_voltage_violations"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.plot_voltage_violations">[docs]</a><span class="k">def</span> <span class="nf">plot_voltage_violations</span><span class="p">(</span><span class="n">G</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buses_with_violations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fig_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">circuit_source</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">position_dict</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">get_node_attributes</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s1">&#39;pos&#39;</span><span class="p">)</span>
    <span class="n">nodes_list</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span>

    <span class="c1"># convert to undirected</span>
    <span class="n">Un_G</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">to_undirected</span><span class="p">()</span>

    <span class="c1">#plt.figure(figsize=(8, 7))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">numV</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buses_with_violations</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Number of buses in the feeder with voltage violations: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">numV</span><span class="p">))</span>
    <span class="n">ec</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span><span class="n">Un_G</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">position_dict</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">ld</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="n">Un_G</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">position_dict</span><span class="p">,</span> <span class="n">nodelist</span><span class="o">=</span><span class="n">nodes_list</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
    <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="n">Un_G</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">filter_dictionary</span><span class="p">(</span><span class="n">dict_data</span><span class="o">=</span><span class="n">position_dict</span><span class="p">,</span> <span class="n">wanted_keys</span><span class="o">=</span><span class="p">[</span><span class="n">circuit_source</span><span class="p">]),</span>
                           <span class="n">nodelist</span><span class="o">=</span><span class="p">[</span><span class="n">circuit_source</span><span class="p">],</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span>

    <span class="n">buses_with_violations_pos</span> <span class="o">=</span> <span class="n">filter_dictionary</span><span class="p">(</span><span class="n">dict_data</span><span class="o">=</span><span class="n">position_dict</span><span class="p">,</span> <span class="n">wanted_keys</span><span class="o">=</span><span class="n">buses_with_violations</span><span class="p">)</span>
    <span class="c1"># Show buses with violations</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buses_with_violations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="n">Un_G</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">buses_with_violations_pos</span><span class="p">,</span>
                                   <span class="n">nodelist</span><span class="o">=</span><span class="n">buses_with_violations</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fig_folder</span><span class="p">,</span> <span class="s2">&quot;Nodal_voltage_violations_</span><span class="si">{}</span><span class="s2">.pdf&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">numV</span><span class="p">))))</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="plot_thermal_violations"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.plot_thermal_violations">[docs]</a><span class="k">def</span> <span class="nf">plot_thermal_violations</span><span class="p">(</span><span class="n">G</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">edge_size_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">edge_pos_plt_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">edge_to_plt_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">DT_sec_coords</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">DT_sec_lst</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">DT_size_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fig_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">position_dict</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">get_node_attributes</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s1">&#39;pos&#39;</span><span class="p">)</span>
    <span class="n">nodes_list</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span>
    <span class="c1"># convert to undirected</span>
    <span class="n">Un_G</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">to_undirected</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">edge_size_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">de</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span><span class="n">Un_G</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">edge_pos_plt_dict</span><span class="p">,</span> <span class="n">edgelist</span><span class="o">=</span><span class="n">edge_to_plt_dict</span><span class="p">,</span> <span class="n">edge_color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span>
                                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">edge_size_list</span><span class="p">)</span>
    <span class="n">ec</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span><span class="n">Un_G</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">position_dict</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">DT_sec_lst</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="n">Un_G</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">DT_sec_coords</span><span class="p">,</span> <span class="n">nodelist</span><span class="o">=</span><span class="n">DT_sec_lst</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="n">DT_size_list</span><span class="p">,</span>
                                    <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;deeppink&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ldn</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="n">Un_G</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">position_dict</span><span class="p">,</span> <span class="n">nodelist</span><span class="o">=</span><span class="n">nodes_list</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                 <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># nx.draw_networkx_labels(G, pos=pos_dict, node_size=1, font_size=15)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Thermal violations&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fig_folder</span><span class="p">,</span> <span class="s2">&quot;Thermal_violations_</span><span class="si">{}</span><span class="s2">.pdf&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">DT_sec_lst</span><span class="p">)))))</span></div>


<div class="viewcode-block" id="plot_created_clusters"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.plot_created_clusters">[docs]</a><span class="k">def</span> <span class="nf">plot_created_clusters</span><span class="p">(</span><span class="n">G</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clusters_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">upstream_nodes_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">upstream_reg_node</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cluster_nodes_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">optimal_clusters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fig_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
    <span class="c1"># Plots clusters and common paths from clusters to source</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">position_dict</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">get_node_attributes</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s1">&#39;pos&#39;</span><span class="p">)</span>
    <span class="n">ec</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">position_dict</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">ld</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">position_dict</span><span class="p">,</span> <span class="n">nodelist</span><span class="o">=</span><span class="n">cluster_nodes_list</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
    <span class="c1"># Show min V violations</span>
    <span class="n">col</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">clusters_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">nodal_violations_pos</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">common_nodes_pos</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">reg_nodes_pos</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">cluster_nodes</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="n">nodal_violations_pos</span><span class="p">[</span><span class="n">cluster_nodes</span><span class="p">]</span> <span class="o">=</span> <span class="n">position_dict</span><span class="p">[</span><span class="n">cluster_nodes</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">common_nodes</span> <span class="ow">in</span> <span class="n">upstream_nodes_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                <span class="n">common_nodes_pos</span><span class="p">[</span><span class="n">common_nodes</span><span class="p">]</span> <span class="o">=</span> <span class="n">position_dict</span><span class="p">[</span><span class="n">common_nodes</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">upstream_reg_node</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="n">reg_nodes_pos</span><span class="p">[</span><span class="n">upstream_reg_node</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">=</span> <span class="n">position_dict</span><span class="p">[</span><span class="n">upstream_reg_node</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">nodal_violations_pos</span><span class="p">,</span>
                                   <span class="n">nodelist</span><span class="o">=</span><span class="n">values</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;C</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">common_nodes_pos</span><span class="p">,</span>
                                   <span class="n">nodelist</span><span class="o">=</span><span class="n">upstream_nodes_dict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                   <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;C</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">reg_nodes_pos</span><span class="p">,</span>
                                   <span class="n">nodelist</span><span class="o">=</span><span class="p">[</span><span class="n">upstream_reg_node</span><span class="p">[</span><span class="n">key</span><span class="p">]],</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;All buses with violations grouped in </span><span class="si">{}</span><span class="s2"> clusters&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">optimal_clusters</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fig_folder</span><span class="p">,</span> <span class="s2">&quot;Cluster_</span><span class="si">{}</span><span class="s2">_reglocations.pdf&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">optimal_clusters</span><span class="p">))))</span></div>


<div class="viewcode-block" id="add_graph_bus_nodes"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.add_graph_bus_nodes">[docs]</a><span class="k">def</span> <span class="nf">add_graph_bus_nodes</span><span class="p">(</span><span class="n">G</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bus_coordinates_df</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">buses_list</span> <span class="o">=</span> <span class="n">bus_coordinates_df</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">buses_list</span><span class="p">:</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;x_coordinate&#39;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;y_coordinate&#39;</span><span class="p">]]</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;bus_name&#39;</span><span class="p">],</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">G</span></div>


<div class="viewcode-block" id="get_graph_edges_dataframe"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.get_graph_edges_dataframe">[docs]</a><span class="k">def</span> <span class="nf">get_graph_edges_dataframe</span><span class="p">(</span><span class="n">attr_fields</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function adds lines and transformers as edges to the graph</span>
<span class="sd">    All lines, switches, reclosers etc are modeled as lines, so calling lines takes care of all of them.</span>
<span class="sd">   Transformers are also added as edges since they form the edge between primary and secondary nodes</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    G</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">length_conversion_to_metre</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;mi&quot;</span><span class="p">:</span> <span class="mf">1609.34</span><span class="p">,</span>
        <span class="s2">&quot;kft&quot;</span><span class="p">:</span> <span class="mf">304.8</span><span class="p">,</span>
        <span class="s2">&quot;km&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="s2">&quot;ft&quot;</span><span class="p">:</span> <span class="mf">0.3048</span><span class="p">,</span>
        <span class="s2">&quot;in&quot;</span><span class="p">:</span> <span class="mf">0.0254</span><span class="p">,</span>
        <span class="s2">&quot;cm&quot;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
        <span class="s2">&quot;m&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">chosen_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bus1&#39;</span><span class="p">,</span> <span class="s1">&#39;bus2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">attr_fields</span>

    <span class="c1"># prepare lines dataframe</span>
    <span class="n">all_lines_df</span> <span class="o">=</span> <span class="n">get_all_line_info</span><span class="p">()</span>
    <span class="n">all_lines_df</span><span class="p">[</span><span class="s1">&#39;bus1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_lines_df</span><span class="p">[</span><span class="s1">&#39;bus1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">all_lines_df</span><span class="p">[</span><span class="s1">&#39;bus2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_lines_df</span><span class="p">[</span><span class="s1">&#39;bus2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="c1"># convert length to metres</span>
    <span class="n">all_lines_df</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_lines_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">length</span> <span class="o">*</span> <span class="n">length_conversion_to_metre</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">units</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">all_lines_df</span><span class="p">[</span><span class="s1">&#39;equipment_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;line&#39;</span>

    <span class="c1"># prepare transformer dataframe</span>
    <span class="n">all_xfmrs_df</span> <span class="o">=</span> <span class="n">get_all_transformer_info</span><span class="p">()</span>
    <span class="n">all_xfmrs_df</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">all_xfmrs_df</span><span class="p">[</span><span class="s1">&#39;bus1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_xfmrs_df</span><span class="p">[</span><span class="s1">&#39;bus_names_only&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">all_xfmrs_df</span><span class="p">[</span><span class="s1">&#39;bus2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_xfmrs_df</span><span class="p">[</span><span class="s1">&#39;bus_names_only&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">all_xfmrs_df</span><span class="p">[</span><span class="s1">&#39;equipment_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;transformer&#39;</span>

    <span class="n">all_edges_df</span> <span class="o">=</span> <span class="n">all_lines_df</span><span class="p">[</span><span class="n">chosen_fields</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_xfmrs_df</span><span class="p">[</span><span class="n">chosen_fields</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">all_edges_df</span></div>


<div class="viewcode-block" id="add_graph_edges"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.add_graph_edges">[docs]</a><span class="k">def</span> <span class="nf">add_graph_edges</span><span class="p">(</span><span class="n">G</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">edges_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attr_fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;bus1&#39;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s1">&#39;bus2&#39;</span><span class="p">):</span>
    <span class="c1"># add edges from dataframe</span>
    <span class="c1"># # for networkx 1.10 version (but doing this removes the node attributes) -- so resorting to looping through edges</span>
    <span class="c1"># G = nx.from_pandas_dataframe(df=edges_df, source=source, target=target, edge_attr=attr_fields,</span>
    <span class="c1">#                              create_using=G)</span>

    <span class="c1"># looping through all edges to add into graph</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">edges_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="n">source</span><span class="p">],</span> <span class="n">v</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="n">target</span><span class="p">],</span> <span class="n">attr_dict</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">attr_fields</span><span class="p">]))</span>

    <span class="c1"># # will need to use this for networkx &gt; 2.0</span>
    <span class="c1"># nx.convert_matrix.from_pandas_edgelist(all_lines_df[chosen_fields], source=&#39;bus1&#39;, target=&#39;bus2&#39;, edge_attr=attr_fields,</span>
    <span class="c1">#                              create_using=G)</span>

    <span class="k">return</span> <span class="n">G</span></div>


<div class="viewcode-block" id="searchDictKey"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.searchDictKey">[docs]</a><span class="k">def</span> <span class="nf">searchDictKey</span><span class="p">(</span><span class="n">dct</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function returns a list of dictionary keys that have a certain value</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dct</span>
<span class="sd">    value</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dct</span> <span class="k">if</span> <span class="p">(</span><span class="n">dct</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span><span class="p">)]</span></div>


<div class="viewcode-block" id="generate_networkx_representation"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.generate_networkx_representation">[docs]</a><span class="k">def</span> <span class="nf">generate_networkx_representation</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function generates a networkx graph of the circuit</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kwargs</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bus_coordinates_df</span> <span class="o">=</span> <span class="n">get_bus_coordinates</span><span class="p">()</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">add_graph_bus_nodes</span><span class="p">(</span><span class="n">G</span><span class="o">=</span><span class="n">G</span><span class="p">,</span> <span class="n">bus_coordinates_df</span><span class="o">=</span><span class="n">bus_coordinates_df</span><span class="p">)</span>  <span class="c1"># add buses as nodes to the graph</span>
    <span class="n">attr_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;phases&#39;</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;equipment_type&#39;</span><span class="p">]</span>  <span class="c1"># define edge attributes</span>
    <span class="n">edges_df</span> <span class="o">=</span> <span class="n">get_graph_edges_dataframe</span><span class="p">(</span><span class="n">attr_fields</span><span class="o">=</span><span class="n">attr_fields</span><span class="p">)</span>  <span class="c1"># get edges dataframe (from lines and transformers)</span>
    <span class="c1"># add edges to graph</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">add_graph_edges</span><span class="p">(</span><span class="n">G</span><span class="o">=</span><span class="n">G</span><span class="p">,</span> <span class="n">edges_df</span><span class="o">=</span><span class="n">edges_df</span><span class="p">,</span> <span class="n">attr_fields</span><span class="o">=</span><span class="n">attr_fields</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;bus1&#39;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s1">&#39;bus2&#39;</span><span class="p">)</span>
    <span class="n">create_plot</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;create_plot&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="c1"># if create_plot:  # if plot is to be created, check if all nodes have coordinates</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">correct_node_coordinates</span><span class="p">(</span><span class="n">G</span><span class="o">=</span><span class="n">G</span><span class="p">)</span>
    <span class="c1"># position_dict = nx.get_node_attributes(G, &#39;pos&#39;)  # to be removed. kept here as sample</span>
    <span class="k">return</span> <span class="n">G</span></div>


<div class="viewcode-block" id="correct_node_coordinates"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.correct_node_coordinates">[docs]</a><span class="k">def</span> <span class="nf">correct_node_coordinates</span><span class="p">(</span><span class="n">G</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;If node doesn&#39;t have node attributes, attach parent or child node&#39;s attributes</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    G</span>
<span class="sd">    circuit_source</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">position_dict</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">get_node_attributes</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s1">&#39;pos&#39;</span><span class="p">)</span>
    <span class="n">missing_coords_nodes</span> <span class="o">=</span> <span class="n">searchDictKey</span><span class="p">(</span><span class="n">position_dict</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>  <span class="c1"># get list of nodes with missing coordinates ([0,0])</span>

    <span class="c1"># iterate over all nodes with missing coordinates</span>
    <span class="k">for</span> <span class="n">missing_node</span> <span class="ow">in</span> <span class="n">missing_coords_nodes</span><span class="p">:</span>
        <span class="n">parent_node</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">missing_node</span><span class="p">)</span>  <span class="c1"># find list of parent nodes</span>
        <span class="n">child_node</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">successors</span><span class="p">(</span><span class="n">missing_node</span><span class="p">)</span>  <span class="c1"># find list of child nodes</span>
        <span class="n">reference_coord_set</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parent_node</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># parent node exists</span>
            <span class="n">reference_coord</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">parent_node</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">reference_coord</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span><span class="mi">0</span><span class="p">}:</span>  <span class="c1"># if parent node also has [0,0] coordinates</span>
                <span class="n">ancestors_list</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">ancestors</span><span class="p">(</span><span class="n">missing_node</span><span class="p">)</span>  <span class="c1"># find list of ancestors, and iterate over them</span>
                <span class="k">for</span> <span class="n">ancestor</span> <span class="ow">in</span> <span class="n">ancestors_list</span><span class="p">:</span>
                    <span class="n">reference_coord</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">ancestor</span><span class="p">][</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span>
                    <span class="c1"># once an ancestor with non zero coordinates is found, stop iteration</span>
                    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">reference_coord</span><span class="p">)</span> <span class="o">!=</span> <span class="p">{</span><span class="mi">0</span><span class="p">}:</span>
                        <span class="k">break</span>
            <span class="n">G</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">missing_node</span><span class="p">][</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reference_coord</span>  <span class="c1"># assign coordinates</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">child_node</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># child node exists</span>
            <span class="n">reference_coord</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">child_node</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">reference_coord</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span><span class="mi">0</span><span class="p">}:</span>  <span class="c1"># if child node also has [0,0] coordinates</span>
                <span class="n">successors_list</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">dfs_successors</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">missing_node</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">successor</span> <span class="ow">in</span> <span class="n">successors_list</span><span class="p">:</span>
                    <span class="n">reference_coord</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">successor</span><span class="p">][</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span>
                    <span class="c1"># once a node with non zero coordinates is found, stop iteration</span>
                    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">reference_coord</span><span class="p">)</span> <span class="o">!=</span> <span class="p">{</span><span class="mi">0</span><span class="p">}:</span>
                        <span class="k">break</span>
            <span class="n">G</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">missing_node</span><span class="p">][</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reference_coord</span>  <span class="c1"># assign coordinates</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># if there are no parent or child nodes</span>
            <span class="k">continue</span>  <span class="c1"># can&#39;t correct coordinates cause no parent or child nodes found.</span>
    <span class="k">return</span> <span class="n">G</span></div>


<span class="c1"># function to get capacitor upgrades</span>
<div class="viewcode-block" id="get_capacitor_upgrades"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.get_capacitor_upgrades">[docs]</a><span class="k">def</span> <span class="nf">get_capacitor_upgrades</span><span class="p">(</span><span class="n">orig_capacitors_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">new_capacitors_df</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">orig_capacitors_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">orig_capcontrols</span> <span class="o">=</span> <span class="n">orig_capacitors_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;capacitor_name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">orig_capcontrols</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_capacitors_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">new_capcontrols</span> <span class="o">=</span> <span class="n">new_capacitors_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;capacitor_name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_capcontrols</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="n">final_cap_upgrades</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">processed_outputs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># STEP 1: compare controllers that exist in both: original and new- and get difference</span>
    <span class="n">change</span> <span class="o">=</span> <span class="n">compare_dict</span><span class="p">(</span><span class="n">orig_capcontrols</span><span class="p">,</span> <span class="n">new_capcontrols</span><span class="p">)</span>
    <span class="n">modified_capacitors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">change</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="c1"># STEP 2: account for any new controllers added (which are not there in original)</span>
    <span class="n">new_addition</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">new_capcontrols</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span>
                        <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">orig_capcontrols</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_capcontrols</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
    <span class="n">cap_upgrades</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">modified_capacitors</span><span class="p">,</span> <span class="o">*</span><span class="n">new_addition</span><span class="p">]</span>  <span class="c1"># combining these two lists to get upgraded capacitors</span>
    <span class="k">if</span> <span class="n">cap_upgrades</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">cap_name</span> <span class="ow">in</span> <span class="n">cap_upgrades</span><span class="p">:</span>
            <span class="n">final_cap_upgrades</span><span class="p">[</span><span class="s2">&quot;cap_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Capacitor.&quot;</span> <span class="o">+</span> <span class="n">cap_name</span>
            <span class="n">final_cap_upgrades</span><span class="p">[</span><span class="s2">&quot;ctrl_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_capcontrols</span><span class="p">[</span><span class="n">cap_name</span><span class="p">][</span><span class="s2">&quot;capcontrol_name&quot;</span><span class="p">]</span>
            <span class="n">final_cap_upgrades</span><span class="p">[</span><span class="s2">&quot;cap_kvar&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_capcontrols</span><span class="p">[</span><span class="n">cap_name</span><span class="p">][</span><span class="s2">&quot;kvar&quot;</span><span class="p">]</span>
            <span class="n">final_cap_upgrades</span><span class="p">[</span><span class="s2">&quot;cap_kv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_capcontrols</span><span class="p">[</span><span class="n">cap_name</span><span class="p">][</span><span class="s2">&quot;kv&quot;</span><span class="p">]</span>
            <span class="n">final_cap_upgrades</span><span class="p">[</span><span class="s2">&quot;cap_on&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_capcontrols</span><span class="p">[</span><span class="n">cap_name</span><span class="p">][</span><span class="s2">&quot;ONsetting&quot;</span><span class="p">]</span>
            <span class="n">final_cap_upgrades</span><span class="p">[</span><span class="s2">&quot;cap_off&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_capcontrols</span><span class="p">[</span><span class="n">cap_name</span><span class="p">][</span><span class="s2">&quot;OFFsetting&quot;</span><span class="p">]</span>
            <span class="n">final_cap_upgrades</span><span class="p">[</span><span class="s2">&quot;ctrl_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_capcontrols</span><span class="p">[</span><span class="n">cap_name</span><span class="p">][</span><span class="s2">&quot;capcontrol_type&quot;</span><span class="p">]</span>
            <span class="n">final_cap_upgrades</span><span class="p">[</span><span class="s2">&quot;cap_settings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># if there are differences between original and new controllers</span>
            <span class="k">if</span> <span class="n">cap_name</span> <span class="ow">in</span> <span class="n">modified_capacitors</span><span class="p">:</span>
                <span class="c1"># if control type in original controller is voltage, only settings are changed</span>
                <span class="k">if</span> <span class="n">orig_capcontrols</span><span class="p">[</span><span class="n">cap_name</span><span class="p">][</span><span class="s2">&quot;capcontrol_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;volt&quot;</span><span class="p">):</span>
                    <span class="n">final_cap_upgrades</span><span class="p">[</span><span class="s2">&quot;ctrl_added&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># if original controller type was current, new controller (voltage type) is said to be added</span>
                <span class="k">elif</span> <span class="n">orig_capcontrols</span><span class="p">[</span><span class="n">cap_name</span><span class="p">][</span><span class="s2">&quot;capcontrol_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;current&quot;</span><span class="p">):</span>
                    <span class="n">final_cap_upgrades</span><span class="p">[</span><span class="s2">&quot;ctrl_added&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># if there are new controllers</span>
            <span class="k">elif</span> <span class="n">cap_name</span> <span class="ow">in</span> <span class="n">new_addition</span><span class="p">:</span>
                <span class="n">final_cap_upgrades</span><span class="p">[</span><span class="s2">&quot;ctrl_added&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">processed_outputs</span><span class="p">[</span><span class="n">final_cap_upgrades</span><span class="p">[</span><span class="s2">&quot;cap_name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;New controller added&quot;</span><span class="p">:</span> <span class="n">final_cap_upgrades</span><span class="p">[</span><span class="s2">&quot;ctrl_added&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Controller settings modified&quot;</span><span class="p">:</span> <span class="n">final_cap_upgrades</span><span class="p">[</span><span class="s2">&quot;cap_settings&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Final Settings&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;capctrl name&quot;</span><span class="p">:</span> <span class="n">final_cap_upgrades</span><span class="p">[</span><span class="s2">&quot;ctrl_name&quot;</span><span class="p">],</span>
                <span class="s2">&quot;cap kvar&quot;</span><span class="p">:</span> <span class="n">final_cap_upgrades</span><span class="p">[</span><span class="s2">&quot;cap_kvar&quot;</span><span class="p">],</span>
                <span class="s2">&quot;cap kV&quot;</span><span class="p">:</span> <span class="n">final_cap_upgrades</span><span class="p">[</span><span class="s2">&quot;cap_kv&quot;</span><span class="p">],</span>
                <span class="s2">&quot;ctrl type&quot;</span><span class="p">:</span> <span class="n">final_cap_upgrades</span><span class="p">[</span><span class="s2">&quot;ctrl_type&quot;</span><span class="p">],</span>
                <span class="s2">&quot;ON setting (V)&quot;</span><span class="p">:</span> <span class="n">final_cap_upgrades</span><span class="p">[</span><span class="s2">&quot;cap_on&quot;</span><span class="p">],</span>
                <span class="s2">&quot;OFF setting (V)&quot;</span><span class="p">:</span> <span class="n">final_cap_upgrades</span><span class="p">[</span><span class="s2">&quot;cap_off&quot;</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="k">return</span> <span class="n">processed_outputs</span></div>


<span class="c1"># function to assign settings if regulator upgrades are on substation transformer</span>
<div class="viewcode-block" id="check_substation_LTC"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.check_substation_LTC">[docs]</a><span class="k">def</span> <span class="nf">check_substation_LTC</span><span class="p">(</span><span class="n">new_ckt_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xfmr_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">new_ckt_info</span><span class="p">[</span><span class="s2">&quot;substation_xfmr&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">xfmr_name</span><span class="p">:</span>
        <span class="n">subltc_dict</span> <span class="o">=</span> <span class="p">{}</span>        
        <span class="n">subltc_dict</span><span class="p">[</span><span class="s2">&quot;substation_xfmr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">subltc_dict</span><span class="p">[</span><span class="s2">&quot;xfmr_kva&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_ckt_info</span><span class="p">[</span><span class="s2">&quot;substation_xfmr&quot;</span><span class="p">][</span><span class="s2">&quot;kVA&quot;</span><span class="p">]</span>
        <span class="n">subltc_dict</span><span class="p">[</span><span class="s2">&quot;xfmr_kv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_ckt_info</span><span class="p">[</span><span class="s2">&quot;substation_xfmr&quot;</span><span class="p">][</span><span class="s2">&quot;kV&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">subltc_dict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">subltc_dict</span></div>


<span class="c1"># function to check for regulator upgrades</span>
<div class="viewcode-block" id="get_regulator_upgrades"><a class="viewcode-back" href="../../../../../disco/disco.extensions.upgrade_simulation.upgrades.html#disco.extensions.upgrade_simulation.upgrades.voltage_upgrade_functions.get_regulator_upgrades">[docs]</a><span class="k">def</span> <span class="nf">get_regulator_upgrades</span><span class="p">(</span><span class="n">orig_regcontrols_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">new_regcontrols_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">orig_xfmrs_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">new_ckt_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">orig_regcontrols_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">orig_reg_controls</span> <span class="o">=</span> <span class="n">orig_regcontrols_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">orig_reg_controls</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_regcontrols_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">new_reg_controls</span> <span class="o">=</span> <span class="n">new_regcontrols_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_reg_controls</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">orig_xfmrs_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">orig_xfmr_info</span> <span class="o">=</span> <span class="n">orig_xfmrs_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">orig_xfmr_info</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="n">final_reg_upgrades</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">processed_outputs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># STEP 1: compare controllers that exist in both: original and new</span>
    <span class="n">change</span> <span class="o">=</span> <span class="n">compare_dict</span><span class="p">(</span><span class="n">orig_reg_controls</span><span class="p">,</span> <span class="n">new_reg_controls</span><span class="p">)</span>
    <span class="n">modified_regulators</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">change</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="c1"># STEP 2: account for any new controllers added (which are not there in original)</span>
    <span class="n">new_addition</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">new_reg_controls</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span>
                        <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">orig_reg_controls</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_reg_controls</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
    <span class="n">reg_upgrades</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">modified_regulators</span><span class="p">,</span> <span class="o">*</span><span class="n">new_addition</span><span class="p">]</span>  <span class="c1"># combining these two lists to get upgraded regulators</span>
    <span class="c1"># if there are any upgrades &amp; enabled, only then write to the file</span>
    <span class="k">if</span> <span class="n">reg_upgrades</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ctrl_name</span> <span class="ow">in</span> <span class="n">reg_upgrades</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">new_reg_controls</span><span class="p">[</span><span class="n">ctrl_name</span><span class="p">][</span><span class="s1">&#39;enabled&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">final_reg_upgrades</span><span class="p">[</span><span class="s2">&quot;reg_settings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;changed&quot;</span>  <span class="c1"># settings are changed</span>
                <span class="n">final_reg_upgrades</span><span class="p">[</span><span class="s2">&quot;reg_ctrl_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctrl_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">final_reg_upgrades</span><span class="p">[</span><span class="s2">&quot;reg_vsp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">new_reg_controls</span><span class="p">[</span><span class="n">ctrl_name</span><span class="p">][</span><span class="s2">&quot;vreg&quot;</span><span class="p">])</span>
                <span class="n">final_reg_upgrades</span><span class="p">[</span><span class="s2">&quot;reg_band&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">new_reg_controls</span><span class="p">[</span><span class="n">ctrl_name</span><span class="p">][</span><span class="s2">&quot;band&quot;</span><span class="p">])</span>
                <span class="n">final_reg_upgrades</span><span class="p">[</span><span class="s2">&quot;xfmr_kva&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_reg_controls</span><span class="p">[</span><span class="n">ctrl_name</span><span class="p">][</span><span class="s2">&quot;transformer_kva&quot;</span><span class="p">]</span>
                <span class="n">final_reg_upgrades</span><span class="p">[</span><span class="s2">&quot;xfmr_kv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_reg_controls</span><span class="p">[</span><span class="n">ctrl_name</span><span class="p">][</span><span class="s2">&quot;transformer_kv&quot;</span><span class="p">]</span>
                <span class="n">final_reg_upgrades</span><span class="p">[</span><span class="s2">&quot;xfmr_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_reg_controls</span><span class="p">[</span><span class="n">ctrl_name</span><span class="p">][</span><span class="s2">&quot;transformer&quot;</span><span class="p">]</span>
                <span class="n">final_reg_upgrades</span><span class="p">[</span><span class="s2">&quot;new_xfmr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># default = False: new transformer is not added</span>
                <span class="n">final_reg_upgrades</span><span class="p">[</span><span class="s2">&quot;sub_xfmr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># default False; (is not substation xfmr)</span>
                <span class="c1"># if regulators are modified (and exist in both original and new)</span>
                <span class="k">if</span> <span class="n">ctrl_name</span> <span class="ow">in</span> <span class="n">modified_regulators</span><span class="p">:</span>
                    <span class="n">final_reg_upgrades</span><span class="p">[</span><span class="s2">&quot;reg_added&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># not a new regulator</span>
                    <span class="n">subltc_dict</span> <span class="o">=</span> <span class="n">check_substation_LTC</span><span class="p">(</span><span class="n">new_ckt_info</span><span class="o">=</span><span class="n">new_ckt_info</span><span class="p">,</span> 
                                                       <span class="n">xfmr_name</span><span class="o">=</span><span class="n">final_reg_upgrades</span><span class="p">[</span><span class="s2">&quot;xfmr_name&quot;</span><span class="p">])</span>  <span class="c1"># check if regulator is on substation transformer</span>
                    <span class="k">if</span> <span class="n">subltc_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">final_reg_upgrades</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">subltc_dict</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">ctrl_name</span> <span class="ow">in</span> <span class="n">new_addition</span><span class="p">:</span>
                    <span class="n">final_reg_upgrades</span><span class="p">[</span><span class="s2">&quot;reg_added&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># is a new regulator</span>
                    <span class="n">subltc_dict</span> <span class="o">=</span> <span class="n">check_substation_LTC</span><span class="p">(</span><span class="n">new_ckt_info</span><span class="o">=</span><span class="n">new_ckt_info</span><span class="p">,</span> 
                                                       <span class="n">xfmr_name</span><span class="o">=</span><span class="n">final_reg_upgrades</span><span class="p">[</span><span class="s2">&quot;xfmr_name&quot;</span><span class="p">])</span>   <span class="c1"># check if regulator is on substation transformer</span>
                    <span class="k">if</span> <span class="n">subltc_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">final_reg_upgrades</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">subltc_dict</span><span class="p">)</span>
                    <span class="c1"># if regulator transformer is not in the original xfmr list, then a new xfmr</span>
                    <span class="k">if</span> <span class="n">final_reg_upgrades</span><span class="p">[</span><span class="s2">&quot;xfmr_name&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">orig_xfmr_info</span><span class="p">:</span>
                        <span class="n">final_reg_upgrades</span><span class="p">[</span><span class="s2">&quot;new_xfmr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># is a new xfmr</span>
                <span class="n">processed_outputs</span><span class="p">[</span><span class="s2">&quot;Regctrl.&quot;</span> <span class="o">+</span> <span class="n">final_reg_upgrades</span><span class="p">[</span><span class="s2">&quot;reg_ctrl_name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;New controller added&quot;</span><span class="p">:</span> <span class="n">final_reg_upgrades</span><span class="p">[</span><span class="s2">&quot;reg_added&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;Controller settings modified&quot;</span><span class="p">:</span> <span class="n">final_reg_upgrades</span><span class="p">[</span><span class="s2">&quot;reg_settings&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;New transformer added&quot;</span><span class="p">:</span> <span class="n">final_reg_upgrades</span><span class="p">[</span><span class="s2">&quot;new_xfmr&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;Substation LTC&quot;</span><span class="p">:</span> <span class="n">final_reg_upgrades</span><span class="p">[</span><span class="s2">&quot;sub_xfmr&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;Final settings&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;Transformer name&quot;</span><span class="p">:</span> <span class="n">final_reg_upgrades</span><span class="p">[</span><span class="s2">&quot;xfmr_name&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;Transformer kVA&quot;</span><span class="p">:</span> <span class="n">final_reg_upgrades</span><span class="p">[</span><span class="s2">&quot;xfmr_kva&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;Transformer kV&quot;</span><span class="p">:</span> <span class="n">final_reg_upgrades</span><span class="p">[</span><span class="s2">&quot;xfmr_kv&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;Reg ctrl V set point&quot;</span><span class="p">:</span> <span class="n">final_reg_upgrades</span><span class="p">[</span><span class="s2">&quot;reg_vsp&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;Reg ctrl deadband&quot;</span><span class="p">:</span> <span class="n">final_reg_upgrades</span><span class="p">[</span><span class="s2">&quot;reg_band&quot;</span><span class="p">]</span>
                    <span class="p">}</span>
                    <span class="p">}</span>
    <span class="k">return</span> <span class="n">processed_outputs</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, NREL.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>