<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>disco.sources.source_tree_1.pv_deployments &mdash; DISCO 0.1 documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link href="../../../../_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../../index.html" class="icon icon-home"> DISCO
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../installation.html#use-conda">Use Conda</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../installation.html#use-docker">Use Docker</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../overview.html">Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../overview.html#data-sources">Data Sources</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../overview.html#transform-model">Transform Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../overview.html#config-jobs">Config Jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../overview.html#submit-jobs">Submit Jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../overview.html#result-analysis">Result Analysis</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../quick-start.html">Quick Start</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../quick-start.html#source-data">Source Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../quick-start.html#transform-model">Transform Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../quick-start.html#config-jobs">Config Jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../quick-start.html#submit-jobs">Submit Jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../quick-start.html#result-analysis">Result Analysis</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../data-sources.html">Data Sources</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../data-sources/smart-ds-model-preparation.html">SMART-DS OpenDSS Model Preparation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../data-sources.html#gem-model">GEM Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../data-sources.html#epri-model">EPRI Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../data-sources.html#sourcetree1-model">SourceTree1 Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../data-sources.html#sourcetree2-model">SourceTree2 Model</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pv-deployments.html">PV Deployments</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../pv-deployments.html#sourcetree1-pv-deployments">SourceTree1 PV Deployments</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../transform-models.html">Transform Models</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../transform-models.html#transform-model-help">Transform Model Help</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../transform-models.html#disco-model-in-depth">DISCO Model in Depth</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analysis-workflows.html">Analysis Workflows</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../analysis-workflows/hosting-capacity-analysis.html">Hosting Capacity Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../analysis-workflows/upgrade-cost-analysis.html">Upgrade Cost Analysis</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pipelines.html">Pipelines</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../pipelines.html#sourcetree1model">SourceTree1Model</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../debugging-issues.html">Debugging Issues</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../debugging-issues.html#using-jade">Using JADE</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../debugging-issues.html#using-pydss">Using PyDSS</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../data-ingestion.html">Data Ingestion</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../data-ingestion.html#ingest-to-new-database">Ingest to New Database</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../data-ingestion.html#ingest-to-existing-database">Ingest to Existing Database</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../data-ingestion.html#run-database-queries">Run Database Queries</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../advanced-guide.html">Advanced Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../advanced-guide/analysis-deployment.html">Analysis Deployment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../advanced-guide/upgrade-cost-analysis-generic-models.html">Upgrade Cost Analysis JSON Schemas</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contribution</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../build-docs.html">Build docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../license.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">DISCO</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
      <li>disco.sources.source_tree_1.pv_deployments</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for disco.sources.source_tree_1.pv_deployments</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">ProcessPoolExecutor</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">NamedTemporaryFile</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">SimpleNamespace</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Sequence</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">opendssdirect</span> <span class="k">as</span> <span class="nn">dss</span>
<span class="kn">from</span> <span class="nn">filelock</span> <span class="kn">import</span> <span class="n">SoftFileLock</span>
<span class="kn">from</span> <span class="nn">unidecode</span> <span class="kn">import</span> <span class="n">unidecode</span>

<span class="kn">from</span> <span class="nn">jade.utils.run_command</span> <span class="kn">import</span> <span class="n">check_run_command</span>
<span class="kn">from</span> <span class="nn">jade.utils.utils</span> <span class="kn">import</span> <span class="n">load_data</span><span class="p">,</span> <span class="n">dump_data</span>
<span class="kn">from</span> <span class="nn">disco.common</span> <span class="kn">import</span> <span class="n">LOADS_SUM_GROUP_FILENAME</span><span class="p">,</span> <span class="n">PV_SYSTEMS_SUM_GROUP_FILENAME</span>
<span class="kn">from</span> <span class="nn">disco.enums</span> <span class="kn">import</span> <span class="n">Placement</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="n">PV_SYSTEMS_FILENAME</span> <span class="o">=</span> <span class="s2">&quot;PVSystems.dss&quot;</span>
<span class="n">PV_SHAPES_FILENAME</span> <span class="o">=</span> <span class="s2">&quot;PVShapes.dss&quot;</span>
<span class="n">PV_CONFIG_FILENAME</span> <span class="o">=</span> <span class="s2">&quot;pv_config.json&quot;</span>
<span class="n">PV_INSTALLATION_TOLERANCE</span> <span class="o">=</span> <span class="mf">1.0e-10</span>

<span class="n">LOADS_FILENAME</span> <span class="o">=</span> <span class="s2">&quot;Loads.dss&quot;</span>
<span class="n">ORIGINAL_LOADS_FILENAME</span> <span class="o">=</span> <span class="s2">&quot;Original_Loads.dss&quot;</span>
<span class="n">TRANSFORMED_LOADS_FILENAME</span> <span class="o">=</span> <span class="s2">&quot;PV_Loads.dss&quot;</span>

<span class="n">LOADSHAPES_FILENAME</span> <span class="o">=</span> <span class="s2">&quot;LoadShapes.dss&quot;</span>
<span class="n">ORGINAL_LOADSHAPES_FILENAME</span> <span class="o">=</span> <span class="s2">&quot;Original_LoadShapes.dss&quot;</span>


<div class="viewcode-block" id="DeploymentHierarchy"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.DeploymentHierarchy">[docs]</a><span class="k">class</span> <span class="nc">DeploymentHierarchy</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">FEEDER</span> <span class="o">=</span> <span class="s2">&quot;feeder&quot;</span>
    <span class="n">SUBSTATION</span> <span class="o">=</span> <span class="s2">&quot;substation&quot;</span>
    <span class="n">REGION</span> <span class="o">=</span> <span class="s2">&quot;region&quot;</span>
    <span class="n">CITY</span> <span class="o">=</span> <span class="s2">&quot;city&quot;</span></div>


<div class="viewcode-block" id="DeploymentCategory"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.DeploymentCategory">[docs]</a><span class="k">class</span> <span class="nc">DeploymentCategory</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">MIXED</span> <span class="o">=</span> <span class="s2">&quot;mixed&quot;</span>
    <span class="n">SMALL</span> <span class="o">=</span> <span class="s2">&quot;small&quot;</span>
    <span class="n">LARGE</span> <span class="o">=</span> <span class="s2">&quot;large&quot;</span></div>


<div class="viewcode-block" id="get_subdir_names"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.get_subdir_names">[docs]</a><span class="k">def</span> <span class="nf">get_subdir_names</span><span class="p">(</span><span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Given an input path, return directory names under the path.</span>
<span class="sd">    Used to parse substation names, and feeder names under input path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">input_path</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Path does not exist - </span><span class="si">{</span><span class="n">input_path</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">subdir_names</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">input_path</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="c1"># Ignore these folder names</span>
    <span class="n">ignored_names</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;subtransmission&quot;</span><span class="p">,</span> <span class="s2">&quot;aggregate&quot;</span><span class="p">,</span> <span class="s2">&quot;analysis&quot;</span><span class="p">,</span> <span class="s2">&quot;hc_pv_deployments&quot;</span><span class="p">,</span> <span class="s2">&quot;zip&quot;</span><span class="p">}</span>
    <span class="n">clean_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">subdir_names</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ignored_names</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">clean_names</span></div>


<div class="viewcode-block" id="PVDSSInstance"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDSSInstance">[docs]</a><span class="k">class</span> <span class="nc">PVDSSInstance</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;OpenDSS file handler for PV deployments.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">master_file</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master_file</span> <span class="o">=</span> <span class="n">master_file</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">feeder_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Parse feeder name from master file path&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">master_file</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">feeder_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Parse feeder path from master file path&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">master_file</span><span class="p">)</span>

<div class="viewcode-block" id="PVDSSInstance.convert_to_ascii"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDSSInstance.convert_to_ascii">[docs]</a>    <span class="k">def</span> <span class="nf">convert_to_ascii</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Convert unicode data in ASCII characters for representation&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Convert master file - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_file</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">master_file</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
        <span class="n">updated_data</span> <span class="o">=</span> <span class="n">unidecode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">master_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">updated_data</span><span class="p">)</span></div>

<div class="viewcode-block" id="PVDSSInstance.disable_loadshapes_redirect"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDSSInstance.disable_loadshapes_redirect">[docs]</a>    <span class="k">def</span> <span class="nf">disable_loadshapes_redirect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;To comment out &#39;Redirect LoadShapes.dss&#39; in Master.dss file</span>
<span class="sd">        </span>
<span class="sd">        Redirect LoadShapes.dss is time consuming during OpenDSS loads the feeder, which</span>
<span class="sd">        make the PV deployments take a long to run. However, LoadShapes is not in use during </span>
<span class="sd">        PV deployments. To speed up, we&#39;ll comment out the redirect and revert it back after</span>
<span class="sd">        PV deployments finished.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Disable LoadShapes.dss redirect in master file - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_file</span><span class="p">)</span>
        
        <span class="n">redirected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">updated_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">master_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;redirect loadshapes.dss&quot;</span><span class="p">):</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;!&quot;</span> <span class="o">+</span> <span class="n">line</span>
                    <span class="n">redirected</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">updated_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">redirected</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">master_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fw</span><span class="p">:</span>
            <span class="n">fw</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">updated_data</span><span class="p">)</span></div>

<div class="viewcode-block" id="PVDSSInstance.load_feeder"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDSSInstance.load_feeder">[docs]</a>    <span class="k">def</span> <span class="nf">load_feeder</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;OpenDSS redirect master DSS file&quot;&quot;&quot;</span>
        <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;Clear&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;OpenDSS loads feeder - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_file</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Redirect </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">master_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;OpenDSSError: </span><span class="si">%s</span><span class="s2">. Feeder: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_file</span><span class="p">)</span>
            <span class="k">raise</span></div>

<div class="viewcode-block" id="PVDSSInstance.search_head_line"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDSSInstance.search_head_line">[docs]</a>    <span class="k">def</span> <span class="nf">search_head_line</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Search head line from DSS topology&quot;&quot;&quot;</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">flag</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;line&quot;</span> <span class="ow">in</span> <span class="n">dss</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">BranchName</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">dss</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">BranchName</span><span class="p">()</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Failed to search head line.&quot;</span></div>

<div class="viewcode-block" id="PVDSSInstance.ensure_energy_meter"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDSSInstance.ensure_energy_meter">[docs]</a>    <span class="k">def</span> <span class="nf">ensure_energy_meter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">missing</span><span class="p">,</span> <span class="n">misplaced</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_energy_meter_status</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Energy meter missing in master file - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">place_new_energy_meter</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">misplaced</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Energy meter location is not correct in master file - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">move_energy_meter_location</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Energy meter exists and meter status is good in master file - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="PVDSSInstance.check_energy_meter_status"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDSSInstance.check_energy_meter_status">[docs]</a>    <span class="k">def</span> <span class="nf">check_energy_meter_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Check if energy meter in dss is missing or misplaced&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">master_file</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="s1">&#39;New EnergyMeter&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span>
        <span class="n">misplaced</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">missing</span><span class="p">:</span>
            <span class="n">head_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_head_line</span><span class="p">()</span>
            <span class="n">meter_location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_meter_location</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">misplaced</span> <span class="o">=</span> <span class="n">meter_location</span> <span class="o">!=</span> <span class="n">head_line</span>

        <span class="k">return</span> <span class="n">missing</span><span class="p">,</span> <span class="n">misplaced</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_parse_meter_location</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data: str, the string data read from master file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str:</span>
<span class="sd">            meter location</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Use regex</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">New EnergyMeter&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;element=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<div class="viewcode-block" id="PVDSSInstance.place_new_energy_meter"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDSSInstance.place_new_energy_meter">[docs]</a>    <span class="k">def</span> <span class="nf">place_new_energy_meter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Place new energy meter if it&#39;s missing from master dss file&quot;&quot;&quot;</span>
        <span class="n">head_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_head_line</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">master_file</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Redirect&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">updated_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">temp</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">New EnergyMeter.m1 element=</span><span class="si">{</span><span class="n">head_line</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">master_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">updated_data</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;New energy meter was placed into master file - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_file</span><span class="p">)</span></div>

<div class="viewcode-block" id="PVDSSInstance.move_energy_meter_location"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDSSInstance.move_energy_meter_location">[docs]</a>    <span class="k">def</span> <span class="nf">move_energy_meter_location</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Move energy meter location if it&#39;s misplaced in master dss file&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Moving energy meter in master file - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_file</span><span class="p">)</span>
        <span class="n">head_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_head_line</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">master_file</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
        <span class="n">meter_location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_meter_location</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">updated_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">meter_location</span><span class="p">,</span> <span class="n">head_line</span><span class="p">)</span>
        <span class="n">updated_data</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">!Moved energy meter from </span><span class="si">{</span><span class="n">meter_location</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">head_line</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">master_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">updated_data</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Moved energy meter from </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2"> in master file - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">meter_location</span><span class="p">,</span> <span class="n">head_line</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_file</span><span class="p">)</span></div>

<div class="viewcode-block" id="PVDSSInstance.get_total_loads"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDSSInstance.get_total_loads">[docs]</a>    <span class="k">def</span> <span class="nf">get_total_loads</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SimpleNamespace</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return total loads&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">(</span>
            <span class="n">total_load</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">load_dict</span><span class="o">=</span><span class="p">{},</span>
            <span class="n">customer_bus_map</span><span class="o">=</span><span class="p">{},</span>
            <span class="n">bus_load</span><span class="o">=</span><span class="p">{},</span>
            <span class="n">bus_totalload</span><span class="o">=</span><span class="p">{}</span>
        <span class="p">)</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">flag</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">customer_id</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
            <span class="n">bus</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;bus1&quot;</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">customer_bus_map</span><span class="p">[</span><span class="n">customer_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">bus</span>

            <span class="n">load_kW</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">kW</span><span class="p">()</span>
            <span class="n">result</span><span class="o">.</span><span class="n">load_dict</span><span class="p">[</span><span class="n">customer_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_kW</span>
            <span class="n">result</span><span class="o">.</span><span class="n">total_load</span> <span class="o">+=</span> <span class="n">load_kW</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">bus</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">bus_load</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">bus_load</span><span class="p">[</span><span class="n">bus</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">result</span><span class="o">.</span><span class="n">bus_totalload</span><span class="p">[</span><span class="n">bus</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_kW</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">bus_load</span><span class="p">[</span><span class="n">bus</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">customer_id</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">bus_totalload</span><span class="p">[</span><span class="n">bus</span><span class="p">]</span> <span class="o">+=</span> <span class="n">load_kW</span>

            <span class="n">flag</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="PVDSSInstance.get_customer_distance"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDSSInstance.get_customer_distance">[docs]</a>    <span class="k">def</span> <span class="nf">get_customer_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SimpleNamespace</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return custmer distance&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">(</span><span class="n">load_distance</span><span class="o">=</span><span class="p">{},</span> <span class="n">bus_distance</span><span class="o">=</span><span class="p">{})</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">flag</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;bus1&quot;</span><span class="p">))</span>
            <span class="n">result</span><span class="o">.</span><span class="n">load_distance</span><span class="p">[</span><span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Name</span><span class="p">()]</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">Distance</span><span class="p">()</span>
            <span class="n">result</span><span class="o">.</span><span class="n">bus_distance</span><span class="p">[</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;bus1&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">Distance</span><span class="p">()</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="PVDSSInstance.get_highv_buses"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDSSInstance.get_highv_buses">[docs]</a>    <span class="k">def</span> <span class="nf">get_highv_buses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kv_min</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SimpleNamespace</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return highv buses&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">(</span><span class="n">bus_kv</span><span class="o">=</span><span class="p">{},</span> <span class="n">hv_bus_distance</span><span class="o">=</span><span class="p">{})</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">flag</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">buses</span> <span class="o">=</span> <span class="p">[</span><span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Bus1</span><span class="p">(),</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Bus2</span><span class="p">()]</span>
            <span class="k">for</span> <span class="n">bus</span> <span class="ow">in</span> <span class="n">buses</span><span class="p">:</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">bus</span><span class="p">)</span>
                <span class="n">kvbase</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">kVBase</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">kvbase</span> <span class="o">&gt;=</span> <span class="n">kv_min</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">bus_kv</span><span class="p">[</span><span class="n">bus</span><span class="p">]</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">kVBase</span><span class="p">()</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">hv_bus_distance</span><span class="p">[</span><span class="n">bus</span><span class="p">]</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">Distance</span><span class="p">()</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="PVDSSInstance.get_existing_pvs"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDSSInstance.get_existing_pvs">[docs]</a>    <span class="k">def</span> <span class="nf">get_existing_pvs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SimpleNamespace</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return existing pvs&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">(</span><span class="n">total_existing_pv</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">existing_pv</span><span class="o">=</span><span class="p">{})</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">PVsystems</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">flag</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">bus</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;bus1&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">existing_pv</span><span class="p">[</span><span class="n">bus</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dss</span><span class="o">.</span><span class="n">PVsystems</span><span class="o">.</span><span class="n">Pmpp</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">existing_pv</span><span class="p">[</span><span class="n">bus</span><span class="p">]</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">PVsystems</span><span class="o">.</span><span class="n">Pmpp</span><span class="p">()</span>
            <span class="n">result</span><span class="o">.</span><span class="n">total_existing_pv</span> <span class="o">+=</span> <span class="n">dss</span><span class="o">.</span><span class="n">PVsystems</span><span class="o">.</span><span class="n">Pmpp</span><span class="p">()</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">PVsystems</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="PVDSSInstance.combine_bus_distances"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDSSInstance.combine_bus_distances">[docs]</a>    <span class="k">def</span> <span class="nf">combine_bus_distances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_distance</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">,</span> <span class="n">highv_buses</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return the combined bus distance&quot;&quot;&quot;</span>
        <span class="n">customer_bus_distance</span> <span class="o">=</span> <span class="n">customer_distance</span><span class="o">.</span><span class="n">bus_distance</span>
        <span class="n">hv_bus_distance</span> <span class="o">=</span> <span class="n">highv_buses</span><span class="o">.</span><span class="n">hv_bus_distance</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Feeder Name: </span><span class="si">%s</span><span class="s2">, Highv DistRange: (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feeder_name</span><span class="p">,</span>
            <span class="nb">min</span><span class="p">(</span><span class="n">hv_bus_distance</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="nb">max</span><span class="p">(</span><span class="n">hv_bus_distance</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="p">)</span>

        <span class="n">combined_bus_distance</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">hv_bus_distance</span><span class="p">)</span>
        <span class="n">combined_bus_distance</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">customer_bus_distance</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">combined_bus_distance</span></div>

<div class="viewcode-block" id="PVDSSInstance.get_feeder_stats"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDSSInstance.get_feeder_stats">[docs]</a>    <span class="k">def</span> <span class="nf">get_feeder_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">total_loads</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">,</span> <span class="n">existing_pvs</span><span class="p">:</span> <span class="n">SimpleNamespace</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SimpleNamespace</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return feeder stats&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;n_buses&quot;</span><span class="p">:</span> <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">NumBuses</span><span class="p">(),</span>
            <span class="s2">&quot;nload_buses&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">total_loads</span><span class="o">.</span><span class="n">bus_totalload</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
            <span class="s2">&quot;nzero_load_buses&quot;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">total_loads</span><span class="o">.</span><span class="n">bus_totalload</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="s2">&quot;total_load&quot;</span><span class="p">:</span> <span class="n">total_loads</span><span class="o">.</span><span class="n">total_load</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">existing_pvs</span><span class="p">:</span>
            <span class="n">nbase_pv_buses</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">existing_pvs</span><span class="o">.</span><span class="n">existing_pv</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">pcent_base_pv</span> <span class="o">=</span> <span class="p">(</span><span class="n">existing_pvs</span><span class="o">.</span><span class="n">total_existing_pv</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0000001</span><span class="p">,</span> <span class="n">total_loads</span><span class="o">.</span><span class="n">total_load</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s2">&quot;nbase_pv_buses&quot;</span><span class="p">:</span> <span class="n">nbase_pv_buses</span><span class="p">,</span>
                <span class="s2">&quot;pcent_base_pv&quot;</span><span class="p">:</span> <span class="n">pcent_base_pv</span><span class="p">,</span>
                <span class="s2">&quot;total_base_pv&quot;</span><span class="p">:</span> <span class="n">existing_pvs</span><span class="o">.</span><span class="n">total_existing_pv</span>
            <span class="p">})</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">(</span><span class="o">**</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div></div>


<div class="viewcode-block" id="PVScenarioGeneratorBase"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVScenarioGeneratorBase">[docs]</a><span class="k">class</span> <span class="nc">PVScenarioGeneratorBase</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feeder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize PV scenario generator class</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        feeder_path: str, the input path of a feeder model.</span>
<span class="sd">        config: SimpleNamespace, the pv deployment config namespace.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feeder_path</span> <span class="o">=</span> <span class="n">feeder_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">substation_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">feeder_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_cycle</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer_types</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@property</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">deployment_cycles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return a list of cicyles for generating pv scenarios&quot;&quot;&quot;</span>

<div class="viewcode-block" id="PVScenarioGeneratorBase.get_feeder_name"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVScenarioGeneratorBase.get_feeder_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_feeder_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return the feeder name&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feeder_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="PVScenarioGeneratorBase.get_master_file"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVScenarioGeneratorBase.get_master_file">[docs]</a>    <span class="k">def</span> <span class="nf">get_master_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return the full path of master file&quot;&quot;&quot;</span>
        <span class="n">master_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">master_filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">master_file</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; not found in &#39;</span><span class="si">%s</span><span class="s2">&#39;. System exits!&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">master_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">feeder_path</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">master_file</span></div>

<div class="viewcode-block" id="PVScenarioGeneratorBase.load_pvdss_instance"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVScenarioGeneratorBase.load_pvdss_instance">[docs]</a>    <span class="k">def</span> <span class="nf">load_pvdss_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PVDSSInstance</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Setup DSS handler for master dss file processing&quot;&quot;&quot;</span>
        <span class="n">master_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_master_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feeder_path</span><span class="p">)</span>
        <span class="n">pvdss_instance</span> <span class="o">=</span> <span class="n">PVDSSInstance</span><span class="p">(</span><span class="n">master_file</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lock_file</span> <span class="o">=</span> <span class="n">master_file</span> <span class="o">+</span> <span class="s2">&quot;.lock&quot;</span>
            <span class="k">with</span> <span class="n">SoftFileLock</span><span class="p">(</span><span class="n">lock_file</span><span class="o">=</span><span class="n">lock_file</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">900</span><span class="p">):</span>
                <span class="n">pvdss_instance</span><span class="o">.</span><span class="n">convert_to_ascii</span><span class="p">()</span>
                <span class="n">pvdss_instance</span><span class="o">.</span><span class="n">disable_loadshapes_redirect</span><span class="p">()</span>
                <span class="n">pvdss_instance</span><span class="o">.</span><span class="n">load_feeder</span><span class="p">()</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="n">pvdss_instance</span><span class="o">.</span><span class="n">ensure_energy_meter</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                    <span class="n">pvdss_instance</span><span class="o">.</span><span class="n">load_feeder</span><span class="p">()</span>  <span class="c1"># Need to reload after master file updated.</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed to load master file - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">master_file</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">pvdss_instance</span></div>

<div class="viewcode-block" id="PVScenarioGeneratorBase.deploy_all_pv_scenarios"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVScenarioGeneratorBase.deploy_all_pv_scenarios">[docs]</a>    <span class="k">def</span> <span class="nf">deploy_all_pv_scenarios</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Given a feeder path, generate all PV scenarios for the feeder&quot;&quot;&quot;</span>
        <span class="n">feeder_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_feeder_name</span><span class="p">()</span>
        <span class="n">pvdss_instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_pvdss_instance</span><span class="p">()</span>

        <span class="c1"># total load</span>
        <span class="n">total_loads</span> <span class="o">=</span> <span class="n">pvdss_instance</span><span class="o">.</span><span class="n">get_total_loads</span><span class="p">()</span>
        <span class="n">feeder_stats</span> <span class="o">=</span> <span class="n">pvdss_instance</span><span class="o">.</span><span class="n">get_feeder_stats</span><span class="p">(</span><span class="n">total_loads</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">total_loads</span><span class="o">.</span><span class="n">total_load</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">feeder_stats_string</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">feeder_stats</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Failed to generate PV scenarios on feeder - </span><span class="si">%s</span><span class="s2">, stats: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">feeder_name</span><span class="p">,</span> <span class="n">feeder_stats_string</span>
            <span class="p">)</span>
            <span class="k">raise</span>

        <span class="c1"># combined bus distance</span>
        <span class="n">customer_distance</span> <span class="o">=</span> <span class="n">pvdss_instance</span><span class="o">.</span><span class="n">get_customer_distance</span><span class="p">()</span>
        <span class="n">highv_buses</span> <span class="o">=</span> <span class="n">pvdss_instance</span><span class="o">.</span><span class="n">get_highv_buses</span><span class="p">()</span>
        <span class="n">combined_bus_distance</span> <span class="o">=</span> <span class="n">pvdss_instance</span><span class="o">.</span><span class="n">combine_bus_distances</span><span class="p">(</span><span class="n">customer_distance</span><span class="p">,</span> <span class="n">highv_buses</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">combined_bus_distance</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Check your feeder model for &#39;</span><span class="si">%s</span><span class="s2">&#39;.</span><span class="se">\n\</span>
<span class="s2">                The bus distance array does not look correct. Maximum bus distance = 0.00 km&quot;</span><span class="p">,</span>
                <span class="n">feeder_name</span>
            <span class="p">)</span>
        <span class="n">hv_bus_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sa">f</span><span class="s2">&quot;Large_</span><span class="si">{</span><span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">k</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">highv_buses</span><span class="o">.</span><span class="n">hv_bus_distance</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="c1"># existing pvs</span>
        <span class="n">existing_pvs</span> <span class="o">=</span> <span class="n">pvdss_instance</span><span class="o">.</span><span class="n">get_existing_pvs</span><span class="p">()</span>
        <span class="n">base_existing_pv</span> <span class="o">=</span> <span class="n">existing_pvs</span><span class="o">.</span><span class="n">existing_pv</span>
        <span class="n">feeder_stats</span> <span class="o">=</span> <span class="n">pvdss_instance</span><span class="o">.</span><span class="n">get_feeder_stats</span><span class="p">(</span><span class="n">total_loads</span><span class="p">,</span> <span class="n">existing_pvs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">feeder_stats</span><span class="o">.</span><span class="n">pcent_base_pv</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_penetration</span><span class="p">:</span>
            <span class="n">feeder_stats_string</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">feeder_stats</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Failed to generate PV scenarios on feeder - </span><span class="si">%s</span><span class="s2">. </span><span class="se">\</span>
<span class="s2">                The existing PV amount exceeds the maximum penetration level of </span><span class="si">%s</span><span class="s2">\%. Stats: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">feeder_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cofig</span><span class="o">.</span><span class="n">max_penetration</span><span class="p">,</span> <span class="n">feeder_stats_string</span>
            <span class="p">)</span>
            <span class="k">raise</span>

        <span class="n">snum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sample_number</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">min_penetration</span>
        <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_penetration</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">penetration_step</span>
        <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">snum</span><span class="p">):</span>
            <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">+</span> <span class="n">sample</span><span class="p">)</span>
            <span class="n">existing_pv</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">base_existing_pv</span><span class="p">)</span>
            <span class="n">pv_records</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">penetration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">(</span>
                    <span class="n">base_existing_pv</span><span class="o">=</span><span class="n">base_existing_pv</span><span class="p">,</span>
                    <span class="n">total_load</span><span class="o">=</span><span class="n">total_loads</span><span class="o">.</span><span class="n">total_load</span><span class="p">,</span>
                    <span class="n">load_dict</span><span class="o">=</span><span class="n">total_loads</span><span class="o">.</span><span class="n">load_dict</span><span class="p">,</span>
                    <span class="n">bus_totalload</span><span class="o">=</span><span class="n">total_loads</span><span class="o">.</span><span class="n">bus_totalload</span><span class="p">,</span>
                    <span class="n">total_existing_pv</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">existing_pv</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                    <span class="n">existing_pv</span><span class="o">=</span><span class="n">existing_pv</span><span class="p">,</span>
                    <span class="n">hv_bus_distance</span><span class="o">=</span><span class="n">highv_buses</span><span class="o">.</span><span class="n">hv_bus_distance</span><span class="p">,</span>
                    <span class="n">customer_bus_distance</span><span class="o">=</span><span class="n">customer_distance</span><span class="o">.</span><span class="n">bus_distance</span><span class="p">,</span>
                    <span class="n">hv_bus_map</span><span class="o">=</span><span class="n">hv_bus_map</span><span class="p">,</span>
                    <span class="n">customer_bus_map</span><span class="o">=</span><span class="n">total_loads</span><span class="o">.</span><span class="n">customer_bus_map</span><span class="p">,</span>
                    <span class="n">bus_kv</span><span class="o">=</span><span class="n">highv_buses</span><span class="o">.</span><span class="n">bus_kv</span><span class="p">,</span>
                    <span class="n">pv_records</span><span class="o">=</span><span class="n">pv_records</span><span class="p">,</span>
                    <span class="n">penetration</span><span class="o">=</span><span class="n">penetration</span><span class="p">,</span>
                    <span class="n">sample</span><span class="o">=</span><span class="n">sample</span>
                <span class="p">)</span>
                <span class="n">existing_pv</span><span class="p">,</span> <span class="n">pv_records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deploy_pv_scenario</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">feeder_stats</span><span class="o">.</span><span class="vm">__dict__</span></div>

<div class="viewcode-block" id="PVScenarioGeneratorBase.get_metadata_directory"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVScenarioGeneratorBase.get_metadata_directory">[docs]</a>    <span class="k">def</span> <span class="nf">get_metadata_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the metadata directory of the feeder&quot;&quot;&quot;</span>
        <span class="n">metadata_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feeder_path</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">metadata_directory</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">metadata_directory</span></div>

<div class="viewcode-block" id="PVScenarioGeneratorBase.get_pv_deployments_path"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVScenarioGeneratorBase.get_pv_deployments_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_pv_deployments_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the root path of PV deployments&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feeder_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pv_deployments_dirname</span><span class="p">)</span></div>

<div class="viewcode-block" id="PVScenarioGeneratorBase.get_deployment_placement_paths"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVScenarioGeneratorBase.get_deployment_placement_paths">[docs]</a>    <span class="k">def</span> <span class="nf">get_deployment_placement_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return the placement path of PV deployments&quot;&quot;&quot;</span>
        <span class="n">root_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pv_deployments_path</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">placement</span><span class="p">:</span>
            <span class="n">placement_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">placement</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">placement_paths</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">Placement</span>
            <span class="p">]</span>
        <span class="k">return</span> <span class="n">placement_paths</span></div>

<div class="viewcode-block" id="PVScenarioGeneratorBase.get_pv_systems_file"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVScenarioGeneratorBase.get_pv_systems_file">[docs]</a>    <span class="k">def</span> <span class="nf">get_pv_systems_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">penetration</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return the path of PV depployment file&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">placement</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Placement should not be None&quot;</span>
        <span class="n">placement_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_deployment_placement_paths</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">penetration_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">placement_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">sample</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">penetration</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">penetration_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pv_systems_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">penetration_path</span><span class="p">,</span> <span class="n">PV_SYSTEMS_FILENAME</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pv_systems_file</span></div>

<div class="viewcode-block" id="PVScenarioGeneratorBase.deploy_pv_scenario"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVScenarioGeneratorBase.deploy_pv_scenario">[docs]</a>    <span class="k">def</span> <span class="nf">deploy_pv_scenario</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate PV deployments dss file in scenario</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data: SimpleNamespace, the data used for defining PV scenario</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict:</span>
<span class="sd">            The updated existing_pv</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pv_string</span> <span class="o">=</span> <span class="s2">&quot;! =====================PV SCENARIO FILE==============================</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">categorical_remaining_pvs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_categorical_remaining_pvs</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">bus_distances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bus_distances</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">customer_bus_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_customer_bus_map</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">priority_buses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_priority_buses</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">existing_pv</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">existing_pv</span>
        <span class="n">pv_records</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pv_records</span>

        <span class="n">undeployed_capacity</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">pv_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deployment_cycles</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_cycle</span> <span class="o">=</span> <span class="n">pv_type</span>
            <span class="n">remaining_pv_to_install</span> <span class="o">=</span> <span class="n">categorical_remaining_pvs</span><span class="p">[</span><span class="n">pv_type</span><span class="p">]</span> <span class="o">+</span> <span class="n">undeployed_capacity</span>
            <span class="n">bus_distance</span> <span class="o">=</span> <span class="n">bus_distances</span><span class="p">[</span><span class="n">pv_type</span><span class="p">]</span>
            <span class="n">customer_bus_map</span> <span class="o">=</span> <span class="n">customer_bus_map</span><span class="p">[</span><span class="n">pv_type</span><span class="p">]</span>

            <span class="n">ncs</span><span class="p">,</span> <span class="n">subset_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">remaining_pv_to_install</span> <span class="o">&gt;</span> <span class="n">PV_INSTALLATION_TOLERANCE</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">subset_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pv_upscale</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">bus</span> <span class="ow">in</span> <span class="n">priority_buses</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">bus</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">base_existing_pv</span><span class="p">:</span>
                                <span class="n">base_min_pv_size</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">base_existing_pv</span><span class="p">[</span><span class="n">bus</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">base_min_pv_size</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">if</span> <span class="n">base_min_pv_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="n">min_pv_size</span> <span class="o">=</span> <span class="n">existing_pv</span><span class="p">[</span><span class="n">bus</span><span class="p">]</span>
                            <span class="n">max_pv_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_maximum_pv_size</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                            <span class="n">random_pv_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_pv_size_from_pdf</span><span class="p">(</span><span class="n">min_pv_size</span><span class="p">,</span> <span class="n">max_pv_size</span><span class="p">)</span>
                            <span class="n">pv_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">random_pv_size</span><span class="p">,</span> <span class="n">min_pv_size</span> <span class="o">+</span> <span class="n">remaining_pv_to_install</span><span class="p">)</span>
                            <span class="n">pv_added_capacity</span> <span class="o">=</span> <span class="n">pv_size</span> <span class="o">-</span> <span class="n">min_pv_size</span>
                            <span class="n">remaining_pv_to_install</span> <span class="o">-=</span> <span class="n">pv_added_capacity</span>
                            <span class="n">pv_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_pv_string</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">pv_type</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">pv_size</span><span class="p">,</span> <span class="n">pv_string</span><span class="p">)</span>
                            <span class="n">pv_records</span><span class="p">[</span><span class="n">bus</span><span class="p">]</span> <span class="o">=</span> <span class="n">pv_size</span>
                            <span class="n">existing_pv</span><span class="p">[</span><span class="n">bus</span><span class="p">]</span> <span class="o">=</span> <span class="n">pv_size</span>
                            <span class="n">ncs</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">bus</span> <span class="ow">in</span> <span class="n">priority_buses</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">bus</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">base_existing_pv</span><span class="p">:</span>
                                <span class="n">base_min_pv_size</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">base_existing_pv</span><span class="p">[</span><span class="n">bus</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">base_min_pv_size</span>
                            <span class="k">if</span> <span class="n">base_min_pv_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="n">min_pv_size</span> <span class="o">=</span> <span class="n">existing_pv</span><span class="p">[</span><span class="n">bus</span><span class="p">]</span>
                            <span class="n">pv_size</span> <span class="o">=</span> <span class="n">min_pv_size</span>
                            <span class="c1"># TODO: pv_added_capacity no effect now</span>
                            <span class="n">pv_added_capacity</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">remaining_pv_to_install</span> <span class="o">-=</span> <span class="n">pv_added_capacity</span>
                            <span class="n">pv_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_pv_string</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">pv_type</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">pv_size</span><span class="p">,</span> <span class="n">pv_string</span><span class="p">)</span>
                            <span class="n">pv_records</span><span class="p">[</span><span class="n">bus</span><span class="p">]</span> <span class="o">=</span> <span class="n">pv_size</span>
                            <span class="n">existing_pv</span><span class="p">[</span><span class="n">bus</span><span class="p">]</span> <span class="o">=</span> <span class="n">pv_size</span>

                <span class="n">subset_idx</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">candidate_bus_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pv_bus_subset</span><span class="p">(</span><span class="n">bus_distance</span><span class="p">,</span> <span class="n">subset_idx</span><span class="p">,</span> <span class="n">priority_buses</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">subset_idx</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">proximity_step</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;No </span><span class="si">%s</span><span class="s2"> file created on feeder - </span><span class="si">%s</span><span class="s2">, beacause capacity remains </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">PV_SYSTEMS_FILENAME</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">feeder_path</span><span class="p">,</span>
                        <span class="n">remaining_pv_to_install</span>
                    <span class="p">)</span>
                    <span class="k">break</span>

                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidate_bus_array</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">picked_candidate</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">candidate_bus_array</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">picked_candidate</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">base_existing_pv</span><span class="p">:</span>
                        <span class="n">base_min_pv_size</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">base_existing_pv</span><span class="p">[</span><span class="n">picked_candidate</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">base_min_pv_size</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">picked_candidate</span> <span class="ow">in</span> <span class="n">existing_pv</span><span class="p">:</span>
                        <span class="n">min_pv_size</span> <span class="o">=</span> <span class="n">existing_pv</span><span class="p">[</span><span class="n">picked_candidate</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">min_pv_size</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">base_min_pv_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">min_pv_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pv_upscale</span><span class="p">):</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">max_pv_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_maximum_pv_size</span><span class="p">(</span><span class="n">picked_candidate</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                        <span class="n">random_pv_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_pv_size_from_pdf</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_pv_size</span><span class="p">)</span>
                        <span class="n">pv_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">random_pv_size</span><span class="p">,</span> <span class="n">remaining_pv_to_install</span><span class="p">)</span>
                        <span class="n">pv_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_pv_string</span><span class="p">(</span><span class="n">picked_candidate</span><span class="p">,</span> <span class="n">pv_type</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">pv_size</span><span class="p">,</span> <span class="n">pv_string</span><span class="p">)</span>
                        <span class="n">pv_records</span><span class="p">[</span><span class="n">picked_candidate</span><span class="p">]</span> <span class="o">=</span> <span class="n">pv_size</span>
                        <span class="n">existing_pv</span><span class="p">[</span><span class="n">picked_candidate</span><span class="p">]</span> <span class="o">=</span> <span class="n">pv_size</span>
                        <span class="n">pv_added_capacity</span> <span class="o">=</span> <span class="n">pv_size</span>
                        <span class="n">remaining_pv_to_install</span> <span class="o">-=</span> <span class="n">pv_added_capacity</span>
                        <span class="n">ncs</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">candidate_bus_array</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">picked_candidate</span><span class="p">)</span>

                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">remaining_pv_to_install</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">PV_INSTALLATION_TOLERANCE</span><span class="p">:</span>
                        <span class="k">break</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pv_records</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_pv_string</span><span class="p">(</span><span class="n">pv_string</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">remaining_pv_to_install</span> <span class="o">&gt;</span> <span class="n">PV_INSTALLATION_TOLERANCE</span><span class="p">:</span>
                    <span class="n">undeployed_capacity</span> <span class="o">=</span> <span class="n">remaining_pv_to_install</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">pv_records</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pv_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;New PVSystem.&quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_pv_string</span><span class="p">(</span><span class="n">pv_string</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Sample: </span><span class="si">%s</span><span class="s2">, Placement: </span><span class="si">%s</span><span class="s2">, @penetration </span><span class="si">%s</span><span class="s2">, number of new installable PVs: </span><span class="si">%s</span><span class="s2">, Remain_to_install: </span><span class="si">%s</span><span class="s2"> kW&quot;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">placement</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">penetration</span><span class="p">,</span>
                    <span class="n">ncs</span><span class="p">,</span>
                    <span class="n">remaining_pv_to_install</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">subset_idx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">proximity_step</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
                    <span class="k">break</span>

        <span class="k">return</span> <span class="n">existing_pv</span><span class="p">,</span> <span class="n">pv_records</span></div>

<div class="viewcode-block" id="PVScenarioGeneratorBase.get_total_pv"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVScenarioGeneratorBase.get_total_pv">[docs]</a>    <span class="k">def</span> <span class="nf">get_total_pv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return total PV, including PV already installed and remaining to install&quot;&quot;&quot;</span>
        <span class="n">total_pv</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">total_load</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">penetration</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="k">return</span> <span class="n">total_pv</span></div>

<div class="viewcode-block" id="PVScenarioGeneratorBase.get_all_remaining_pv_to_install"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVScenarioGeneratorBase.get_all_remaining_pv_to_install">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_remaining_pv_to_install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return all remaining PV to install&quot;&quot;&quot;</span>
        <span class="n">total_pv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_total_pv</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">all_remaining_pv_to_install</span> <span class="o">=</span> <span class="n">total_pv</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">total_existing_pv</span>
        <span class="k">if</span> <span class="n">all_remaining_pv_to_install</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">minimum_penetration</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">total_existing_pv</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">total_load</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Failed to generate PV scenarios on feeder - </span><span class="si">%s</span><span class="s2">. </span><span class="se">\</span>
<span class="s2">                The system has more than the target PV penetration. </span><span class="se">\</span>
<span class="s2">                Please increase penetration to at least </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">feeder_path</span><span class="p">,</span> <span class="n">minimum_penetration</span>
            <span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">all_remaining_pv_to_install</span></div>

<div class="viewcode-block" id="PVScenarioGeneratorBase.get_priority_buses"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVScenarioGeneratorBase.get_priority_buses">[docs]</a>    <span class="k">def</span> <span class="nf">get_priority_buses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return a list of priority buses.&quot;&quot;&quot;</span>
        <span class="n">priority_buses</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">existing_pv</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">priority_buses</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">bus_totalload</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Beaware - Sample: </span><span class="si">%s</span><span class="s2">, Placement: </span><span class="si">%s</span><span class="s2">, @penetration </span><span class="si">%s</span><span class="s2">, all buses already have PV installed.&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">placement</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">penetration</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">priority_buses</span></div>

<div class="viewcode-block" id="PVScenarioGeneratorBase.get_categorical_remaining_pvs"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVScenarioGeneratorBase.get_categorical_remaining_pvs">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_categorical_remaining_pvs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return remaining sall, large PV to install&quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="PVScenarioGeneratorBase.get_bus_distances"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVScenarioGeneratorBase.get_bus_distances">[docs]</a>    <span class="k">def</span> <span class="nf">get_bus_distances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return bus distance of large/small category&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">DeploymentCategory</span><span class="o">.</span><span class="n">SMALL</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">customer_bus_distance</span><span class="p">,</span>
            <span class="n">DeploymentCategory</span><span class="o">.</span><span class="n">LARGE</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">hv_bus_distance</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="PVScenarioGeneratorBase.get_customer_bus_map"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVScenarioGeneratorBase.get_customer_bus_map">[docs]</a>    <span class="k">def</span> <span class="nf">get_customer_bus_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">DeploymentCategory</span><span class="o">.</span><span class="n">SMALL</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">customer_bus_map</span><span class="p">,</span>
            <span class="n">DeploymentCategory</span><span class="o">.</span><span class="n">LARGE</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">hv_bus_map</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="PVScenarioGeneratorBase.get_maximum_pv_size"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVScenarioGeneratorBase.get_maximum_pv_size">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_maximum_pv_size</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">bus</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return maximum pv size&quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="PVScenarioGeneratorBase.generate_pv_size_from_pdf"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVScenarioGeneratorBase.generate_pv_size_from_pdf">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">generate_pv_size_from_pdf</span><span class="p">(</span><span class="n">min_size</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">max_size</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">pdf</span><span class="p">:</span> <span class="n">Sequence</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="c1"># TODO: A placeholder function for later update</span>
        <span class="n">pv_size</span> <span class="o">=</span> <span class="n">max_size</span>
        <span class="k">return</span> <span class="n">pv_size</span></div>

<div class="viewcode-block" id="PVScenarioGeneratorBase.add_pv_string"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVScenarioGeneratorBase.add_pv_string">[docs]</a>    <span class="k">def</span> <span class="nf">add_pv_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bus</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pv_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pv_size</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">pv_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add PV string to exiting string&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">round</span><span class="p">(</span><span class="n">pv_size</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pv_string</span>

        <span class="n">pv_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_pv_name</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">pv_type</span><span class="p">)</span>
        <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">bus</span><span class="p">)</span>
        <span class="n">node_list</span> <span class="o">=</span> <span class="n">bus</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="n">ph</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">node_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">ph</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="s2">&quot;delta&quot;</span>
            <span class="n">kv</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">kVBase</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ph</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">ph</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="s2">&quot;wye&quot;</span>
            <span class="n">kv</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">kVBase</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ph</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="s2">&quot;wye&quot;</span>
            <span class="k">if</span> <span class="s2">&quot;0&quot;</span> <span class="ow">in</span> <span class="n">node_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">kv</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">kVBase</span><span class="p">(),</span> <span class="mi">4</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kv</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">kVBase</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">ph</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="s2">&quot;wye&quot;</span>
            <span class="n">kv</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">kVBase</span><span class="p">(),</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">pv_size</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">pv_size</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">new_pv_string</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;New PVSystem.</span><span class="si">{</span><span class="n">pv_name</span><span class="si">}</span><span class="s2"> phases=</span><span class="si">{</span><span class="n">ph</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;bus1=</span><span class="si">{</span><span class="n">bus</span><span class="si">}</span><span class="s2"> kv=</span><span class="si">{</span><span class="n">kv</span><span class="si">}</span><span class="s2"> irradiance=1 &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Pmpp=</span><span class="si">{</span><span class="n">pv_size</span><span class="si">}</span><span class="s2"> pctPmpp=100 kVA=</span><span class="si">{</span><span class="n">pv_size</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;conn=wye %cutin=0.1 %cutout=0.1 &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Vmaxpu=1.2</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">pv_string</span> <span class="o">+=</span> <span class="n">new_pv_string</span>
        <span class="k">return</span> <span class="n">pv_string</span></div>
    
<div class="viewcode-block" id="PVScenarioGeneratorBase.generate_pv_name"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVScenarioGeneratorBase.generate_pv_name">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">generate_pv_name</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">pv_type</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pv_type</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">bus</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_pv&quot;</span></div>

<div class="viewcode-block" id="PVScenarioGeneratorBase.write_pv_string"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVScenarioGeneratorBase.write_pv_string">[docs]</a>    <span class="k">def</span> <span class="nf">write_pv_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pv_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Write PV string to PV deployment file.&quot;&quot;&quot;</span>
        <span class="n">total_pv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_total_pv</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">pv_systems_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pv_systems_file</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">penetration</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;// PV Scenario for </span><span class="si">{</span><span class="n">total_pv</span><span class="si">}</span><span class="s2"> kW total size, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Scenario type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">placement</span><span class="si">}</span><span class="s2">, Sample </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">sample</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;and penetration </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">penetration</span><span class="si">}</span><span class="s2">% (PV to load ratio) </span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pv_systems_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pv_string</span><span class="p">)</span></div>

<div class="viewcode-block" id="PVScenarioGeneratorBase.get_pv_bus_subset"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVScenarioGeneratorBase.get_pv_bus_subset">[docs]</a>    <span class="k">def</span> <span class="nf">get_pv_bus_subset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bus_distance</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">subset_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">priority_buses</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return candidate buses&quot;&quot;&quot;</span>
        <span class="n">max_dist</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bus_distance</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">min_dist</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bus_distance</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">placement</span> <span class="o">==</span> <span class="n">Placement</span><span class="o">.</span><span class="n">CLOSE</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">lb_dist</span> <span class="o">=</span> <span class="p">(</span><span class="n">subset_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">proximity_step</span> <span class="o">*</span> <span class="n">max_dist</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>
            <span class="n">ub_dist</span> <span class="o">=</span> <span class="n">subset_idx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">proximity_step</span> <span class="o">*</span> <span class="n">max_dist</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">placement</span> <span class="o">==</span> <span class="n">Placement</span><span class="o">.</span><span class="n">FAR</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">ub_dist</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="n">subset_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">proximity_step</span><span class="p">)</span> <span class="o">*</span> <span class="n">max_dist</span> <span class="o">/</span> <span class="mi">100</span>
            <span class="n">lb_dist</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="n">subset_idx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">proximity_step</span><span class="p">)</span> <span class="o">*</span> <span class="n">max_dist</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">placement</span> <span class="o">==</span> <span class="n">Placement</span><span class="o">.</span><span class="n">RANDOM</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">lb_dist</span> <span class="o">=</span> <span class="n">min_dist</span>
            <span class="n">ub_dist</span> <span class="o">=</span> <span class="n">max_dist</span>

        <span class="n">candidate_bus_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">bus_distance</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;=</span> <span class="n">lb_dist</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">&lt;=</span> <span class="n">ub_dist</span>
        <span class="p">}</span>
        <span class="n">candidate_bus_array</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">candidate_bus_map</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">priority_buses</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">candidate_bus_array</span></div>

<div class="viewcode-block" id="PVScenarioGeneratorBase.compute_average_pv_distance"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVScenarioGeneratorBase.compute_average_pv_distance">[docs]</a>    <span class="k">def</span> <span class="nf">compute_average_pv_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bus_distance</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">existing_pv</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Compute the average PV distance&quot;&quot;&quot;</span>
        <span class="n">slack_dico</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">bus_distance</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">existing_pv</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">bus_distance</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="p">}</span>
        <span class="n">average_pv_distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">slack_dico</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
        <span class="k">return</span> <span class="n">average_pv_distance</span></div>

<div class="viewcode-block" id="PVScenarioGeneratorBase.get_pv_shapes_file"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVScenarioGeneratorBase.get_pv_shapes_file">[docs]</a>    <span class="k">def</span> <span class="nf">get_pv_shapes_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return the loadshapes file in feeder path&quot;&quot;&quot;</span>
        <span class="n">pv_shapes_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">PV_SHAPES_FILENAME</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pv_shapes_file</span></div>

<div class="viewcode-block" id="PVScenarioGeneratorBase.create_all_pv_configs"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVScenarioGeneratorBase.create_all_pv_configs">[docs]</a>    <span class="k">def</span> <span class="nf">create_all_pv_configs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create PV configs JSON file&quot;&quot;&quot;</span>
        <span class="n">root_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pv_deployments_path</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">root_path</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Deployment path </span><span class="si">%s</span><span class="s2"> not exis under </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pv_deployments_dirname</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">feeder_path</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>
        
        <span class="n">config_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pv_shapes_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pv_shapes_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feeder_path</span><span class="p">)</span>
        <span class="n">placement_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_deployment_placement_paths</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">placement_path</span> <span class="ow">in</span> <span class="n">placement_paths</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">placement_path</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="n">get_subdir_names</span><span class="p">(</span><span class="n">placement_path</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
                <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">sample</span><span class="p">))</span>
                <span class="n">sample_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">placement_path</span><span class="p">,</span> <span class="n">sample</span><span class="p">)</span>
                <span class="n">pv_systems</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="n">pv_configs</span><span class="p">,</span> <span class="n">pv_profiles</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">pen</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">sample_path</span><span class="p">):</span>
                    <span class="n">pen_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sample_path</span><span class="p">,</span> <span class="n">pen</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">pen_dir</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="n">pv_systems_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pen_dir</span><span class="p">,</span> <span class="n">PV_SYSTEMS_FILENAME</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pv_systems_file</span><span class="p">):</span>
                        <span class="n">pv_conf</span><span class="p">,</span> <span class="n">pv_prof</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assign_profile</span><span class="p">(</span><span class="n">pv_systems_file</span><span class="p">,</span> <span class="n">pv_shapes_file</span><span class="p">,</span> <span class="n">pv_systems</span><span class="p">)</span>
                        <span class="n">pv_configs</span> <span class="o">+=</span> <span class="n">pv_conf</span>
                        <span class="n">pv_profiles</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pv_prof</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">attach_profile</span><span class="p">(</span><span class="n">pv_systems_file</span><span class="p">,</span> <span class="n">pv_profiles</span><span class="p">)</span>
                <span class="n">final</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;pv_systems&quot;</span><span class="p">:</span> <span class="n">pv_configs</span><span class="p">}</span>
                <span class="n">pv_config_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_pv_config</span><span class="p">(</span><span class="n">final</span><span class="p">,</span> <span class="n">sample_path</span><span class="p">)</span>
                <span class="n">config_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pv_config_file</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> PV config files generated for feeder - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">config_files</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">feeder_path</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Attached PV profiles to PV systems for feeder - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">feeder_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">config_files</span></div>

<div class="viewcode-block" id="PVScenarioGeneratorBase.get_customer_types"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVScenarioGeneratorBase.get_customer_types">[docs]</a>    <span class="k">def</span> <span class="nf">get_customer_types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># NOTE: In Loads.dss file, each line contains string like &quot;yearly=com_kw_29321_pu&quot;.</span>
        <span class="c1"># However &quot;yearly=xxxx&quot; only exists in the original loads file, but not the transformed</span>
        <span class="c1"># one during the PV deployment process. After the deployments, the original</span>
        <span class="c1"># loads files were renmaed back, and would not exist.</span>
        <span class="n">loads_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feeder_path</span><span class="p">,</span> <span class="n">ORIGINAL_LOADS_FILENAME</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">loads_file</span><span class="p">):</span>
            <span class="n">loads_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feeder_path</span><span class="p">,</span> <span class="n">LOADS_FILENAME</span><span class="p">)</span>
        
        <span class="n">bus_key</span> <span class="o">=</span> <span class="s2">&quot;bus1=&quot;</span>
        <span class="n">shape_key</span> <span class="o">=</span> <span class="s2">&quot;yearly=&quot;</span>
        <span class="n">load_key</span> <span class="o">=</span> <span class="s2">&quot;Load.&quot;</span>

        <span class="n">bus_customer_types</span><span class="p">,</span> <span class="n">load_customer_types</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">loads_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">bus_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">continue</span>
                <span class="n">bus</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">bus_key</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">shape_name</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">shape_key</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">load</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">load_key</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;com_&quot;</span> <span class="ow">in</span> <span class="n">shape_name</span><span class="p">:</span>
                    <span class="n">customer_type</span> <span class="o">=</span> <span class="s2">&quot;commercial&quot;</span>
                <span class="k">elif</span> <span class="s2">&quot;res_&quot;</span> <span class="ow">in</span> <span class="n">shape_name</span><span class="p">:</span>
                    <span class="n">customer_type</span> <span class="o">=</span> <span class="s2">&quot;residential&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">customer_type</span> <span class="o">=</span> <span class="kc">None</span>
                
                <span class="c1"># NOTE: here assume all nodes on same bus have same customer type</span>
                <span class="n">bus_customer_types</span><span class="p">[</span><span class="n">bus</span><span class="p">]</span> <span class="o">=</span> <span class="n">customer_type</span>
                <span class="n">load_customer_types</span><span class="p">[</span><span class="n">load</span><span class="p">]</span> <span class="o">=</span> <span class="n">customer_type</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;bus_customer_types&quot;</span><span class="p">:</span> <span class="n">bus_customer_types</span><span class="p">,</span>
            <span class="s2">&quot;load_customer_types&quot;</span><span class="p">:</span> <span class="n">load_customer_types</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="PVScenarioGeneratorBase.assign_profile"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVScenarioGeneratorBase.assign_profile">[docs]</a>    <span class="k">def</span> <span class="nf">assign_profile</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pv_systems_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">pv_shapes_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">pv_systems</span><span class="p">:</span> <span class="nb">set</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Assign PV profile to PV systems.&quot;&quot;&quot;</span>
        <span class="n">pv_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pvsys</span><span class="p">(</span><span class="n">pv_systems_file</span><span class="p">)</span>
        <span class="n">shape_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shape_list</span><span class="p">(</span><span class="n">pv_shapes_file</span><span class="p">)</span>
        <span class="n">pv_conf</span><span class="p">,</span> <span class="n">pv_prof</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">pv_name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pv_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">pv_value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;pmpp&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pv_name</span> <span class="ow">in</span> <span class="n">pv_systems</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">pv_value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">:</span>
                <span class="n">control_name</span> <span class="o">=</span> <span class="s2">&quot;volt-var&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">control_name</span> <span class="o">=</span> <span class="s2">&quot;pf1&quot;</span>
            <span class="n">pv_profile</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">shape_list</span><span class="p">)</span>

            <span class="n">pv_conf</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">pv_name</span><span class="p">,</span>
                <span class="s2">&quot;pydss_controller&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;controller_type&quot;</span><span class="p">:</span> <span class="s2">&quot;PvController&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">control_name</span>
                <span class="p">},</span>
                <span class="s2">&quot;pv_profile&quot;</span><span class="p">:</span> <span class="n">pv_profile</span><span class="p">,</span>
                <span class="s2">&quot;customer_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bus_customer_type</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;bus&quot;</span><span class="p">])</span>
            <span class="p">})</span>
            <span class="n">pv_systems</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pv_name</span><span class="p">)</span>
            <span class="n">pv_prof</span><span class="p">[</span><span class="n">pv_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pv_profile</span>
        <span class="k">return</span> <span class="n">pv_conf</span><span class="p">,</span> <span class="n">pv_prof</span></div>
    
<div class="viewcode-block" id="PVScenarioGeneratorBase.get_bus_customer_type"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVScenarioGeneratorBase.get_bus_customer_type">[docs]</a>    <span class="k">def</span> <span class="nf">get_bus_customer_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bus</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer_types</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">customer_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_customer_types</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer_types</span><span class="p">[</span><span class="s2">&quot;bus_customer_types&quot;</span><span class="p">][</span><span class="n">bus</span><span class="p">]</span></div>

<div class="viewcode-block" id="PVScenarioGeneratorBase.get_pvsys"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVScenarioGeneratorBase.get_pvsys">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_pvsys</span><span class="p">(</span><span class="n">pv_systems_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return a mapping of PV systems&quot;&quot;&quot;</span>
        <span class="n">pv_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pv_systems_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                <span class="n">lowered_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="s2">&quot;pvsystem&quot;</span> <span class="ow">in</span> <span class="n">lowered_line</span><span class="p">:</span>
                    <span class="n">pmpp</span> <span class="o">=</span> <span class="n">lowered_line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;pmpp=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">pv_name</span> <span class="o">=</span> <span class="n">lowered_line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;pvsystem.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">bus</span> <span class="o">=</span> <span class="n">lowered_line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;bus1=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">pv_dict</span><span class="p">[</span><span class="n">pv_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;pmpp&quot;</span><span class="p">:</span> <span class="n">pmpp</span><span class="p">,</span>
                        <span class="s2">&quot;bus&quot;</span><span class="p">:</span> <span class="n">bus</span>
                    <span class="p">}</span>
        <span class="k">return</span> <span class="n">pv_dict</span></div>

<div class="viewcode-block" id="PVScenarioGeneratorBase.get_shape_list"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVScenarioGeneratorBase.get_shape_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_shape_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pv_shapes_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return a list of loadshapes&quot;&quot;&quot;</span>
        <span class="n">shape_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pv_shapes_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                <span class="n">lowered_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="s2">&quot;loadshape&quot;</span> <span class="ow">in</span> <span class="n">lowered_line</span><span class="p">:</span>
                    <span class="n">shape_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lowered_line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;loadshape.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">shape_list</span></div>

<div class="viewcode-block" id="PVScenarioGeneratorBase.save_pv_config"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVScenarioGeneratorBase.save_pv_config">[docs]</a>    <span class="k">def</span> <span class="nf">save_pv_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pv_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">sample_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Save PV configuration to JSON file&quot;&quot;&quot;</span>
        <span class="n">pv_config_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sample_path</span><span class="p">,</span> <span class="n">PV_CONFIG_FILENAME</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pv_config_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pv_config</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;PV config file generated - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pv_config_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pv_config_file</span></div>
    
<div class="viewcode-block" id="PVScenarioGeneratorBase.attach_profile"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVScenarioGeneratorBase.attach_profile">[docs]</a>    <span class="k">def</span> <span class="nf">attach_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pv_systems_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pv_profiles</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Attach PV profile to each system with &#39;yearly=&lt;pv-profile&gt;&#39; in PVSystems.dss&quot;&quot;&quot;</span>
        <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;new pvsystem\.([^\s]+)&quot;</span><span class="p">)</span>
        
        <span class="n">updated_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pv_systems_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fr</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fr</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                <span class="n">lowered_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="s2">&quot;new pvsystem&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lowered_line</span> <span class="ow">or</span> <span class="s2">&quot;yearly&quot;</span> <span class="ow">in</span> <span class="n">lowered_line</span><span class="p">:</span>
                    <span class="n">updated_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">continue</span>
                
                <span class="n">match</span> <span class="o">=</span> <span class="n">regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lowered_line</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">match</span><span class="p">,</span> <span class="n">line</span>
                <span class="n">pv_name</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">pv_profile</span> <span class="o">=</span> <span class="n">pv_profiles</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pv_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pv_profile</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No PV profile founded for </span><span class="si">{</span><span class="n">pv_name</span><span class="si">}</span><span class="s2"> - [</span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">]]&quot;</span><span class="p">)</span>
                <span class="n">new_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; yearly=</span><span class="si">{</span><span class="n">pv_profile</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">updated_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pv_systems_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fw</span><span class="p">:</span>
            <span class="n">fw</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">updated_data</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="PVScenarioGeneratorBase.create_pv_systems_sum_group_file"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVScenarioGeneratorBase.create_pv_systems_sum_group_file">[docs]</a>    <span class="k">def</span> <span class="nf">create_pv_systems_sum_group_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pv_config_files</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Walk through all PV configs created in each sample, and generate a sum group JSON file</span>
<span class="sd">        at the feeder level.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pv_config_files: list,</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str,</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sum_groups</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">config_file</span> <span class="ow">in</span> <span class="n">pv_config_files</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">config_file</span><span class="p">)[</span><span class="s2">&quot;pv_systems&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">sum_groups</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;customer_type&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;sum_groups&quot;</span><span class="p">:[</span>
                <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">customer_type</span><span class="p">,</span> <span class="s2">&quot;elements&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">elements</span><span class="p">)}</span>
                <span class="k">for</span> <span class="n">customer_type</span><span class="p">,</span> <span class="n">elements</span> <span class="ow">in</span> <span class="n">sum_groups</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_metadata_directory</span><span class="p">(),</span> <span class="n">PV_SYSTEMS_SUM_GROUP_FILENAME</span><span class="p">)</span>
        <span class="n">dump_data</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;PV Systems sum group file created - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="PVScenarioGeneratorBase.create_loads_sum_group_file"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVScenarioGeneratorBase.create_loads_sum_group_file">[docs]</a>    <span class="k">def</span> <span class="nf">create_loads_sum_group_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a sum group file for loads based on customer types&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer_types</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">customer_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_customer_types</span><span class="p">()</span>
        <span class="n">customer_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer_types</span><span class="p">[</span><span class="s2">&quot;load_customer_types&quot;</span><span class="p">]</span>

        <span class="n">sum_groups</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">load</span><span class="p">,</span> <span class="n">customer_type</span> <span class="ow">in</span> <span class="n">customer_types</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">sum_groups</span><span class="p">[</span><span class="n">customer_type</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">load</span><span class="p">)</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;sum_groups&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">customer_type</span><span class="p">,</span> <span class="s2">&quot;elements&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">elements</span><span class="p">)}</span>
                <span class="k">for</span> <span class="n">customer_type</span><span class="p">,</span> <span class="n">elements</span> <span class="ow">in</span> <span class="n">sum_groups</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_metadata_directory</span><span class="p">(),</span> <span class="n">LOADS_SUM_GROUP_FILENAME</span><span class="p">)</span>
        <span class="n">dump_data</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loads sum group file created - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="LargePVScenarioGenerator"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.LargePVScenarioGenerator">[docs]</a><span class="k">class</span> <span class="nc">LargePVScenarioGenerator</span><span class="p">(</span><span class="n">PVScenarioGeneratorBase</span><span class="p">):</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">deployment_cycles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">DeploymentCategory</span><span class="o">.</span><span class="n">LARGE</span><span class="p">]</span>

<div class="viewcode-block" id="LargePVScenarioGenerator.get_categorical_remaining_pvs"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.LargePVScenarioGenerator.get_categorical_remaining_pvs">[docs]</a>    <span class="k">def</span> <span class="nf">get_categorical_remaining_pvs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">all_remaining_pv_to_install</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_remaining_pv_to_install</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">categorical_remaining_pvs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">DeploymentCategory</span><span class="o">.</span><span class="n">LARGE</span><span class="p">:</span> <span class="n">all_remaining_pv_to_install</span><span class="p">,</span>
            <span class="n">DeploymentCategory</span><span class="o">.</span><span class="n">SMALL</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">categorical_remaining_pvs</span></div>

<div class="viewcode-block" id="LargePVScenarioGenerator.get_maximum_pv_size"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.LargePVScenarioGenerator.get_maximum_pv_size">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_maximum_pv_size</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">bus</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">max_bus_pv_size</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">max_bus_pv_size</span></div></div>


<div class="viewcode-block" id="SmallPVScenarioGenerator"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.SmallPVScenarioGenerator">[docs]</a><span class="k">class</span> <span class="nc">SmallPVScenarioGenerator</span><span class="p">(</span><span class="n">PVScenarioGeneratorBase</span><span class="p">):</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">deployment_cycles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">DeploymentCategory</span><span class="o">.</span><span class="n">SMALL</span><span class="p">]</span>

<div class="viewcode-block" id="SmallPVScenarioGenerator.get_categorical_remaining_pvs"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.SmallPVScenarioGenerator.get_categorical_remaining_pvs">[docs]</a>    <span class="k">def</span> <span class="nf">get_categorical_remaining_pvs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">all_remaining_pv_to_install</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_remaining_pv_to_install</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">categorical_remaining_pvs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">DeploymentCategory</span><span class="o">.</span><span class="n">LARGE</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">DeploymentCategory</span><span class="o">.</span><span class="n">SMALL</span><span class="p">:</span> <span class="n">all_remaining_pv_to_install</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">categorical_remaining_pvs</span></div>

<div class="viewcode-block" id="SmallPVScenarioGenerator.get_maximum_pv_size"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.SmallPVScenarioGenerator.get_maximum_pv_size">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_maximum_pv_size</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">bus</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">,</span> <span class="n">max_load_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.1</span><span class="p">,</span>  <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">roof_area</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;roof_area&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">pv_efficiency</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pv_efficiency&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">customer_annual_kwh</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;customer_annual_kwh&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">annual_sun_hours</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;annual_sun_hours&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">pv_size_array</span> <span class="o">=</span> <span class="p">[</span><span class="n">max_load_factor</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">bus_totalload</span><span class="p">[</span><span class="n">bus</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">roof_area</span> <span class="ow">and</span> <span class="n">pv_efficiency</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">roof_area</span><span class="p">[</span><span class="n">bus</span><span class="p">]</span> <span class="o">*</span> <span class="n">pv_efficiency</span>
            <span class="n">pv_size_array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">customer_annual_kwh</span> <span class="ow">and</span> <span class="n">annual_sun_hours</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">customer_annual_kwh</span><span class="p">[</span><span class="n">bus</span><span class="p">]</span> <span class="o">/</span> <span class="n">annual_sun_hours</span>
            <span class="n">pv_size_array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">max_bus_pv_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">pv_size_array</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">max_bus_pv_size</span></div></div>


<div class="viewcode-block" id="MixedPVScenarioGenerator"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.MixedPVScenarioGenerator">[docs]</a><span class="k">class</span> <span class="nc">MixedPVScenarioGenerator</span><span class="p">(</span><span class="n">PVScenarioGeneratorBase</span><span class="p">):</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">deployment_cycles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">DeploymentCategory</span><span class="o">.</span><span class="n">SMALL</span><span class="p">,</span> <span class="n">DeploymentCategory</span><span class="o">.</span><span class="n">LARGE</span><span class="p">]</span>

<div class="viewcode-block" id="MixedPVScenarioGenerator.get_categorical_remaining_pvs"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.MixedPVScenarioGenerator.get_categorical_remaining_pvs">[docs]</a>    <span class="k">def</span> <span class="nf">get_categorical_remaining_pvs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">all_remaining_pv_to_install</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_remaining_pv_to_install</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">small_pv_to_install</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">percent_shares</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">all_remaining_pv_to_install</span>
        <span class="n">large_pv_to_install</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">percent_shares</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">all_remaining_pv_to_install</span>
        <span class="n">categorical_remaining_pvs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">DeploymentCategory</span><span class="o">.</span><span class="n">LARGE</span><span class="p">:</span> <span class="n">large_pv_to_install</span><span class="p">,</span>
            <span class="n">DeploymentCategory</span><span class="o">.</span><span class="n">SMALL</span><span class="p">:</span> <span class="n">small_pv_to_install</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">categorical_remaining_pvs</span></div>

<div class="viewcode-block" id="MixedPVScenarioGenerator.get_maximum_pv_size"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.MixedPVScenarioGenerator.get_maximum_pv_size">[docs]</a>    <span class="k">def</span> <span class="nf">get_maximum_pv_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bus</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_cycle</span> <span class="o">==</span> <span class="n">DeploymentCategory</span><span class="o">.</span><span class="n">LARGE</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">LargePVScenarioGenerator</span><span class="o">.</span><span class="n">get_maximum_pv_size</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_cycle</span> <span class="o">==</span> <span class="n">DeploymentCategory</span><span class="o">.</span><span class="n">SMALL</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SmallPVScenarioGenerator</span><span class="o">.</span><span class="n">get_maximum_pv_size</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div></div>


<div class="viewcode-block" id="get_pv_scenario_generator"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.get_pv_scenario_generator">[docs]</a><span class="k">def</span> <span class="nf">get_pv_scenario_generator</span><span class="p">(</span><span class="n">feeder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a PV scenario generator instnace&quot;&quot;&quot;</span>
    <span class="n">pv_scenario_generator_mapping</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">DeploymentCategory</span><span class="o">.</span><span class="n">SMALL</span><span class="p">:</span> <span class="n">SmallPVScenarioGenerator</span><span class="p">,</span>
        <span class="n">DeploymentCategory</span><span class="o">.</span><span class="n">LARGE</span><span class="p">:</span> <span class="n">LargePVScenarioGenerator</span><span class="p">,</span>
        <span class="n">DeploymentCategory</span><span class="o">.</span><span class="n">MIXED</span><span class="p">:</span> <span class="n">MixedPVScenarioGenerator</span>
    <span class="p">}</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">DeploymentCategory</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">category</span><span class="p">)</span>
    <span class="n">generator_class</span> <span class="o">=</span> <span class="n">pv_scenario_generator_mapping</span><span class="p">[</span><span class="n">category</span><span class="p">]</span>
    <span class="n">generator</span> <span class="o">=</span> <span class="n">generator_class</span><span class="p">(</span><span class="n">feeder_path</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">generator</span></div>


<div class="viewcode-block" id="PVDataStorage"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDataStorage">[docs]</a><span class="k">class</span> <span class="nc">PVDataStorage</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A class for handling PV data storage on file system&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">hierarchy</span><span class="p">:</span> <span class="n">DeploymentHierarchy</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">)</span> <span class="o">-&gt;</span><span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_path</span> <span class="o">=</span> <span class="n">input_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">hierarchy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>

<div class="viewcode-block" id="PVDataStorage.get_region_paths"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDataStorage.get_region_paths">[docs]</a>    <span class="k">def</span> <span class="nf">get_region_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">city_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Given a city path, return all region paths of the city&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hierarchy</span> <span class="o">!=</span> <span class="n">DeploymentHierarchy</span><span class="o">.</span><span class="n">CITY</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The hierarchy value should be &#39;city&#39; for &#39;--hierarchy&#39; option&quot;</span><span class="p">)</span>

        <span class="c1"># NOTE: Assume all region directories are named with pattern &#39;PXX&#39;</span>
        <span class="n">subdir_names</span> <span class="o">=</span> <span class="n">get_subdir_names</span><span class="p">(</span><span class="n">city_path</span><span class="p">)</span>
        <span class="n">region_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">subdir_names</span> <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">)]</span>
        
        <span class="n">region_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">city_path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">region_names</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">region_paths</span></div>

<div class="viewcode-block" id="PVDataStorage.get_substation_paths"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDataStorage.get_substation_paths">[docs]</a>    <span class="k">def</span> <span class="nf">get_substation_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Given an input path, return a list of substation paths&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hierarchy</span> <span class="o">==</span> <span class="n">DeploymentHierarchy</span><span class="o">.</span><span class="n">FEEDER</span><span class="p">:</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_substation_paths_from_feeder_input</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_path</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">hierarchy</span> <span class="o">==</span> <span class="n">DeploymentHierarchy</span><span class="o">.</span><span class="n">SUBSTATION</span><span class="p">:</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_substation_paths_from_substation_input</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_path</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">hierarchy</span> <span class="o">==</span> <span class="n">DeploymentHierarchy</span><span class="o">.</span><span class="n">REGION</span><span class="p">:</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_substation_paths_from_region_input</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_path</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">hierarchy</span> <span class="o">==</span> <span class="n">DeploymentHierarchy</span><span class="o">.</span><span class="n">CITY</span><span class="p">:</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_substation_paths_from_city_input</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hierarchy</span>
        <span class="k">return</span> <span class="n">paths</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_substation_paths_from_feeder_input</span><span class="p">(</span><span class="n">feeder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Given a feeder path, return its substation path&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">feeder_path</span><span class="p">)]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_substation_paths_from_substation_input</span><span class="p">(</span><span class="n">substation_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Given a substation input path, return it as a list&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">substation_path</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_substation_paths_from_region_input</span><span class="p">(</span><span class="n">region_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Search region input path, return all substation paths in region&quot;&quot;&quot;</span>
        <span class="n">opendss_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">region_path</span><span class="p">,</span>
            <span class="s2">&quot;solar_none_batteries_none_timeseries&quot;</span><span class="p">,</span>
            <span class="s2">&quot;opendss&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">opendss_path</span><span class="p">):</span>
            <span class="n">opendss_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">region_path</span><span class="p">,</span>
                <span class="s2">&quot;scenarios&quot;</span><span class="p">,</span>
                <span class="s2">&quot;base_timeseries&quot;</span><span class="p">,</span>
                <span class="s2">&quot;opendss&quot;</span>
            <span class="p">)</span>
        <span class="n">substation_names</span> <span class="o">=</span> <span class="n">get_subdir_names</span><span class="p">(</span><span class="n">opendss_path</span><span class="p">)</span>
        
        <span class="c1"># NOTE: exclude directory named &quot;subtransmission&quot; from substations</span>
        <span class="k">if</span> <span class="s2">&quot;subtransmission&quot;</span> <span class="ow">in</span> <span class="n">substation_names</span><span class="p">:</span>
            <span class="n">substation_names</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;subtransmission&quot;</span><span class="p">)</span>
        
        <span class="n">substation_paths</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">opendss_path</span><span class="p">,</span> <span class="n">substation_name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">substation_name</span> <span class="ow">in</span> <span class="n">substation_names</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">substation_paths</span>
    
    <span class="k">def</span> <span class="nf">_get_substation_paths_from_city_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">city_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Search city input path, return all substation paths in all regions of the city&quot;&quot;&quot;</span>
        <span class="n">region_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_region_paths</span><span class="p">(</span><span class="n">city_path</span><span class="p">)</span>
        <span class="n">substation_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">region_path</span> <span class="ow">in</span> <span class="n">region_paths</span><span class="p">:</span>
            <span class="n">substation_paths</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_substation_paths_from_region_input</span><span class="p">(</span><span class="n">region_path</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">substation_paths</span>
    
<div class="viewcode-block" id="PVDataStorage.get_feeder_paths"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDataStorage.get_feeder_paths">[docs]</a>    <span class="k">def</span> <span class="nf">get_feeder_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Given an input path, return a list of feeder paths&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hierarchy</span> <span class="o">==</span> <span class="n">DeploymentHierarchy</span><span class="o">.</span><span class="n">FEEDER</span><span class="p">:</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_feeder_paths_from_feeder_input</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_path</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">hierarchy</span> <span class="o">==</span> <span class="n">DeploymentHierarchy</span><span class="o">.</span><span class="n">SUBSTATION</span><span class="p">:</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_feeder_paths_from_substation_input</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_path</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">hierarchy</span> <span class="o">==</span> <span class="n">DeploymentHierarchy</span><span class="o">.</span><span class="n">REGION</span><span class="p">:</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_feeder_paths_from_region_input</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_path</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">hierarchy</span> <span class="o">==</span> <span class="n">DeploymentHierarchy</span><span class="o">.</span><span class="n">CITY</span><span class="p">:</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_feeder_paths_from_city_input</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hierarchy</span>
        <span class="k">return</span> <span class="n">paths</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_feeder_paths_from_feeder_input</span><span class="p">(</span><span class="n">feeder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Search feeder input path, return it as a list&quot;&quot;&quot;</span>
        <span class="n">feeder_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">feeder_path</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">feeder_paths</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_feeder_paths_from_substation_input</span><span class="p">(</span><span class="n">substation_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Search substation input path, return all feeder paths in substation&quot;&quot;&quot;</span>
        <span class="n">feeder_names</span> <span class="o">=</span> <span class="n">get_subdir_names</span><span class="p">(</span><span class="n">substation_path</span><span class="p">)</span>
        
        <span class="c1"># NOTE: found a directory named &quot;subtransmission&quot;, it&#39;s not a feeder</span>
        <span class="k">if</span> <span class="s2">&quot;subtransmission&quot;</span> <span class="ow">in</span> <span class="n">feeder_names</span><span class="p">:</span>
            <span class="n">feeder_names</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;subtransmission&quot;</span><span class="p">)</span>
        
        <span class="n">feeder_paths</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">substation_path</span><span class="p">,</span> <span class="n">feeder_name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">feeder_name</span> <span class="ow">in</span> <span class="n">feeder_names</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">feeder_paths</span>

    <span class="k">def</span> <span class="nf">_get_feeder_paths_from_region_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Search region input path, return all feeder paths in region&quot;&quot;&quot;</span>
        <span class="n">feeder_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">substation_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_substation_paths_from_region_input</span><span class="p">(</span><span class="n">region_path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">substation_path</span> <span class="ow">in</span> <span class="n">substation_paths</span><span class="p">:</span>
            <span class="n">feeder_names</span> <span class="o">=</span> <span class="n">get_subdir_names</span><span class="p">(</span><span class="n">substation_path</span><span class="p">)</span>
            <span class="n">feeder_paths</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">substation_path</span><span class="p">,</span> <span class="n">feeder_name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">feeder_name</span> <span class="ow">in</span> <span class="n">feeder_names</span>
            <span class="p">])</span>
        <span class="k">return</span> <span class="n">feeder_paths</span>

    <span class="k">def</span> <span class="nf">_get_feeder_paths_from_city_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">city_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Search city input path, return aall feeder paths in city&quot;&quot;&quot;</span>
        <span class="n">feeder_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">substation_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_substation_paths_from_city_input</span><span class="p">(</span><span class="n">city_path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">substation_path</span> <span class="ow">in</span> <span class="n">substation_paths</span><span class="p">:</span>
            <span class="n">feeder_names</span> <span class="o">=</span> <span class="n">get_subdir_names</span><span class="p">(</span><span class="n">substation_path</span><span class="p">)</span>
            <span class="n">feeder_paths</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">substation_path</span><span class="p">,</span> <span class="n">feeder_name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">feeder_name</span> <span class="ow">in</span> <span class="n">feeder_names</span>
            <span class="p">])</span>
        <span class="k">return</span> <span class="n">feeder_paths</span>

<div class="viewcode-block" id="PVDataStorage.get_deployment_path"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDataStorage.get_deployment_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_deployment_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feeder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return the deployment path&quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">feeder_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pv_deployments_dirname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">path</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="PVDataStorage.get_placement_paths"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDataStorage.get_placement_paths">[docs]</a>    <span class="k">def</span> <span class="nf">get_placement_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feeder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">placement</span><span class="p">:</span> <span class="n">Placement</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the placement path in deployment&quot;&quot;&quot;</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">placements</span> <span class="o">=</span> <span class="p">[</span><span class="n">placement</span><span class="p">]</span> <span class="k">if</span> <span class="n">placement</span> <span class="k">else</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">Placement</span><span class="p">]</span>
        <span class="n">deployment_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_deployment_path</span><span class="p">(</span><span class="n">feeder_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">deployment_path</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">paths</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">placements</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">deployment_path</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">paths</span></div>

<div class="viewcode-block" id="PVDataStorage.get_sample_paths"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDataStorage.get_sample_paths">[docs]</a>    <span class="k">def</span> <span class="nf">get_sample_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feeder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">placement</span><span class="p">:</span> <span class="n">Placement</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the sample path in deployment&quot;&quot;&quot;</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">placement_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_placement_paths</span><span class="p">(</span><span class="n">feeder_path</span><span class="p">,</span> <span class="n">placement</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">placement_path</span> <span class="ow">in</span> <span class="n">placement_paths</span><span class="p">:</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">placement_path</span><span class="p">)</span>
            <span class="n">sample_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">placement_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">]</span>
            <span class="n">paths</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">sample_paths</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">paths</span></div>

<div class="viewcode-block" id="PVDataStorage.get_pv_config_file"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDataStorage.get_pv_config_file">[docs]</a>    <span class="k">def</span> <span class="nf">get_pv_config_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return PV config file&quot;&quot;&quot;</span>
        <span class="n">config_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sample_path</span><span class="p">,</span> <span class="n">PV_CONFIG_FILENAME</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">config_file</span></div></div>


<div class="viewcode-block" id="PVDataManager"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDataManager">[docs]</a><span class="k">class</span> <span class="nc">PVDataManager</span><span class="p">(</span><span class="n">PVDataStorage</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">hierarchy</span><span class="p">:</span> <span class="n">DeploymentHierarchy</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize pv data manager class</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        hierarchy: DeploymentHierarchy, the predefined hierarchy</span>
<span class="sd">        input_path: str, the input path of raw dss data for generating pv deployments.</span>
<span class="sd">        config: SimpleNamespace, the pv deployment configuration namespace.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">hierarchy</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

<div class="viewcode-block" id="PVDataManager.redirect"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDataManager.redirect">[docs]</a>    <span class="k">def</span> <span class="nf">redirect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Given a path, update the master file by redirecting PVShapes.dss&quot;&quot;&quot;</span>
        <span class="n">pv_shapes_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">PV_SHAPES_FILENAME</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_copy_pv_shapes_file</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
        
        <span class="n">master_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">master_filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">master_file</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; not found in &#39;</span><span class="si">%s</span><span class="s2">&#39;. System exits!&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">master_filename</span><span class="p">,</span> <span class="n">input_path</span><span class="p">)</span>
            <span class="k">raise</span>
        
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">master_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fr</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">fr</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;redirect&quot;</span><span class="p">):</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;redirect </span><span class="si">{</span><span class="n">PV_SHAPES_FILENAME</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Skip </span><span class="si">%s</span><span class="s2"> redirect, it already exists.&quot;</span><span class="p">,</span> <span class="n">PV_SHAPES_FILENAME</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">assert</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;There must be &#39;Redirect&#39; in </span><span class="si">{</span><span class="n">master_file</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Update master file </span><span class="si">%s</span><span class="s2"> to redirect </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">master_file</span><span class="p">,</span> <span class="n">PV_SHAPES_FILENAME</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Redirect </span><span class="si">{</span><span class="n">PV_SHAPES_FILENAME</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">master_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fw</span><span class="p">:</span>
            <span class="n">fw</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

    <span class="k">def</span> <span class="nf">_copy_pv_shapes_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Copy PVShapes.dss file from source to feeder/substatation directories&quot;&quot;&quot;</span>
        <span class="n">input_path</span>  <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
        <span class="c1"># NOTE: Coordinate different path patterns among different cities</span>
        <span class="k">if</span> <span class="s2">&quot;solar_none_batteries_none_timeseries&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">input_path</span><span class="p">):</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">if</span> <span class="n">input_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;opendss&quot;</span> <span class="k">else</span> <span class="mi">4</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">4</span> <span class="k">if</span> <span class="n">input_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;opendss&quot;</span> <span class="k">else</span> <span class="mi">5</span>
        <span class="n">src_file</span> <span class="o">=</span> <span class="n">input_path</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">/</span> <span class="s2">&quot;pv-profiles&quot;</span> <span class="o">/</span> <span class="n">PV_SHAPES_FILENAME</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">src_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;PVShapes.dss file does not exist - &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">src_file</span><span class="p">))</span>
        <span class="n">dst_file</span> <span class="o">=</span> <span class="n">input_path</span> <span class="o">/</span> <span class="n">PV_SHAPES_FILENAME</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">src_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fr</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">dst_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fw</span><span class="p">:</span>
            <span class="n">new_lines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fr</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                <span class="n">pv_profile</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;file=[a-zA-Z0-9\-\_\/\.]*&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">city_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;..&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
                <span class="n">relative_pv_profile</span> <span class="o">=</span> <span class="n">city_path</span> <span class="o">/</span> <span class="s2">&quot;pv-profiles&quot;</span> <span class="o">/</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">pv_profile</span><span class="p">)</span>
                <span class="n">relative_pv_profile</span> <span class="o">=</span> <span class="s2">&quot;file=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">relative_pv_profile</span><span class="p">)</span>
                <span class="n">new_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pv_profile</span><span class="p">,</span> <span class="n">relative_pv_profile</span><span class="p">)</span>
                <span class="n">new_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span>
            <span class="n">fw</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">new_lines</span><span class="p">)</span>

<div class="viewcode-block" id="PVDataManager.redirect_substation_pv_shapes"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDataManager.redirect_substation_pv_shapes">[docs]</a>    <span class="k">def</span> <span class="nf">redirect_substation_pv_shapes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run PVShapes redirect in substation directories in parallel&quot;&quot;&quot;</span>
        <span class="n">substation_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_substation_paths</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running PVShapes redirect in </span><span class="si">%s</span><span class="s2"> substation directories...&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">substation_paths</span><span class="p">))</span>
        <span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">,</span> <span class="n">substation_paths</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Substation PVShapes redirect done!&quot;</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="PVDataManager.redirect_feeder_pv_shapes"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDataManager.redirect_feeder_pv_shapes">[docs]</a>    <span class="k">def</span> <span class="nf">redirect_feeder_pv_shapes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run PVShapes redirect in feeder directories in parallel&quot;&quot;&quot;</span>
        <span class="n">feeder_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_feeder_paths</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running PVShapes redirect in </span><span class="si">%s</span><span class="s2"> feeder directories...&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">feeder_paths</span><span class="p">))</span>
        <span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">,</span> <span class="n">feeder_paths</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Feeder PVShapes redirect done!&quot;</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="PVDataManager.rename"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDataManager.rename">[docs]</a>    <span class="k">def</span> <span class="nf">rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feeder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Rename transformed/original Loads files&quot;&quot;&quot;</span>
        <span class="n">loads_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">feeder_path</span><span class="p">,</span> <span class="n">LOADS_FILENAME</span><span class="p">)</span>
        <span class="n">original_loads_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">feeder_path</span><span class="p">,</span> <span class="n">ORIGINAL_LOADS_FILENAME</span><span class="p">)</span>
        <span class="n">transformed_loads_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">feeder_path</span><span class="p">,</span> <span class="n">TRANSFORMED_LOADS_FILENAME</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">original_loads_file</span><span class="p">):</span>
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">transformed_loads_file</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">transformed_loads_file</span><span class="p">)</span>
        
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">loads_file</span><span class="p">,</span> <span class="n">transformed_loads_file</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">transformed_loads_file</span><span class="p">,</span> <span class="mo">0o666</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span>
        
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">original_loads_file</span><span class="p">,</span> <span class="n">loads_file</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">loads_file</span><span class="p">,</span> <span class="mo">0o666</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span></div>
    
<div class="viewcode-block" id="PVDataManager.rename_feeder_loads"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDataManager.rename_feeder_loads">[docs]</a>    <span class="k">def</span> <span class="nf">rename_feeder_loads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feeder_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Rename transformed Loads.dss to PV_Loads.dss&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Renaming loads files in </span><span class="si">%s</span><span class="s2"> feeder directories...&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">feeder_paths</span><span class="p">))</span>
        <span class="n">deployed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">feeder_path</span> <span class="ow">in</span> <span class="n">feeder_paths</span><span class="p">:</span>
            <span class="n">original_loads_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">feeder_path</span><span class="p">,</span> <span class="n">ORIGINAL_LOADS_FILENAME</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">original_loads_file</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">deployed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feeder_path</span><span class="p">)</span>
        
        <span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rename</span><span class="p">,</span> <span class="n">deployed</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Feeder Loads rename done, total </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">deployed</span><span class="p">))</span></div>
    
<div class="viewcode-block" id="PVDataManager.revert"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDataManager.revert">[docs]</a>    <span class="k">def</span> <span class="nf">revert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feeder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Enable LoadShapes redirect by removing the starting symbol !.&quot;&quot;&quot;</span>
        <span class="n">master_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">feeder_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">master_filename</span><span class="p">)</span>
        <span class="n">redirected</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">master_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fr</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fr</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;redirect loadshapes.dss&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">)</span>
                    <span class="n">redirected</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">redirected</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">master_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fw</span><span class="p">:</span>
            <span class="n">fw</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Master file get reverted with LoadShape.dss redirected - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">master_file</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="PVDataManager.revert_master_files"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDataManager.revert_master_files">[docs]</a>    <span class="k">def</span> <span class="nf">revert_master_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feeder_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Revert master files with LoadShapes.dss redirect enabled&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">revert</span><span class="p">,</span> <span class="n">feeder_paths</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Feeder Redirect LoadShapes.dss enabled in master files, total </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">feeder_paths</span><span class="p">))</span></div>
    
<div class="viewcode-block" id="PVDataManager.restore_feeder_data"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDataManager.restore_feeder_data">[docs]</a>    <span class="k">def</span> <span class="nf">restore_feeder_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;After PV deployments, we need to restore feeder data tranformed during PV deployments</span>
<span class="sd">            1) rename transformed Loads.dss to PV_Loads.dss;</span>
<span class="sd">            2) uncomment on LoadShapes.dss redirect in master file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">feeder_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_feeder_paths</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rename_feeder_loads</span><span class="p">(</span><span class="n">feeder_paths</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">revert_master_files</span><span class="p">(</span><span class="n">feeder_paths</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="PVDataManager.transform"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDataManager.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feeder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Transform feeder Loads.dss</span>
<span class="sd">        </span>
<span class="sd">        change load model to suitable center-tap schema if needed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">original_loads_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">feeder_path</span><span class="p">,</span> <span class="n">ORIGINAL_LOADS_FILENAME</span><span class="p">)</span>
        <span class="n">loads_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">feeder_path</span><span class="p">,</span> <span class="n">LOADS_FILENAME</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">original_loads_file</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restore_loads_file</span><span class="p">(</span><span class="n">original_loads_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backup_loads_file</span><span class="p">(</span><span class="n">loads_file</span><span class="p">)</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">original_loads_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fr</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">loads_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fw</span><span class="p">:</span>
            <span class="n">load_lines</span> <span class="o">=</span> <span class="n">fr</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">rekeyed_load_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_load_dictionary</span><span class="p">(</span><span class="n">load_lines</span><span class="p">)</span>
            <span class="n">updated_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_loads</span><span class="p">(</span><span class="n">load_lines</span><span class="p">,</span> <span class="n">rekeyed_load_dict</span><span class="p">)</span>
            <span class="n">new_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strip_pv_profile</span><span class="p">(</span><span class="n">updated_lines</span><span class="p">)</span>
            <span class="n">fw</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">new_lines</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loads transformed - &#39;</span><span class="si">%s</span><span class="s2">&#39;.&quot;</span><span class="p">,</span> <span class="n">loads_file</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="PVDataManager.restore_loads_file"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDataManager.restore_loads_file">[docs]</a>    <span class="k">def</span> <span class="nf">restore_loads_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original_loads_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Restore Loads file from backup&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">original_loads_file</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="n">loads_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">original_loads_file</span><span class="p">),</span> <span class="n">LOADS_FILENAME</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">loads_file</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">loads_file</span><span class="p">)</span>
        
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">original_loads_file</span><span class="p">,</span> <span class="n">loads_file</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">loads_file</span><span class="p">,</span> <span class="mo">0o666</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="kc">True</span></div>
    
<div class="viewcode-block" id="PVDataManager.backup_loads_file"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDataManager.backup_loads_file">[docs]</a>    <span class="k">def</span> <span class="nf">backup_loads_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loads_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a backup of Loads.dss file&quot;&quot;&quot;</span>
        <span class="n">feeder_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">loads_file</span><span class="p">)</span>
        <span class="n">original_loads_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">feeder_path</span><span class="p">,</span> <span class="n">ORIGINAL_LOADS_FILENAME</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">original_loads_file</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">loads_file</span><span class="p">,</span> <span class="n">original_loads_file</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">original_loads_file</span><span class="p">,</span> <span class="mo">0o666</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="kc">True</span></div>
    
<div class="viewcode-block" id="PVDataManager.strip_pv_profile"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDataManager.strip_pv_profile">[docs]</a>    <span class="k">def</span> <span class="nf">strip_pv_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">load_lines</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;To strip &#39;yearly=&lt;pv-profile&gt;&#39; from load lines during PV deployments&quot;&quot;&quot;</span>
        <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\syearly=\S+&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="n">new_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">load_lines</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
                <span class="n">new_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
                <span class="n">new_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_lines</span></div>
    
<div class="viewcode-block" id="PVDataManager.get_attribute"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDataManager.get_attribute">[docs]</a>    <span class="k">def</span> <span class="nf">get_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">attribute_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the attribute from line string.</span>

<span class="sd">        Attribute ID</span>
<span class="sd">        for kv: &#39;kv=&#39;</span>
<span class="sd">        for name: &#39;new load.&#39; (load example)</span>
<span class="sd">        for bus: &#39;bus1=&#39;</span>
<span class="sd">        for kw: &#39;kw=&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attribute</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">lowered_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">attribute_id</span> <span class="ow">in</span> <span class="n">lowered_line</span><span class="p">:</span>
            <span class="n">attribute</span> <span class="o">=</span> <span class="n">lowered_line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">attribute_id</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;kv&quot;</span> <span class="ow">in</span> <span class="n">attribute_id</span> <span class="ow">or</span> <span class="s2">&quot;kw&quot;</span> <span class="ow">in</span> <span class="n">attribute_id</span><span class="p">:</span>
                <span class="n">attribute</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">attribute</span></div>

<div class="viewcode-block" id="PVDataManager.build_load_dictionary"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDataManager.build_load_dictionary">[docs]</a>    <span class="k">def</span> <span class="nf">build_load_dictionary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">load_lines</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Util function for building dict from load lines.&quot;&quot;&quot;</span>
        <span class="n">load_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">load_lines</span><span class="p">):</span>
            <span class="n">lowered_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;new&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lowered_line</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="n">bus_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s2">&quot;bus1=&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bus_node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="n">kv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s2">&quot;kv=&quot;</span><span class="p">)</span>
            <span class="n">kw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s2">&quot;kw=&quot;</span><span class="p">)</span>
            <span class="n">kvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s2">&quot;kvar=&quot;</span><span class="p">)</span>
            <span class="n">kva</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s2">&quot;kva=&quot;</span><span class="p">)</span>
            <span class="n">phases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s2">&quot;phases=&quot;</span><span class="p">)</span>
            <span class="n">init_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s2">&quot;new load.&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">bus_node</span><span class="p">:</span>
                <span class="n">bus</span> <span class="o">=</span> <span class="n">bus_node</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">nodes</span> <span class="o">=</span> <span class="n">bus_node</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bus</span> <span class="o">=</span> <span class="n">bus_node</span>
                <span class="n">nodes</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">init_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">init_name</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="ow">in</span> <span class="n">load_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">nodes</span><span class="p">:</span>
                    <span class="n">load_dict</span><span class="p">[</span><span class="n">bus</span><span class="p">,</span> <span class="n">name</span><span class="p">][</span><span class="s2">&quot;node&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">nodes</span>
                <span class="k">if</span> <span class="s2">&quot;kw=&quot;</span> <span class="ow">in</span> <span class="n">lowered_line</span><span class="p">:</span>
                    <span class="n">load_dict</span><span class="p">[</span><span class="n">bus</span><span class="p">,</span> <span class="n">name</span><span class="p">][</span><span class="s2">&quot;kw&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">kw</span>
                <span class="k">if</span> <span class="s2">&quot;kvar=&quot;</span> <span class="ow">in</span> <span class="n">lowered_line</span><span class="p">:</span>
                    <span class="n">load_dict</span><span class="p">[</span><span class="n">bus</span><span class="p">,</span> <span class="n">name</span><span class="p">][</span><span class="s2">&quot;kvar&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">kvar</span>
                <span class="k">if</span> <span class="s2">&quot;kva=&quot;</span> <span class="ow">in</span> <span class="n">lowered_line</span><span class="p">:</span>
                    <span class="n">load_dict</span><span class="p">[</span><span class="n">bus</span><span class="p">,</span> <span class="n">name</span><span class="p">][</span><span class="s2">&quot;kva&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">kva</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">load_dict</span><span class="p">[</span><span class="n">bus</span><span class="p">,</span> <span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">load_dict</span><span class="p">[</span><span class="n">bus</span><span class="p">,</span> <span class="n">name</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
                <span class="n">load_dict</span><span class="p">[</span><span class="n">bus</span><span class="p">,</span> <span class="n">name</span><span class="p">][</span><span class="s2">&quot;bus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bus</span>
                <span class="n">load_dict</span><span class="p">[</span><span class="n">bus</span><span class="p">,</span> <span class="n">name</span><span class="p">][</span><span class="s2">&quot;node&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodes</span>
                <span class="k">if</span> <span class="s2">&quot;kw=&quot;</span> <span class="ow">in</span> <span class="n">lowered_line</span><span class="p">:</span>
                    <span class="n">load_dict</span><span class="p">[</span><span class="n">bus</span><span class="p">,</span> <span class="n">name</span><span class="p">][</span><span class="s2">&quot;kw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kw</span>
                <span class="k">if</span> <span class="s2">&quot;kvar=&quot;</span> <span class="ow">in</span> <span class="n">lowered_line</span><span class="p">:</span>
                    <span class="n">load_dict</span><span class="p">[</span><span class="n">bus</span><span class="p">,</span> <span class="n">name</span><span class="p">][</span><span class="s2">&quot;kvar&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kvar</span>
                <span class="k">if</span> <span class="s2">&quot;kva=&quot;</span> <span class="ow">in</span> <span class="n">lowered_line</span><span class="p">:</span>
                    <span class="n">load_dict</span><span class="p">[</span><span class="n">bus</span><span class="p">,</span> <span class="n">name</span><span class="p">][</span><span class="s2">&quot;kva&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kva</span>
                <span class="k">if</span> <span class="s2">&quot;phases=&quot;</span> <span class="ow">in</span> <span class="n">lowered_line</span><span class="p">:</span>
                    <span class="n">load_dict</span><span class="p">[</span><span class="n">bus</span><span class="p">,</span> <span class="n">name</span><span class="p">][</span><span class="s2">&quot;phases&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phases</span>
                <span class="n">load_dict</span><span class="p">[</span><span class="n">bus</span><span class="p">,</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;line_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span> 
                <span class="n">load_dict</span><span class="p">[</span><span class="n">bus</span><span class="p">,</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;kv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kv</span>
        
        <span class="n">rekeyed_load_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;line_idx&quot;</span><span class="p">]:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">load_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">rekeyed_load_dict</span></div>

<div class="viewcode-block" id="PVDataManager.update_loads"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDataManager.update_loads">[docs]</a>    <span class="k">def</span> <span class="nf">update_loads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">rekeyed_load_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Update load lines based on given load dict&quot;&quot;&quot;</span>
        <span class="n">new_load_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rekeyed_load_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;node&quot;</span><span class="p">]:</span>
                <span class="n">bus_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;bus&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;node&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bus_name</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;bus&quot;</span><span class="p">]</span>
            
            <span class="n">lines</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="s2">&quot;bus1=&quot;</span><span class="p">),</span> <span class="n">bus_name</span><span class="p">)</span>
            <span class="n">lines</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="s2">&quot;load.&quot;</span><span class="p">),</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;kv&quot;</span><span class="p">],</span> <span class="mf">0.12</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;node&quot;</span><span class="p">])</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">kv</span> <span class="o">=</span> <span class="mf">0.208</span>
                <span class="n">phases</span> <span class="o">=</span> <span class="s2">&quot;2&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kv</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;kv&quot;</span><span class="p">]</span>
                <span class="n">phases</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;phases&quot;</span><span class="p">]</span>
            
            <span class="n">lowered_line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">lowered_line</span> <span class="o">=</span> <span class="n">lowered_line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;kv=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="s1">&#39;kv=&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;kv=</span><span class="si">{</span><span class="n">kv</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lowered_line</span> <span class="o">=</span> <span class="n">lowered_line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;phases=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="s1">&#39;phases=&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;phases=</span><span class="si">{</span><span class="n">phases</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;kw=&quot;</span> <span class="ow">in</span> <span class="n">lowered_line</span><span class="p">:</span>
                <span class="n">lowered_line</span> <span class="o">=</span> <span class="n">lowered_line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;kw=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="s1">&#39;kw=&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;kw=</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;kw&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;kvar=&quot;</span> <span class="ow">in</span> <span class="n">lowered_line</span><span class="p">:</span>
                <span class="n">lowered_line</span> <span class="o">=</span> <span class="n">lowered_line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;kvar=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="s1">&#39;kvar=&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;kvar=</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;kvar&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;kva=&quot;</span> <span class="ow">in</span> <span class="n">lowered_line</span><span class="p">:</span>
                <span class="n">lowered_line</span> <span class="o">=</span> <span class="n">lowered_line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;kva=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="s1">&#39;kva=&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;kva=</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;kva&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">lowered_line</span>
        
        <span class="n">new_load_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">lines</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rekeyed_load_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="k">return</span> <span class="n">new_load_lines</span></div>

<div class="viewcode-block" id="PVDataManager.transform_feeder_loads"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDataManager.transform_feeder_loads">[docs]</a>    <span class="k">def</span> <span class="nf">transform_feeder_loads</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Before PV deployments, transform Loads.dss&quot;&quot;&quot;</span>
        <span class="n">feeder_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_feeder_paths</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Transforming loads files in </span><span class="si">%s</span><span class="s2"> feeders...&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">feeder_paths</span><span class="p">))</span>
        <span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span> <span class="n">feeder_paths</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Feeder Loads transformed, total </span><span class="si">%s</span><span class="s2"> feeders.&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">feeder_paths</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="PVDeploymentManager"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDeploymentManager">[docs]</a><span class="k">class</span> <span class="nc">PVDeploymentManager</span><span class="p">(</span><span class="n">PVDataStorage</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">hierarchy</span><span class="p">:</span> <span class="n">DeploymentHierarchy</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize pv deployment manager class</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        hierarchy: DeploymentHierarchy, the predefined hierarchy</span>
<span class="sd">        input_path: str, the input path of raw dss data for generating pv deployments.</span>
<span class="sd">        config: SimpleNamespace, the pv deployment configuration namespace.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">hierarchy</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

<div class="viewcode-block" id="PVDeploymentManager.generate_pv_deployments"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDeploymentManager.generate_pv_deployments">[docs]</a>    <span class="k">def</span> <span class="nf">generate_pv_deployments</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Given input path, generate pv deployments&quot;&quot;&quot;</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">feeder_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_feeder_paths</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">feeder_path</span> <span class="ow">in</span> <span class="n">feeder_paths</span><span class="p">:</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="n">get_pv_scenario_generator</span><span class="p">(</span><span class="n">feeder_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Set initial integer seed </span><span class="si">%s</span><span class="s2"> for PV deployments on feeder - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">random_seed</span><span class="p">,</span> <span class="n">feeder_path</span>
            <span class="p">)</span>
            <span class="n">feeder_stats</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">deploy_all_pv_scenarios</span><span class="p">()</span>
            <span class="n">summary</span><span class="p">[</span><span class="n">feeder_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">feeder_stats</span>
        <span class="k">return</span> <span class="n">summary</span></div>

<div class="viewcode-block" id="PVDeploymentManager.remove_pv_deployments"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDeploymentManager.remove_pv_deployments">[docs]</a>    <span class="k">def</span> <span class="nf">remove_pv_deployments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">placement</span><span class="p">:</span> <span class="n">Placement</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Given input path, remove all pv deployments of all placements&quot;&quot;&quot;</span>
        <span class="n">removed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">feeder_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_feeder_paths</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">feeder_path</span> <span class="ow">in</span> <span class="n">feeder_paths</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">placement</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">deployment_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_deployment_path</span><span class="p">(</span><span class="n">feeder_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">deployment_path</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">deployment_path</span><span class="p">)</span>
                <span class="n">removed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deployment_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">placement_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_placement_paths</span><span class="p">(</span><span class="n">feeder_path</span><span class="p">,</span> <span class="n">placement</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">placement_path</span> <span class="ow">in</span> <span class="n">placement_paths</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">placement_path</span><span class="p">)</span>
                    <span class="n">removed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">placement_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">removed</span></div>

<div class="viewcode-block" id="PVDeploymentManager.check_pv_deployments"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDeploymentManager.check_pv_deployments">[docs]</a>    <span class="k">def</span> <span class="nf">check_pv_deployments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">placement</span><span class="p">:</span> <span class="n">Placement</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SimpleNamespace</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Given input path, check if all pv deployments status&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">(</span><span class="n">placements</span><span class="o">=</span><span class="p">{},</span> <span class="n">samples</span><span class="o">=</span><span class="p">{},</span> <span class="n">penetrations</span><span class="o">=</span><span class="p">{})</span>
        <span class="n">feeder_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_feeder_paths</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">feeder_path</span> <span class="ow">in</span> <span class="n">feeder_paths</span><span class="p">:</span>
            <span class="n">missing_placements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_missing_placements</span><span class="p">(</span><span class="n">feeder_path</span><span class="p">,</span> <span class="n">placement</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">missing_placements</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">placements</span><span class="p">[</span><span class="n">feeder_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">missing_placements</span>
            <span class="n">missing_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_missing_samples</span><span class="p">(</span><span class="n">feeder_path</span><span class="p">,</span> <span class="n">placement</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">missing_samples</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">samples</span><span class="p">[</span><span class="n">feeder_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">missing_samples</span>
            <span class="n">missing_penetrations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_missing_penetrations</span><span class="p">(</span><span class="n">feeder_path</span><span class="p">,</span> <span class="n">placement</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">missing_penetrations</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">penetrations</span><span class="p">[</span><span class="n">feeder_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">missing_penetrations</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="PVDeploymentManager.get_missing_placements"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDeploymentManager.get_missing_placements">[docs]</a>    <span class="k">def</span> <span class="nf">get_missing_placements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feeder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">placement</span><span class="p">:</span> <span class="n">Placement</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return missing placement information in PV deployments on feeder.&quot;&quot;&quot;</span>
        <span class="n">desired_placements</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">Placement</span><span class="p">}</span>
        <span class="n">deployment_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_deployment_path</span><span class="p">(</span><span class="n">feeder_path</span><span class="p">)</span>
        <span class="n">existing_placements</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">deployment_path</span><span class="p">))</span>
        <span class="n">missing_placements</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">desired_placements</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">existing_placements</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">placement</span><span class="o">.</span><span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">missing_placements</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">placement</span><span class="o">.</span><span class="n">value</span><span class="p">]</span></div>

<div class="viewcode-block" id="PVDeploymentManager.get_missing_samples"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDeploymentManager.get_missing_samples">[docs]</a>    <span class="k">def</span> <span class="nf">get_missing_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feeder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">placement</span><span class="p">:</span> <span class="n">Placement</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return missing sample information in PV deployments on feeder.&quot;&quot;&quot;</span>
        <span class="n">desired_samples</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sample_number</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)}</span>
        <span class="n">placement_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_placement_paths</span><span class="p">(</span><span class="n">feeder_path</span><span class="p">,</span> <span class="n">placement</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">placement_path</span> <span class="ow">in</span> <span class="n">placement_paths</span><span class="p">:</span>
            <span class="n">placement</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">placement_path</span><span class="p">)</span>
            <span class="n">exsiting_samples</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">placement_path</span><span class="p">))</span>
            <span class="n">missing_samples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">desired_samples</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">exsiting_samples</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">missing_samples</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">placement</span><span class="p">]</span> <span class="o">=</span> <span class="n">missing_samples</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="PVDeploymentManager.get_missing_penetrations"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDeploymentManager.get_missing_penetrations">[docs]</a>    <span class="k">def</span> <span class="nf">get_missing_penetrations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feeder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">placement</span><span class="p">:</span> <span class="n">Placement</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return missing penetration information in PV deployments on feeder.&quot;&quot;&quot;</span>
        <span class="n">desired_penetrations</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">min_penetration</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_penetration</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">penetration_step</span>
        <span class="p">)}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sample_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sample_paths</span><span class="p">(</span><span class="n">feeder_path</span><span class="p">,</span> <span class="n">placement</span><span class="o">=</span><span class="n">placement</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sample_path</span> <span class="ow">in</span> <span class="n">sample_paths</span><span class="p">:</span>
            <span class="n">placement</span><span class="p">,</span> <span class="n">sample</span> <span class="o">=</span> <span class="n">sample_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
            <span class="n">existing_penetrations</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">sample_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">placement</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">placement</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">missing_penetrations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">desired_penetrations</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">existing_penetrations</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">missing_penetrations</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">placement</span><span class="p">][</span><span class="n">sample</span><span class="p">]</span> <span class="o">=</span> <span class="n">missing_penetrations</span>
        <span class="n">clean_result</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">placement</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">[</span><span class="n">placement</span><span class="p">]:</span>
                <span class="n">clean_result</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">placement</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">clean_result</span></div>

<div class="viewcode-block" id="PVDeploymentManager.generate_pv_creation_jobs"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVDeploymentManager.generate_pv_creation_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">generate_pv_creation_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate PV creation jobs at feeder hierarchy&quot;&quot;&quot;</span>
        <span class="n">feeder_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_feeder_paths</span><span class="p">()</span>
        <span class="n">placements</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">Placement</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">placement</span><span class="p">:</span>
            <span class="n">placements</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">placement</span><span class="p">]</span>
        
        <span class="n">options</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">options</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;-c </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">category</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="n">options</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;-f </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">master_filename</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="n">options</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;-m </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">min_penetration</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="n">options</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;-M </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_penetration</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="n">options</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;-s </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">penetration_step</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="n">options</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;-n </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sample_number</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="n">options</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;-S </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">proximity_step</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="n">options</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;-o </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pv_deployments_dirname</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="n">options</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;-r </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">random_seed</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pv_size_pdf</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;-x </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pv_size_pdf</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pv_upscale</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">+=</span> <span class="s2">&quot;--no-pv-upscale &quot;</span>
        <span class="n">options</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        
        <span class="n">commands</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">feeder_path</span> <span class="ow">in</span> <span class="n">feeder_paths</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">placement</span> <span class="ow">in</span> <span class="n">placements</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;disco pv-deployments source-tree-1 &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;-a create-pv -h feeder -p </span><span class="si">{</span><span class="n">placement</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">options</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">feeder_path</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
        
        <span class="k">with</span> <span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
            <span class="n">commands_file</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span>
        
        <span class="n">config_file</span> <span class="o">=</span> <span class="s2">&quot;create-pv-jobs.json&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">config_cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;jade config create </span><span class="si">{</span><span class="n">commands_file</span><span class="si">}</span><span class="s2"> -c </span><span class="si">{</span><span class="n">config_file</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">check_run_command</span><span class="p">(</span><span class="n">config_cmd</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">commands_file</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">config_file</span></div></div>


<div class="viewcode-block" id="PVConfigManager"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVConfigManager">[docs]</a><span class="k">class</span> <span class="nc">PVConfigManager</span><span class="p">(</span><span class="n">PVDataStorage</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">hierarchy</span><span class="p">:</span> <span class="n">DeploymentHierarchy</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize pv config manager class</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        hierarchy: DeploymentHierarchy, the predefined hierarchy</span>
<span class="sd">        input_path: str, the input path of raw dss data for generating pv deployments.</span>
<span class="sd">        config: SimpleNamespace, the pv deployment configuration namespace.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">hierarchy</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

<div class="viewcode-block" id="PVConfigManager.generate_pv_configs"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVConfigManager.generate_pv_configs">[docs]</a>    <span class="k">def</span> <span class="nf">generate_pv_configs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate pv config JSON files based on PV deployments&quot;&quot;&quot;</span>
        <span class="n">config_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">feeder_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_feeder_paths</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">feeder_path</span> <span class="ow">in</span> <span class="n">feeder_paths</span><span class="p">:</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="n">get_pv_scenario_generator</span><span class="p">(</span><span class="n">feeder_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">create_all_pv_configs</span><span class="p">()</span>
            <span class="n">config_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            
            <span class="n">generator</span><span class="o">.</span><span class="n">create_pv_systems_sum_group_file</span><span class="p">(</span><span class="n">pv_config_files</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
            <span class="n">generator</span><span class="o">.</span><span class="n">create_loads_sum_group_file</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">config_files</span></div>

<div class="viewcode-block" id="PVConfigManager.remove_pv_configs"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVConfigManager.remove_pv_configs">[docs]</a>    <span class="k">def</span> <span class="nf">remove_pv_configs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">placement</span><span class="p">:</span> <span class="n">Placement</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Remove pv config JSON files from PV deployments&quot;&quot;&quot;</span>
        <span class="n">removed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">feeder_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_feeder_paths</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">feeder_path</span> <span class="ow">in</span> <span class="n">feeder_paths</span><span class="p">:</span>
            <span class="n">sample_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sample_paths</span><span class="p">(</span><span class="n">feeder_path</span><span class="p">,</span> <span class="n">placement</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">sample_path</span> <span class="ow">in</span> <span class="n">sample_paths</span><span class="p">:</span>
                <span class="n">config_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pv_config_file</span><span class="p">(</span><span class="n">sample_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">config_file</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
                    <span class="n">removed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">removed</span></div>

<div class="viewcode-block" id="PVConfigManager.check_pv_configs"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVConfigManager.check_pv_configs">[docs]</a>    <span class="k">def</span> <span class="nf">check_pv_configs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">placement</span><span class="p">:</span> <span class="n">Placement</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check pv config existence in pv deployments&quot;&quot;&quot;</span>
        <span class="n">total_missing</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">feeder_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_feeder_paths</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">feeder_path</span> <span class="ow">in</span> <span class="n">feeder_paths</span><span class="p">:</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">sample_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sample_paths</span><span class="p">(</span><span class="n">feeder_path</span><span class="p">,</span> <span class="n">placement</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">sample_path</span> <span class="ow">in</span> <span class="n">sample_paths</span><span class="p">:</span>
                <span class="n">pv_config_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sample_path</span><span class="p">,</span> <span class="n">PV_CONFIG_FILENAME</span><span class="p">)</span>
                <span class="n">sample</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sample_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pv_config_file</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">placement</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span> <span class="n">missing</span><span class="p">:</span>
                    <span class="n">missing</span><span class="p">[</span><span class="n">placement</span><span class="o">.</span><span class="n">value</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">missing</span><span class="p">[</span><span class="n">placement</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">sample</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                <span class="n">total_missing</span><span class="p">[</span><span class="n">feeder_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">total_missing</span></div>

<div class="viewcode-block" id="PVConfigManager.generate_pv_config_jobs"><a class="viewcode-back" href="../../../../disco/disco.sources.source_tree_1.html#disco.sources.source_tree_1.pv_deployments.PVConfigManager.generate_pv_config_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">generate_pv_config_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate PV configs jobs at feeder hierarchy&quot;&quot;&quot;</span>
        <span class="n">feeder_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_feeder_paths</span><span class="p">()</span>
        
        <span class="n">options</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">options</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;-c </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">category</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="n">options</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;-f </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">master_filename</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="n">options</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;-m </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">min_penetration</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="n">options</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;-M </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_penetration</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="n">options</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;-s </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">penetration_step</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="n">options</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;-n </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sample_number</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="n">options</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;-S </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">proximity_step</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="n">options</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;-o </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pv_deployments_dirname</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="n">options</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;-r </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">random_seed</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pv_size_pdf</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;-x </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pv_size_pdf</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pv_upscale</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">+=</span> <span class="s2">&quot;--no-pv-upscale &quot;</span>
        <span class="n">options</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        
        <span class="n">commands</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">feeder_path</span> <span class="ow">in</span> <span class="n">feeder_paths</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;disco pv-deployments source-tree-1 &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;-a create-configs -h feeder </span><span class="si">{</span><span class="n">options</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">feeder_path</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
        
        <span class="k">with</span> <span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
            <span class="n">commands_file</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span>
        
        <span class="n">config_file</span> <span class="o">=</span> <span class="s2">&quot;create-config-jobs.json&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">config_cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;jade config create </span><span class="si">{</span><span class="n">commands_file</span><span class="si">}</span><span class="s2"> -c </span><span class="si">{</span><span class="n">config_file</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">check_run_command</span><span class="p">(</span><span class="n">config_cmd</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">commands_file</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">config_file</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, NREL.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>